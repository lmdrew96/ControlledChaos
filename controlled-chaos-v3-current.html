<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controlled Chaos v3 🌀</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-main: #f8fafc;
            --bg-card: white;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            
            --energy-high: #ef4444;
            --energy-medium: #f59e0b;
            --energy-low: #10b981;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text);
        }

        body.dyslexia-font {
            font-family: 'OpenDyslexic', sans-serif;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--bg-main);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5em;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .tagline {
            color: var(--text-light);
            font-style: italic;
            font-size: 1.1em;
        }

        .current-date {
            color: var(--text);
            font-size: 1.1em;
            margin-top: 10px;
            font-weight: 600;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        /* Focus Area */
        .focus-area {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.1em;
        }

        .emoji {
            font-size: 1.5em;
            margin: 0 5px;
        }

        /* Crisis Plan */
        .crisis-plan {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            color: white;
        }

        .crisis-plan h2 {
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .crisis-day {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .crisis-day h3 {
            color: white;
            margin-bottom: 10px;
        }

        .crisis-task {
            padding: 8px;
            margin: 5px 0;
            background: rgba(255,255,255,0.2);
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .crisis-task input {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .crisis-task.completed {
            opacity: 0.6;
            text-decoration: line-through;
        }

        /* Priority Section */
        .priority-section {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            color: white;
        }

        .priority-section h2 {
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .priority-tasks {
            display: grid;
            gap: 15px;
        }

        .priority-task {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .priority-number {
            font-size: 2em;
            font-weight: bold;
            background: white;
            color: #f59e0b;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .priority-content {
            flex: 1;
        }

        .priority-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .priority-meta {
            display: flex;
            gap: 10px;
            font-size: 0.9em;
            opacity: 0.9;
            flex-wrap: wrap;
        }

        .energy-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .energy-high {
            background: var(--energy-high);
            color: white;
        }

        .energy-medium {
            background: var(--energy-medium);
            color: white;
        }

        .energy-low {
            background: var(--energy-low);
            color: white;
        }

        .time-estimate {
            background: rgba(255,255,255,0.3);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
        }

        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: var(--primary);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: var(--text-light);
            line-height: 1;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* Card */
        .card {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .card h2 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid;
            padding-bottom: 10px;
        }

        .card.deadlines h2 { border-color: #FFE66D; }
        .card.schedule h2 { border-color: #A8E6CF; }

        /* Task List */
        .task-list {
            display: grid;
            gap: 12px;
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: var(--bg-main);
            border-radius: 10px;
            border: 2px solid var(--border);
            transition: all 0.3s;
        }

        .task-item:hover {
            border-color: var(--primary);
        }

        .task-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .task-content {
            flex: 1;
        }

        .task-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .task-meta {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            font-size: 0.85em;
        }

        .task-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .task-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
            background: var(--border);
            color: var(--text);
            transition: all 0.3s;
        }

        .task-btn:hover {
            background: var(--primary);
            color: white;
        }

        /* Deadlines */
        .deadline-item {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .deadline-item.urgent {
            background: #ffebee;
            border-left: 4px solid #f44336;
        }

        .deadline-item.soon {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
        }

        .deadline-item.coming {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
        }

        .deadline-countdown {
            font-weight: bold;
            font-size: 0.9em;
            padding: 5px 10px;
            border-radius: 5px;
            background: white;
        }

        /* Schedule */
        .schedule-day {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .schedule-day h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .schedule-item {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 5px;
            font-size: 0.95em;
        }

        .schedule-item.class {
            background: #e3f2fd;
            border-left: 3px solid #2196f3;
        }

        .schedule-item.work {
            background: #fce4ec;
            border-left: 3px solid #e91e63;
        }

        .schedule-item.personal {
            background: #f3e5f5;
            border-left: 3px solid #9c27b0;
        }

        .schedule-item.free {
            background: #e8f5e9;
            border-left: 3px solid #4caf50;
        }

        /* Weekly Wins */
        .wins-list {
            display: grid;
            gap: 10px;
        }

        .win-item {
            padding: 12px;
            background: var(--bg-main);
            border-radius: 8px;
            border-left: 4px solid var(--success);
        }

        /* Mood Tracker */
        .mood-selector {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
        }

        .mood-btn {
            font-size: 3em;
            background: none;
            border: none;
            cursor: pointer;
            opacity: 0.3;
            transition: all 0.3s;
        }

        .mood-btn:hover,
        .mood-btn.active {
            opacity: 1;
            transform: scale(1.2);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 15px;
        }

        /* Utility */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-20 {
            margin-top: 20px;
        }

        /* Quick Add Input */
        .quick-add {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .quick-add input {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1em;
        }

        /* Not Today Pile Badge */
        .not-today-badge {
            background: var(--warning);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 2em;
            }

            .header-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .task-actions {
                width: 100%;
            }

            .task-btn {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>🌀 Controlled Chaos v3</h1>
            <p class="tagline">Managing the beautiful mess of college life</p>
            <div class="current-date" id="currentDate"></div>
            
            <div class="header-buttons">
                <button class="btn btn-primary" onclick="showPickForMe()">🎯 Pick For Me</button>
                <button class="btn btn-primary" onclick="showStuck()">🤔 I'm Stuck</button>
                <button class="btn btn-secondary" onclick="undo()">↩️ Undo</button>
                <button class="btn btn-secondary" onclick="showQuickAdd()">⚡ Quick Add</button>
                <button class="btn btn-secondary" onclick="showBrainDump()">🧠 Brain Dump</button>
                <button class="btn btn-secondary" onclick="showSettings()">⚙️ Settings</button>
                <button class="btn btn-secondary" onclick="toggleFont()">🔤 Font</button>
            </div>
        </header>

        <!-- Daily Focus -->
        <div class="focus-area">
            <span class="emoji">🎯</span>
            <span id="focusText">Loading today's focus...</span>
            <span class="emoji">✨</span>
        </div>

        <!-- Crisis Management Plan -->
        <div class="crisis-plan" id="crisisPlan" style="display: none;">
            <h2>🚨 Crisis Management Plan (Oct 8-16)</h2>
            <div id="crisisPlanContent"></div>
        </div>

        <!-- Top 3 Priorities -->
        <div class="priority-section">
            <h2>🎯 Your Top 3 Priorities Right Now</h2>
            <div id="priorityTasks" class="priority-tasks">
                <div class="empty-state">
                    <div class="empty-state-icon">✨</div>
                    <p>No urgent tasks right now! Add some tasks to get started.</p>
                </div>
            </div>
        </div>

        <!-- Mood Tracker -->
        <div class="card">
            <h2>💭 How are you feeling today?</h2>
            <div class="mood-selector">
                <button class="mood-btn" onclick="setMood('😢')" data-mood="😢">😢</button>
                <button class="mood-btn" onclick="setMood('😕')" data-mood="😕">😕</button>
                <button class="mood-btn" onclick="setMood('😐')" data-mood="😐">😐</button>
                <button class="mood-btn" onclick="setMood('🙂')" data-mood="🙂">🙂</button>
                <button class="mood-btn" onclick="setMood('😄')" data-mood="😄">😄</button>
            </div>
            <p id="moodStatus" class="text-center text-light" style="color: var(--text-light);"></p>
        </div>

        <!-- Grid Layout -->
        <div class="grid">
            <!-- Upcoming Deadlines -->
            <div class="card deadlines">
                <h2>⏰ Upcoming Deadlines</h2>
                <div id="deadlinesList"></div>
                <button class="btn btn-primary mt-20" onclick="showAddDeadline()" style="width: 100%;">➕ Add Deadline</button>
            </div>

            <!-- Weekly Schedule -->
            <div class="card schedule">
                <h2>🗓️ Weekly Schedule</h2>
                <div id="scheduleView"></div>
            </div>
        </div>

        <!-- Tasks Section -->
        <div class="card">
            <h2>📋 All Tasks</h2>
            <div class="quick-add">
                <input type="text" id="quickTaskInput" placeholder="Quick add a task... (press Enter)" 
                       onkeypress="if(event.key==='Enter') quickAddTask()">
                <button class="btn btn-primary" onclick="quickAddTask()">Add</button>
            </div>
            <div id="allTasks" class="task-list">
                <div class="empty-state">
                    <div class="empty-state-icon">📝</div>
                    <p>No tasks yet! Use Quick Add or Brain Dump to get started.</p>
                </div>
            </div>
        </div>

        <!-- Not Today Pile -->
        <div class="card">
            <h2>🌙 Not Today Pile</h2>
            <p style="color: var(--text-light); margin-bottom: 15px;">
                Tasks you can't even think about today. They'll come back tomorrow.
            </p>
            <div id="notTodayPile" class="task-list">
                <div class="empty-state">
                    <div class="empty-state-icon">✨</div>
                    <p>Nothing here! This is a good thing.</p>
                </div>
            </div>
        </div>

        <!-- Weekly Wins -->
        <div class="card">
            <h2>🏆 This Week's Wins</h2>
            <div id="weeklyWins" class="wins-list">
                <div class="empty-state">
                    <div class="empty-state-icon">🎉</div>
                    <p>Complete some tasks to see your wins here!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>⚙️ Settings</h2>
                <button class="close-modal" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            <div class="form-group">
                <label for="apiKeyInput">Anthropic API Key (Optional)</label>
                <input type="password" id="apiKeyInput" placeholder="sk-ant-...">
                <p style="color: var(--text-light); font-size: 0.9em; margin-top: 5px;">
                    Your API key is stored locally in your browser and never sent anywhere except Anthropic's API. This enables "Pick For Me", "I'm Stuck", and "Brain Dump" features.
                </p>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="autoAnalyze"> 
                    Automatically analyze new tasks with Claude
                </label>
            </div>
            <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
        </div>
    </div>

    <!-- Brain Dump Modal -->
    <div id="brainDumpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🧠 Brain Dump</h2>
                <button class="close-modal" onclick="closeModal('brainDumpModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Dump everything on your mind (one task per line or just word-vomit it all):</label>
                <textarea id="brainDumpText" placeholder="Write essay for english&#10;Buy groceries&#10;Email professor about extension&#10;Fix bug in code&#10;...or just type whatever is stressing you out!"></textarea>
            </div>
            <button class="btn btn-primary" onclick="processBrainDump()">✨ Organize My Chaos</button>
        </div>
    </div>

    <!-- Stuck Modal -->
    <div id="stuckModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🤔 Let's Break This Down</h2>
                <button class="close-modal" onclick="closeModal('stuckModal')">&times;</button>
            </div>
            <div id="stuckContent">
                <p>What task are you stuck on?</p>
            </div>
        </div>
    </div>

    <!-- Pick For Me Modal -->
    <div id="pickForMeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🎯 I Choose...</h2>
                <button class="close-modal" onclick="closeModal('pickForMeModal')">&times;</button>
            </div>
            <div id="pickForMeContent" style="text-align: center; padding: 20px;">
                <p>Let me think...</p>
            </div>
        </div>
    </div>

    <!-- Add Deadline Modal -->
    <div id="addDeadlineModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Deadline</h2>
                <button class="close-modal" onclick="closeModal('addDeadlineModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Name:</label>
                <input type="text" id="newDeadlineName">
            </div>
            <div class="form-group">
                <label>Course:</label>
                <input type="text" id="newDeadlineCourse">
            </div>
            <div class="form-group">
                <label>Due Date:</label>
                <input type="datetime-local" id="newDeadlineDate">
            </div>
            <button class="btn btn-primary" onclick="addDeadline()">Add Deadline</button>
        </div>
    </div>

    <script>
        // Get current date and day
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        const today = new Date();
        const dayName = days[today.getDay()];
        const dayNum = today.getDate();
        const monthName = months[today.getMonth()];
        const year = today.getFullYear();

        document.getElementById('currentDate').textContent = `${dayName}, ${monthName} ${dayNum}, ${year}`;

        // Daily focus messages
        const focusMessages = {
            'Monday': 'World History & US Politics Day! Plus some coding time 💻',
            'Tuesday': 'BIO DAY after therapy! Get it done tonight 🧪',
            'Wednesday': 'Beatles discussion day! Plus catch-up time 🎵',
            'Thursday': 'Finish Beatles work & World History prep 📖',
            'Friday': 'Flex day! Finish anything due this weekend ⚡',
            'Saturday': 'Work day - rest and recover! 💪',
            'Sunday': 'Submit Sunday deadlines, then D&D time! 🎲'
        };

        document.getElementById('focusText').textContent = focusMessages[dayName];

        // Crisis Management Plan (Oct 8-16)
        const crisisPlan = {
            start: new Date(2025, 9, 8),
            end: new Date(2025, 9, 16),
            plan: [
                {
                    date: new Date(2025, 9, 8),
                    dayName: 'Wednesday',
                    displayDate: 'Oct 8',
                    tasks: [
                        '✅ Lab 4: Cellular Respiration (at work)',
                        '✅ Quiz Chapter 7 (when you get home)'
                    ]
                },
                {
                    date: new Date(2025, 9, 9),
                    dayName: 'Thursday',
                    displayDate: 'Oct 9',
                    tasks: [
                        '10:20am-12pm: SmartBook Chapter 5 + Assignment',
                        '1-4:45pm: SmartBook Chapter 6 (start)'
                    ]
                },
                {
                    date: new Date(2025, 9, 10),
                    dayName: 'Friday',
                    displayDate: 'Oct 10',
                    tasks: [
                        'Before work: Finish Chapter 6 Assignment',
                        'During work slow periods: Start Chapter 7 SmartBook on phone'
                    ]
                },
                {
                    date: new Date(2025, 9, 11),
                    dayName: 'Saturday',
                    displayDate: 'Oct 11',
                    tasks: [
                        'REST DAY - Work 11am-10pm'
                    ]
                },
                {
                    date: new Date(2025, 9, 12),
                    dayName: 'Sunday',
                    displayDate: 'Oct 12',
                    tasks: [
                        'Morning: Finish Chapter 7 SmartBook + Assignment',
                        'Morning: Beatles quiz + discussion comment',
                        'Afternoon: D&D guilt-free! Everything done! 🎲'
                    ]
                },
                {
                    date: new Date(2025, 9, 13),
                    dayName: 'Monday',
                    displayDate: 'Oct 13',
                    tasks: [
                        'Anytime: Lab 5 Photosynthesis',
                        'Review all chapters for exam'
                    ]
                },
                {
                    date: new Date(2025, 9, 14),
                    dayName: 'Tuesday',
                    displayDate: 'Oct 14',
                    tasks: [
                        'Therapy 3pm',
                        'Final exam review',
                        'Make sure everything is submitted'
                    ]
                },
                {
                    date: new Date(2025, 9, 15),
                    dayName: 'Wednesday',
                    displayDate: 'Oct 15',
                    tasks: [
                        'Submit all bio work by 11:58pm',
                        'Study for exam tomorrow'
                    ]
                },
                {
                    date: new Date(2025, 9, 16),
                    dayName: 'Thursday',
                    displayDate: 'Oct 16',
                    tasks: [
                        '10:20am-12pm: Final exam review',
                        '4:45pm: TAKE EXAM 2 in class',
                        'CRISIS OVER! 🎉'
                    ]
                }
            ]
        };

        // Weekly schedule
        const schedule = {
            'Monday': [
                { time: '7:15 AM', text: 'Wake up & take meds', type: 'personal' },
                { time: '8:00-8:40 AM', text: 'Commute to school', type: 'free' },
                { time: '8:40-10:35 AM', text: 'FREE TIME - study at school', type: 'free' },
                { time: '10:35-11:55 AM', text: 'US Politics class', type: 'class' },
                { time: '12-1 PM', text: 'Peer Mentor (optional)', type: 'personal' },
                { time: '1:40-2:20 PM', text: 'Commute home', type: 'free' },
                { time: '3-5 PM', text: 'World History reading', type: 'free' },
                { time: '7-9 PM', text: 'US Politics OR coding', type: 'free' }
            ],
            'Tuesday': [
                { time: '7:15 AM', text: 'Wake up & take meds', type: 'personal' },
                { time: '9-10:20 AM', text: 'World History class', type: 'class' },
                { time: '11-11:55 AM', text: 'Peer Mentor (mandatory)', type: 'personal' },
                { time: '12-1 PM', text: 'Hen & Ink Society', type: 'personal' },
                { time: '1-3 PM', text: 'FREE - start assignments', type: 'free' },
                { time: '3 PM', text: 'Therapy (at school)', type: 'personal' },
                { time: '4:40 PM', text: 'Arrive home', type: 'free' },
                { time: '5-8 PM', text: 'BIO WORK - all due Wed!', type: 'free' }
            ],
            'Wednesday': [
                { time: '7:15 AM', text: 'Wake up & take meds', type: 'personal' },
                { time: '9-10:30 AM', text: 'Beatles discussion post', type: 'free' },
                { time: '10:35-11:55 AM', text: 'US Politics class', type: 'class' },
                { time: '12-1 PM', text: 'Peer Mentor (optional)', type: 'personal' },
                { time: '1-1:55 PM', text: 'Peer Mentor (mandatory)', type: 'personal' },
                { time: '3:15 PM', text: 'Arrive home', type: 'free' },
                { time: '4-6 PM', text: 'Beatles PowerPoint Part 1', type: 'free' },
                { time: '7-9 PM', text: 'Catch-up OR coding', type: 'free' }
            ],
            'Thursday': [
                { time: '7:15 AM', text: 'Wake up & take meds', type: 'personal' },
                { time: '9-10:20 AM', text: 'World History class', type: 'class' },
                { time: '10:20 AM-12 PM', text: 'Beatles PowerPoint Part 2', type: 'free' },
                { time: '12-1 PM', text: 'Hen & Ink Society', type: 'personal' },
                { time: '1-3 PM', text: 'Beatles quiz + catch-up', type: 'free' },
                { time: '4:45-7 PM', text: 'Bio class', type: 'class' },
                { time: '7:40 PM', text: 'Arrive home', type: 'free' },
                { time: '8-10 PM', text: 'Papers OR coding', type: 'free' }
            ],
            'Friday': [
                { time: '7:15 AM', text: 'Wake up & take meds', type: 'personal' },
                { time: '9 AM-12 PM', text: 'Flex time - finish weekend work', type: 'free' },
                { time: '12-2 PM', text: 'D&D prep OR personal projects', type: 'free' },
                { time: '3-10 PM', text: 'WORK (no school work allowed!)', type: 'work' }
            ],
            'Saturday': [
                { time: '9-10:30 AM', text: 'Light reading if needed', type: 'free' },
                { time: '11 AM-10 PM', text: 'WORK (rest day!)', type: 'work' }
            ],
            'Sunday': [
                { time: '9 AM-12 PM', text: 'Submit deadlines & review', type: 'free' },
                { time: 'Afternoon/Evening', text: 'D&D TIME! 🎲', type: 'personal' }
            ]
        };

        // Default deadlines
        const defaultDeadlines = [
            // OCTOBER
            { name: 'Bio Lab 4 & Quiz 7', date: new Date(2025, 9, 8, 23, 58), course: 'Bio' },
            { name: 'Beatles Unit 3 response & quiz', date: new Date(2025, 9, 12, 23, 59), course: 'Beatles' },
            { name: 'Bio SmartBooks 5, 6, 7 + Assignments + Lab 5', date: new Date(2025, 9, 15, 23, 58), course: 'Bio' },
            { name: 'Bio EXAM 2', date: new Date(2025, 9, 16, 16, 45), course: 'Bio' },
            { name: 'Beatles Unit 4 original post', date: new Date(2025, 9, 19, 23, 59), course: 'Beatles' },
            { name: 'US Politics Quiz #2, #3, #4', date: new Date(2025, 9, 19, 23, 59), course: 'US Politics' },
            { name: 'Bio Lab 6: Mitosis and Cell Division', date: new Date(2025, 9, 22, 23, 58), course: 'Bio' },
            { name: 'Beatles Unit 4 response & quiz', date: new Date(2025, 9, 26, 23, 59), course: 'Beatles' },
            { name: 'Media evolution presentations begin', date: new Date(2025, 9, 27, 9, 0), course: 'US Politics' },
            { name: 'World History analytical paper (APS #3)', date: new Date(2025, 9, 28, 23, 59), course: 'World History' },
            { name: 'Bio Online Quiz CH 8-9', date: new Date(2025, 9, 29, 23, 58), course: 'Bio' },
            { name: 'Bio Lab 7: Examining Meiosis', date: new Date(2025, 9, 29, 23, 58), course: 'Bio' },
            { name: 'World History EXAM 2', date: new Date(2025, 9, 30, 10, 0), course: 'World History' },
            
            // NOVEMBER
            { name: 'Beatles Unit 5 original post', date: new Date(2025, 10, 2, 23, 59), course: 'Beatles' },
            { name: 'Bio SmartBooks 8, 9, 10 + Assignments + Lab 8', date: new Date(2025, 10, 5, 23, 58), course: 'Bio' },
            { name: 'Bio EXAM 3', date: new Date(2025, 10, 6, 23, 59), course: 'Bio' },
            { name: 'Beatles Unit 5 response & quiz', date: new Date(2025, 10, 9, 23, 59), course: 'Beatles' },
            { name: 'Bio Lab 9: Transcription, Translation & Mutations', date: new Date(2025, 10, 12, 23, 58), course: 'Bio' },
            { name: 'Beatles Unit 6 original post', date: new Date(2025, 10, 16, 23, 59), course: 'Beatles' },
            { name: 'Bio Online Quiz CH 11&14', date: new Date(2025, 10, 19, 23, 58), course: 'Bio' },
            { name: 'Bio Labs 10A & 10B (Macroevolution & Microevolution)', date: new Date(2025, 10, 19, 23, 58), course: 'Bio' },
            { name: 'Beatles Unit 6 response & quiz', date: new Date(2025, 10, 21, 23, 59), course: 'Beatles' },
            
            // DECEMBER
            { name: 'World History analytical paper (APS #4)', date: new Date(2025, 11, 2, 23, 59), course: 'World History' },
            { name: 'Bio Chapter 11, 14, 15 Assignments + Lab 11', date: new Date(2025, 11, 3, 23, 58), course: 'Bio' },
            { name: 'Bio SmartBooks 11, 14, 15', date: new Date(2025, 11, 4, 23, 58), course: 'Bio' },
            { name: 'Bio EXAM 4', date: new Date(2025, 11, 4, 23, 59), course: 'Bio' },
            { name: 'World History Final Exam', date: new Date(2025, 11, 11, 23, 59), course: 'World History' },
            { name: 'Media evolution paper final deadline', date: new Date(2025, 11, 15, 23, 59), course: 'US Politics' }
        ];

        // Data structure
        let appData = {
            apiKey: '',
            autoAnalyze: false,
            tasks: [],
            notTodayTasks: [],
            completedTasks: [],
            deadlines: [],
            mood: null,
            moodDate: null,
            history: []
        };

        // Load data on startup
        function loadData() {
            const saved = localStorage.getItem('controlledChaosV3');
            if (saved) {
                const parsed = JSON.parse(saved);
                appData = { ...appData, ...parsed };
                
                // Convert date strings back to Date objects
                appData.deadlines = appData.deadlines.map(d => ({
                    ...d,
                    date: new Date(d.date)
                }));
            } else {
                // First time - load default deadlines
                appData.deadlines = defaultDeadlines;
            }
            
            // Check if we need to restore "not today" tasks
            const today = new Date().toDateString();
            const lastCheck = localStorage.getItem('lastNotTodayCheck');
            if (lastCheck !== today) {
                // New day! Restore "not today" tasks
                appData.tasks = [...appData.tasks, ...appData.notTodayTasks];
                appData.notTodayTasks = [];
                localStorage.setItem('lastNotTodayCheck', today);
            }
            
            renderCrisisPlan();
            renderSchedule();
            render();
        }

        // Save data
        function saveData() {
            // Save to history for undo
            appData.history.push(JSON.stringify(appData));
            if (appData.history.length > 10) {
                appData.history.shift();
            }
            
            localStorage.setItem('controlledChaosV3', JSON.stringify(appData));
        }

        // Render crisis plan
        function renderCrisisPlan() {
            const now = new Date();
            const crisisSection = document.getElementById('crisisPlan');
            const crisisContent = document.getElementById('crisisPlanContent');
            
            // Check if we're in crisis period
            if (now < crisisPlan.start || now > crisisPlan.end) {
                crisisSection.style.display = 'none';
                return;
            }

            crisisSection.style.display = 'block';
            
            // Find today's plan
            const todayDateStr = `${today.getFullYear()}-${today.getMonth()}-${today.getDate()}`;
            const currentDayPlan = crisisPlan.plan.find(day => {
                const planDate = day.date;
                const planDateStr = `${planDate.getFullYear()}-${planDate.getMonth()}-${planDate.getDate()}`;
                return planDateStr === todayDateStr;
            });

            // Find tomorrow's plan
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowDateStr = `${tomorrow.getFullYear()}-${tomorrow.getMonth()}-${tomorrow.getDate()}`;
            const nextDayPlan = crisisPlan.plan.find(day => {
                const planDate = day.date;
                const planDateStr = `${planDate.getFullYear()}-${planDate.getMonth()}-${planDate.getDate()}`;
                return planDateStr === tomorrowDateStr;
            });

            if (!currentDayPlan) {
                crisisContent.innerHTML = '<p>No tasks scheduled for today in the crisis plan.</p>';
                return;
            }

            // Load completed crisis tasks
            const completed = JSON.parse(localStorage.getItem('crisisTasks') || '{}');
            const todayKey = `${currentDayPlan.dayName}-${currentDayPlan.displayDate}`;
            const todayCompleted = completed[todayKey] || [];

            let html = `<div class="crisis-day">
                    <h3>📅 Today (${currentDayPlan.displayDate})</h3>`;
            
            currentDayPlan.tasks.forEach((task, index) => {
                const isCompleted = todayCompleted.includes(index);
                html += `
                    <div class="crisis-task ${isCompleted ? 'completed' : ''}">
                        <input type="checkbox" 
                               id="crisis-${index}" 
                               ${isCompleted ? 'checked' : ''}
                               onchange="toggleCrisisTask('${todayKey}', ${index})">
                        <label for="crisis-${index}" style="flex: 1; cursor: pointer;">${task}</label>
                    </div>
                `;
            });
            
            html += '</div>';

            if (nextDayPlan) {
                html += `<div class="crisis-day">
                    <h3>👉 Tomorrow (${nextDayPlan.displayDate})</h3>`;
                nextDayPlan.tasks.forEach(task => {
                    html += `<div class="crisis-task">${task}</div>`;
                });
                html += '</div>';
            }

            html += `<div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 8px; text-align: center;">
                <strong>Crisis ends:</strong> Thursday Oct 16 after Bio exam! You got this! 💪
            </div>`;

            crisisContent.innerHTML = html;
        }

        function toggleCrisisTask(dayKey, index) {
            const completed = JSON.parse(localStorage.getItem('crisisTasks') || '{}');
            
            if (!completed[dayKey]) {
                completed[dayKey] = [];
            }

            if (completed[dayKey].includes(index)) {
                completed[dayKey] = completed[dayKey].filter(i => i !== index);
            } else {
                completed[dayKey].push(index);
            }

            localStorage.setItem('crisisTasks', JSON.stringify(completed));
            renderCrisisPlan();
        }

        // Render weekly schedule
        function renderSchedule() {
            const scheduleView = document.getElementById('scheduleView');
            const currentDayIndex = today.getDay();
            
            // Get 7 days starting from today
            const daysToShow = [];
            for (let i = 0; i < 7; i++) {
                const dayIndex = (currentDayIndex + i) % 7;
                daysToShow.push(days[dayIndex]);
            }

            scheduleView.innerHTML = daysToShow.map((day, index) => {
                const daySchedule = schedule[day] || [];
                const isToday = index === 0;
                return `
                    <div class="schedule-day">
                        <h3>${day}${isToday ? ' (Today!)' : ''}</h3>
                        ${daySchedule.map(item => 
                            `<div class="schedule-item ${item.type}">
                                <strong>${item.time}:</strong> ${item.text}
                            </div>`
                        ).join('')}
                    </div>
                `;
            }).join('');
        }

        // Render deadlines
        function renderDeadlines() {
            const deadlinesList = document.getElementById('deadlinesList');
            const now = new Date();
            now.setHours(0, 0, 0, 0);

            const upcoming = appData.deadlines
                .filter(d => d.date > new Date())
                .sort((a, b) => a.date - b.date)
                .slice(0, 5);

            if (upcoming.length === 0) {
                deadlinesList.innerHTML = '<div class="empty-state"><p>No upcoming deadlines!</p></div>';
                return;
            }

            deadlinesList.innerHTML = upcoming.map(deadline => {
                const deadlineDay = new Date(deadline.date);
                deadlineDay.setHours(0, 0, 0, 0);
                
                const daysUntil = Math.floor((deadlineDay - now) / (1000 * 60 * 60 * 24));
                let urgencyClass = 'coming';
                let countdownText = `${daysUntil} days`;

                if (daysUntil === 0) {
                    urgencyClass = 'urgent';
                    countdownText = 'TODAY!';
                } else if (daysUntil === 1) {
                    urgencyClass = 'urgent';
                    countdownText = 'Tomorrow';
                } else if (daysUntil <= 3) {
                    urgencyClass = 'soon';
                }

                return `
                    <div class="deadline-item ${urgencyClass}">
                        <div style="flex: 1;">
                            <strong>${deadline.name}</strong><br>
                            <small>${deadline.course}</small>
                        </div>
                        <div class="deadline-countdown">${countdownText}</div>
                    </div>
                `;
            }).join('');
        }

        // Undo
        function undo() {
            if (appData.history.length > 0) {
                const previous = appData.history.pop();
                appData = JSON.parse(previous);
                localStorage.setItem('controlledChaosV3', JSON.stringify(appData));
                render();
                showToast('✅ Undone!');
            } else {
                showToast('Nothing to undo!');
            }
        }

        // Quick add task
        function quickAddTask() {
            const input = document.getElementById('quickTaskInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            const task = {
                id: Date.now(),
                title: text,
                completed: false,
                energy: null,
                timeEstimate: null,
                dueDate: null,
                priority: 'medium',
                createdAt: new Date().toISOString()
            };
            
            appData.tasks.push(task);
            input.value = '';
            
            // Auto-analyze if enabled
            if (appData.autoAnalyze && appData.apiKey) {
                analyzeTask(task);
            }
            
            saveData();
            render();
            showToast('✅ Task added!');
        }

        // Analyze task with Claude
        async function analyzeTask(task) {
            if (!appData.apiKey) {
                return;
            }
            
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': appData.apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 200,
                        messages: [{
                            role: 'user',
                            content: `Analyze this task and respond ONLY with a JSON object (no other text):

Task: "${task.title}"

Respond with:
{
  "energy": "low" | "medium" | "high",
  "timeEstimate": "5min" | "15min" | "30min" | "1hr" | "2hrs" | "3hrs+",
  "reasoning": "brief reason for your assessment"
}

Energy levels:
- low: Simple, easy tasks (checking email, quick replies)
- medium: Moderate focus needed (writing, research)
- high: Deep work required (complex problem solving, creative work)

Base time estimates on typical completion time for a college student.`
                        }]
                    })
                });
                
                if (!response.ok) {
                    throw new Error('API request failed');
                }
                
                const data = await response.json();
                const text = data.content[0].text.trim();
                
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (!jsonMatch) {
                    return;
                }
                
                const analysis = JSON.parse(jsonMatch[0]);
                
                task.energy = analysis.energy;
                task.timeEstimate = analysis.timeEstimate;
                
                saveData();
                render();
                
            } catch (error) {
                console.error('Failed to analyze task:', error);
            }
        }

        // Brain dump processor
        async function processBrainDump() {
            const text = document.getElementById('brainDumpText').value.trim();
            if (!text) return;
            
            if (!appData.apiKey) {
                // No API key - do simple processing
                const lines = text.split('\n').filter(line => line.trim());
                lines.forEach(line => {
                    appData.tasks.push({
                        id: Date.now() + Math.random(),
                        title: line.trim(),
                        completed: false,
                        energy: null,
                        timeEstimate: null,
                        priority: 'medium',
                        createdAt: new Date().toISOString()
                    });
                });
                
                saveData();
                render();
                closeModal('brainDumpModal');
                showToast(`✅ Added ${lines.length} tasks!`);
                document.getElementById('brainDumpText').value = '';
                return;
            }
            
            showToast('🤔 Claude is organizing your chaos...');
            
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': appData.apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [{
                            role: 'user',
                            content: `Parse this brain dump into actionable tasks. Respond ONLY with a JSON array (no other text):

"${text}"

Extract tasks and respond with:
[
  {
    "title": "clear, actionable task title",
    "energy": "low" | "medium" | "high",
    "timeEstimate": "5min" | "15min" | "30min" | "1hr" | "2hrs" | "3hrs+",
    "priority": "low" | "medium" | "high"
  }
]

Rules:
- Break vague items into specific tasks
- If someone mentions multiple things, create separate tasks
- Make each task actionable (starts with a verb)
- Estimate realistically for a college student
- Return at least 1 task, even if the dump is messy`
                        }]
                    })
                });
                
                const data = await response.json();
                const text_response = data.content[0].text.trim();
                
                const jsonMatch = text_response.match(/\[[\s\S]*\]/);
                if (!jsonMatch) {
                    throw new Error('No JSON array found');
                }
                
                const tasks = JSON.parse(jsonMatch[0]);
                
                tasks.forEach(taskData => {
                    appData.tasks.push({
                        id: Date.now() + Math.random(),
                        title: taskData.title,
                        completed: false,
                        energy: taskData.energy,
                        timeEstimate: taskData.timeEstimate,
                        priority: taskData.priority || 'medium',
                        createdAt: new Date().toISOString()
                    });
                });
                
                saveData();
                render();
                closeModal('brainDumpModal');
                showToast(`✨ Created ${tasks.length} organized tasks!`);
                document.getElementById('brainDumpText').value = '';
                
            } catch (error) {
                console.error('Brain dump failed:', error);
                showToast('❌ Failed to process. Try simpler text or check API key.');
            }
        }

        // Pick for me
        function showPickForMe() {
            const availableTasks = appData.tasks.filter(t => !t.completed);
            
            if (availableTasks.length === 0) {
                showToast('🎉 No tasks left! You did it!');
                return;
            }
            
            const sortedTasks = [...availableTasks].sort((a, b) => {
                const priorityScore = { high: 3, medium: 2, low: 1 };
                const aDiff = priorityScore[a.priority] || 2;
                const bDiff = priorityScore[b.priority] || 2;
                
                if (aDiff !== bDiff) return bDiff - aDiff;
                
                if (a.dueDate && b.dueDate) {
                    return new Date(a.dueDate) - new Date(b.dueDate);
                }
                
                return 0;
            });
            
            const chosen = sortedTasks[0];
            
            document.getElementById('pickForMeContent').innerHTML = `
                <div style="font-size: 2em; margin: 20px 0;">🎯</div>
                <h3 style="color: var(--primary); margin-bottom: 15px;">${chosen.title}</h3>
                ${chosen.energy ? `<div class="energy-badge energy-${chosen.energy}">${chosen.energy.toUpperCase()} energy</div>` : ''}
                ${chosen.timeEstimate ? `<div class="time-estimate" style="margin-top: 10px;">⏱️ ${chosen.timeEstimate}</div>` : ''}
                <div style="margin-top: 30px;">
                    <button class="btn btn-primary" onclick="closeModal('pickForMeModal')">Let's do this! 💪</button>
                    <button class="btn btn-secondary" onclick="skipTask(${chosen.id}); closeModal('pickForMeModal')">Skip this one</button>
                </div>
            `;
            
            showModal('pickForMeModal');
        }

        // I'm stuck
        function showStuck() {
            const availableTasks = appData.tasks.filter(t => !t.completed);
            
            if (availableTasks.length === 0) {
                showToast('No tasks to be stuck on!');
                return;
            }
            
            let html = '<p style="margin-bottom: 15px;">Which task are you stuck on?</p><div class="task-list">';
            
            availableTasks.forEach(task => {
                html += `
                    <div class="task-item" style="cursor: pointer;" onclick="breakDownTask(${task.id})">
                        <div class="task-content">
                            <div class="task-title">${task.title}</div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            document.getElementById('stuckContent').innerHTML = html;
            showModal('stuckModal');
        }

        // Break down task
        async function breakDownTask(taskId) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            if (!appData.apiKey) {
                const steps = [
                    'Open the relevant files/materials',
                    'Set a 5-minute timer and just start',
                    'Do the first small piece',
                    'Take a break',
                    'Continue with the next piece'
                ];
                
                let html = `
                    <h3 style="color: var(--primary); margin-bottom: 15px;">${task.title}</h3>
                    <p style="margin-bottom: 15px;">Here's how to get started:</p>
                    <ol style="padding-left: 20px;">
                `;
                
                steps.forEach(step => {
                    html += `<li style="margin-bottom: 10px;">${step}</li>`;
                });
                
                html += `</ol>
                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="closeModal('stuckModal')">Got it! 👍</button>
                    </div>
                `;
                
                document.getElementById('stuckContent').innerHTML = html;
                return;
            }
            
            document.getElementById('stuckContent').innerHTML = '<p>🤔 Let me break this down for you...</p>';
            
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': appData.apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 500,
                        messages: [{
                            role: 'user',
                            content: `I'm stuck on this task: "${task.title}"

Break it down into the SMALLEST possible first step (something I can do in 5 minutes or less to just get started). 

Give me:
1. The tiniest first action (be very specific and concrete)
2. A friendly encouragement
3. What to do after that first step

Be direct and brief. Help me overcome the "starting" hurdle.`
                        }]
                    })
                });
                
                const data = await response.json();
                const advice = data.content[0].text;
                
                document.getElementById('stuckContent').innerHTML = `
                    <h3 style="color: var(--primary); margin-bottom: 15px;">${task.title}</h3>
                    <div style="white-space: pre-wrap; line-height: 1.6;">${advice}</div>
                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="closeModal('stuckModal')">Let's start! 💪</button>
                    </div>
                `;
                
            } catch (error) {
                document.getElementById('stuckContent').innerHTML = `
                    <p style="color: var(--danger);">Couldn't get advice right now. But here's the thing:</p>
                    <p style="margin-top: 15px;">Just do ONE tiny piece of "${task.title}". Even 30 seconds of work counts. Starting is the hardest part.</p>
                    <button class="btn btn-primary" onclick="closeModal('stuckModal')" style="margin-top: 20px;">Okay, I'll try</button>
                `;
            }
        }

        // Task actions
        function completeTask(taskId) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            task.completed = true;
            task.completedAt = new Date().toISOString();
            
            const thisWeek = getWeekStart();
            if (!task.weekCompleted || task.weekCompleted === thisWeek) {
                task.weekCompleted = thisWeek;
                appData.completedTasks.push(task);
            }
            
            saveData();
            render();
            
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
            
            showToast('🎉 Task completed!');
        }

        function skipTask(taskId) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            appData.tasks = appData.tasks.filter(t => t.id !== taskId);
            appData.tasks.push(task);
            
            saveData();
            render();
            showToast('⭐ Task skipped to later');
        }

        function notTodayTask(taskId) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            appData.tasks = appData.tasks.filter(t => t.id !== taskId);
            appData.notTodayTasks.push(task);
            
            saveData();
            render();
            showToast('🌙 Moved to Not Today pile');
        }

        function restoreTask(taskId) {
            const task = appData.notTodayTasks.find(t => t.id === taskId);
            if (!task) return;
            
            appData.notTodayTasks = appData.notTodayTasks.filter(t => t.id !== taskId);
            appData.tasks.push(task);
            
            saveData();
            render();
            showToast('✅ Task restored!');
        }

        function deleteTask(taskId) {
            if (!confirm('Delete this task?')) return;
            
            appData.tasks = appData.tasks.filter(t => t.id !== taskId);
            appData.notTodayTasks = appData.notTodayTasks.filter(t => t.id !== taskId);
            
            saveData();
            render();
            showToast('🗑️ Task deleted');
        }

        // Deadline functions
        function showAddDeadline() {
            showModal('addDeadlineModal');
        }

        function addDeadline() {
            const name = document.getElementById('newDeadlineName').value.trim();
            const course = document.getElementById('newDeadlineCourse').value.trim();
            const dateStr = document.getElementById('newDeadlineDate').value;
            
            if (!name || !course || !dateStr) {
                showToast('Please fill all fields!');
                return;
            }
            
            appData.deadlines.push({
                name,
                course,
                date: new Date(dateStr)
            });
            
            saveData();
            render();
            closeModal('addDeadlineModal');
            
            document.getElementById('newDeadlineName').value = '';
            document.getElementById('newDeadlineCourse').value = '';
            document.getElementById('newDeadlineDate').value = '';
            
            showToast('✅ Deadline added!');
        }

        // Mood tracker
        function setMood(emoji) {
            const today = new Date().toDateString();
            appData.mood = emoji;
            appData.moodDate = today;
            
            saveData();
            
            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-mood="${emoji}"]`).classList.add('active');
            
            document.getElementById('moodStatus').textContent = `Today's mood: ${emoji}`;
            
            showToast('Mood logged! 💭');
        }

        // Settings
        function showSettings() {
            document.getElementById('apiKeyInput').value = appData.apiKey;
            document.getElementById('autoAnalyze').checked = appData.autoAnalyze;
            showModal('settingsModal');
        }

        function saveSettings() {
            appData.apiKey = document.getElementById('apiKeyInput').value.trim();
            appData.autoAnalyze = document.getElementById('autoAnalyze').checked;
            
            saveData();
            closeModal('settingsModal');
            showToast('✅ Settings saved!');
        }

        // Font toggle
        function toggleFont() {
            document.body.classList.toggle('dyslexia-font');
            const isDyslexic = document.body.classList.contains('dyslexia-font');
            localStorage.setItem('dyslexiaFont', isDyslexic);
            showToast(isDyslexic ? '🔤 Dyslexia font enabled' : '🔤 Standard font enabled');
        }

        // Modals
        function showModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function showQuickAdd() {
            document.getElementById('quickTaskInput').focus();
        }

        function showBrainDump() {
            showModal('brainDumpModal');
            document.getElementById('brainDumpText').focus();
        }

        // Toast notifications
        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: var(--text);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 2000;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Utility functions
        function getWeekStart() {
            const now = new Date();
            const day = now.getDay();
            const diff = now.getDate() - day;
            return new Date(now.setDate(diff)).toDateString();
        }

        // Render everything
        function render() {
            renderTopPriorities();
            renderAllTasks();
            renderNotTodayPile();
            renderWeeklyWins();
            renderMood();
            renderDeadlines();
        }

        function renderTopPriorities() {
            const container = document.getElementById('priorityTasks');
            const availableTasks = appData.tasks.filter(t => !t.completed);
            
            const priorityScore = { high: 3, medium: 2, low: 1 };
            const sorted = [...availableTasks].sort((a, b) => {
                const aDiff = priorityScore[a.priority] || 2;
                const bDiff = priorityScore[b.priority] || 2;
                return bDiff - aDiff;
            });
            
            const top3 = sorted.slice(0, 3);
            
            if (top3.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">✨</div>
                        <p>No urgent tasks right now! Add some tasks to get started.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = top3.map((task, index) => `
                <div class="priority-task">
                    <div class="priority-number">${index + 1}</div>
                    <div class="priority-content">
                        <div class="priority-title">${task.title}</div>
                        <div class="priority-meta">
                            ${task.energy ? `<span class="energy-badge energy-${task.energy}">${task.energy}</span>` : ''}
                            ${task.timeEstimate ? `<span class="time-estimate">⏱️ ${task.timeEstimate}</span>` : ''}
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="completeTask(${task.id})">✓ Done</button>
                </div>
            `).join('');
        }

        function renderAllTasks() {
            const container = document.getElementById('allTasks');
            const tasks = appData.tasks.filter(t => !t.completed);
            
            if (tasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📝</div>
                        <p>No tasks yet! Use Quick Add or Brain Dump to get started.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = tasks.map(task => `
                <div class="task-item">
                    <input type="checkbox" class="task-checkbox" onchange="completeTask(${task.id})">
                    <div class="task-content">
                        <div class="task-title">${task.title}</div>
                        <div class="task-meta">
                            ${task.energy ? `<span class="energy-badge energy-${task.energy}">${task.energy}</span>` : ''}
                            ${task.timeEstimate ? `<span class="time-estimate">⏱️ ${task.timeEstimate}</span>` : ''}
                        </div>
                    </div>
                    <div class="task-actions">
                        <button class="task-btn" onclick="skipTask(${task.id})">⭐ Skip</button>
                        <button class="task-btn" onclick="notTodayTask(${task.id})">🌙 Not Today</button>
                        <button class="task-btn" onclick="deleteTask(${task.id})">🗑️</button>
                    </div>
                </div>
            `).join('');
        }

        function renderNotTodayPile() {
            const container = document.getElementById('notTodayPile');
            
            if (appData.notTodayTasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">✨</div>
                        <p>Nothing here! This is a good thing.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = appData.notTodayTasks.map(task => `
                <div class="task-item">
                    <div class="task-content">
                        <div class="task-title">${task.title} <span class="not-today-badge">Tomorrow</span></div>
                    </div>
                    <div class="task-actions">
                        <button class="task-btn" onclick="restoreTask(${task.id})">↩️ Restore</button>
                        <button class="task-btn" onclick="deleteTask(${task.id})">🗑️</button>
                    </div>
                </div>
            `).join('');
        }

        function renderWeeklyWins() {
            const container = document.getElementById('weeklyWins');
            const thisWeek = getWeekStart();
            const wins = appData.completedTasks.filter(t => t.weekCompleted === thisWeek);
            
            if (wins.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🎉</div>
                        <p>Complete some tasks to see your wins here!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = wins.map(task => `
                <div class="win-item">
                    ✓ ${task.title}
                </div>
            `).join('');
        }

        function renderMood() {
            const today = new Date().toDateString();
            if (appData.moodDate === today && appData.mood) {
                document.querySelectorAll('.mood-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                const activeBtn = document.querySelector(`[data-mood="${appData.mood}"]`);
                if (activeBtn) activeBtn.classList.add('active');
                document.getElementById('moodStatus').textContent = `Today's mood: ${appData.mood}`;
            } else {
                document.getElementById('moodStatus').textContent = 'Tap an emoji to log your mood';
            }
        }

        // Initialize
        window.onload = () => {
            loadData();
            
            const dyslexiaFont = localStorage.getItem('dyslexiaFont') === 'true';
            if (dyslexiaFont) {
                document.body.classList.add('dyslexia-font');
            }
            
            if (!appData.apiKey) {
                setTimeout(() => {
                    showToast('💡 Tip: Add your Anthropic API key in Settings for smart features!');
                }, 2000);
            }
        };
    </script>
</body>
</html>