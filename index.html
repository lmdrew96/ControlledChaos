<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controlled Chaos v2 🌀</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-main: #f8fafc;
            --bg-card: white;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            
            --energy-high: #ef4444;
            --energy-medium: #f59e0b;
            --energy-low: #10b981;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text);
        }

        body.dyslexia-font {
            font-family: 'OpenDyslexic', sans-serif;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--bg-main);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5em;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .tagline {
            color: var(--text-light);
            font-style: italic;
            font-size: 1.1em;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        /* Priority Section */
        .priority-section {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            color: white;
        }

        .priority-section h2 {
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .priority-tasks {
            display: grid;
            gap: 15px;
        }

        .priority-task {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .priority-number {
            font-size: 2em;
            font-weight: bold;
            background: white;
            color: #f59e0b;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .priority-content {
            flex: 1;
        }

        .priority-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .priority-meta {
            display: flex;
            gap: 10px;
            font-size: 0.9em;
            opacity: 0.9;
        }

        .energy-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .energy-high {
            background: var(--energy-high);
            color: white;
        }

        .energy-medium {
            background: var(--energy-medium);
            color: white;
        }

        .energy-low {
            background: var(--energy-low);
            color: white;
        }

        .time-estimate {
            background: rgba(255,255,255,0.3);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: var(--primary);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: var(--text-light);
            line-height: 1;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* Card */
        .card {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .card h2 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        /* Task List */
        .task-list {
            display: grid;
            gap: 12px;
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: var(--bg-main);
            border-radius: 10px;
            border: 2px solid var(--border);
            transition: all 0.3s;
        }

        .task-item:hover {
            border-color: var(--primary);
        }

        .task-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .task-content {
            flex: 1;
        }

        .task-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .task-meta {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            font-size: 0.85em;
        }

        .task-actions {
            display: flex;
            gap: 8px;
        }

        .task-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
            background: var(--border);
            color: var(--text);
            transition: all 0.3s;
        }

        .task-btn:hover {
            background: var(--primary);
            color: white;
        }

        /* Progress Bar */
        .progress-bar {
            background: var(--border);
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            transition: width 0.5s ease;
        }

        /* Weekly Wins */
        .wins-list {
            display: grid;
            gap: 10px;
        }

        .win-item {
            padding: 12px;
            background: var(--bg-main);
            border-radius: 8px;
            border-left: 4px solid var(--success);
        }

        /* Mood Tracker */
        .mood-selector {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
        }

        .mood-btn {
            font-size: 3em;
            background: none;
            border: none;
            cursor: pointer;
            opacity: 0.3;
            transition: all 0.3s;
        }

        .mood-btn:hover,
        .mood-btn.active {
            opacity: 1;
            transform: scale(1.2);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 15px;
        }

        /* Utility */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-20 {
            margin-top: 20px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 2em;
            }

            .header-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }

        /* Quick Add Input */
        .quick-add {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .quick-add input {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1em;
        }

        /* Not Today Pile Badge */
        .not-today-badge {
            background: var(--warning);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>🌀 Controlled Chaos v2</h1>
            <p class="tagline">Managing the beautiful mess of college life</p>
            
            <div class="header-buttons">
                <button class="btn btn-primary" onclick="showPickForMe()">🎯 Pick For Me</button>
                <button class="btn btn-primary" onclick="showStuck()">🤔 I'm Stuck</button>
                <button class="btn btn-secondary" onclick="undo()">↩️ Undo</button>
                <button class="btn btn-secondary" onclick="showQuickAdd()">⚡ Quick Add</button>
                <button class="btn btn-secondary" onclick="showBrainDump()">🧠 Brain Dump</button>
                <button class="btn btn-secondary" onclick="showSettings()">⚙️ Settings</button>
                <button class="btn btn-secondary" onclick="toggleFont()">🔤 Font</button>
            </div>
        </header>

        <!-- Top 3 Priorities -->
        <div class="priority-section">
            <h2>🎯 Your Top 3 Priorities Right Now</h2>
            <div id="priorityTasks" class="priority-tasks">
                <div class="empty-state">
                    <div class="empty-state-icon">✨</div>
                    <p>No urgent tasks right now! Add some tasks to get started.</p>
                </div>
            </div>
        </div>

        <!-- Mood Tracker -->
        <div class="card">
            <h2>💭 How are you feeling today?</h2>
            <div class="mood-selector">
                <button class="mood-btn" onclick="setMood('😢')" data-mood="😢">😢</button>
                <button class="mood-btn" onclick="setMood('😕')" data-mood="😕">😕</button>
                <button class="mood-btn" onclick="setMood('😐')" data-mood="😐">😐</button>
                <button class="mood-btn" onclick="setMood('🙂')" data-mood="🙂">🙂</button>
                <button class="mood-btn" onclick="setMood('😄')" data-mood="😄">😄</button>
            </div>
            <p id="moodStatus" class="text-center text-light" style="color: var(--text-light);"></p>
        </div>

        <!-- Tasks Section -->
        <div class="card">
            <h2>📋 All Tasks</h2>
            <div class="quick-add">
                <input type="text" id="quickTaskInput" placeholder="Quick add a task... (press Enter)" 
                       onkeypress="if(event.key==='Enter') quickAddTask()">
                <button class="btn btn-primary" onclick="quickAddTask()">Add</button>
            </div>
            <div id="allTasks" class="task-list">
                <div class="empty-state">
                    <div class="empty-state-icon">📝</div>
                    <p>No tasks yet! Use Quick Add or Brain Dump to get started.</p>
                </div>
            </div>
        </div>

        <!-- Not Today Pile -->
        <div class="card">
            <h2>🌙 Not Today Pile</h2>
            <p style="color: var(--text-light); margin-bottom: 15px;">
                Tasks you can't even think about today. They'll come back tomorrow.
            </p>
            <div id="notTodayPile" class="task-list">
                <div class="empty-state">
                    <div class="empty-state-icon">✨</div>
                    <p>Nothing here! This is a good thing.</p>
                </div>
            </div>
        </div>

        <!-- Weekly Wins -->
        <div class="card">
            <h2>🏆 This Week's Wins</h2>
            <div id="weeklyWins" class="wins-list">
                <div class="empty-state">
                    <div class="empty-state-icon">🎉</div>
                    <p>Complete some tasks to see your wins here!</p>
                </div>
            </div>
        </div>

        <!-- Projects Progress -->
        <div class="card">
            <h2>📊 Project Progress</h2>
            <div id="projectProgress">
                <div class="empty-state">
                    <div class="empty-state-icon">🚀</div>
                    <p>Add projects to track your progress!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>⚙️ Settings</h2>
                <button class="close-modal" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            <div class="form-group">
                <label for="apiKeyInput">Anthropic API Key</label>
                <input type="password" id="apiKeyInput" placeholder="sk-ant-...">
                <p style="color: var(--text-light); font-size: 0.9em; margin-top: 5px;">
                    Your API key is stored locally in your browser and never sent anywhere except Anthropic's API.
                </p>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="autoAnalyze"> 
                    Automatically analyze new tasks with Claude
                </label>
            </div>
            <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
        </div>
    </div>

    <!-- Brain Dump Modal -->
    <div id="brainDumpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🧠 Brain Dump</h2>
                <button class="close-modal" onclick="closeModal('brainDumpModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Dump everything on your mind (one task per line or just word-vomit it all):</label>
                <textarea id="brainDumpText" placeholder="Write essay for english&#10;Buy groceries&#10;Email professor about extension&#10;Fix bug in code&#10;...or just type whatever is stressing you out!"></textarea>
            </div>
            <button class="btn btn-primary" onclick="processBrainDump()">✨ Organize My Chaos</button>
        </div>
    </div>

    <!-- Stuck Modal -->
    <div id="stuckModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🤔 Let's Break This Down</h2>
                <button class="close-modal" onclick="closeModal('stuckModal')">&times;</button>
            </div>
            <div id="stuckContent">
                <p>What task are you stuck on?</p>
            </div>
        </div>
    </div>

    <!-- Pick For Me Modal -->
    <div id="pickForMeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🎯 I Choose...</h2>
                <button class="close-modal" onclick="closeModal('pickForMeModal')">&times;</button>
            </div>
            <div id="pickForMeContent" style="text-align: center; padding: 20px;">
                <p>Let me think...</p>
            </div>
        </div>
    </div>

    <script>
        // Data structure
        let appData = {
            apiKey: '',
            autoAnalyze: true,
            tasks: [],
            notTodayTasks: [],
            completedTasks: [],
            mood: null,
            moodDate: null,
            history: [],
            projects: []
        };

        // Load data on startup
        function loadData() {
            const saved = localStorage.getItem('controlledChaosV2');
            if (saved) {
                appData = { ...appData, ...JSON.parse(saved) };
            }
            
            // Check if we need to restore "not today" tasks
            const today = new Date().toDateString();
            const lastCheck = localStorage.getItem('lastNotTodayCheck');
            if (lastCheck !== today) {
                // New day! Restore "not today" tasks
                appData.tasks = [...appData.tasks, ...appData.notTodayTasks];
                appData.notTodayTasks = [];
                localStorage.setItem('lastNotTodayCheck', today);
            }
            
            render();
        }

        // Save data
        function saveData() {
            // Save to history for undo
            appData.history.push(JSON.stringify(appData));
            if (appData.history.length > 10) {
                appData.history.shift(); // Keep last 10 states
            }
            
            localStorage.setItem('controlledChaosV2', JSON.stringify(appData));
        }

        // Undo
        function undo() {
            if (appData.history.length > 0) {
                const previous = appData.history.pop();
                appData = JSON.parse(previous);
                localStorage.setItem('controlledChaosV2', JSON.stringify(appData));
                render();
                showToast('✅ Undone!');
            } else {
                showToast('Nothing to undo!');
            }
        }

        // Quick add task
        function quickAddTask() {
            const input = document.getElementById('quickTaskInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            const task = {
                id: Date.now(),
                title: text,
                completed: false,
                energy: null,
                timeEstimate: null,
                dueDate: null,
                priority: 'medium',
                createdAt: new Date().toISOString()
            };
            
            appData.tasks.push(task);
            input.value = '';
            
            // Auto-analyze if enabled
            if (appData.autoAnalyze && appData.apiKey) {
                analyzeTask(task);
            }
            
            saveData();
            render();
            showToast('✅ Task added!');
        }

        // Analyze task with Claude
        async function analyzeTask(task) {
            if (!appData.apiKey) {
                showToast('⚠️ Add your API key in settings first!');
                return;
            }
            
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': appData.apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 200,
                        messages: [{
                            role: 'user',
                            content: `Analyze this task and respond ONLY with a JSON object (no other text):

Task: "${task.title}"

Respond with:
{
  "energy": "low" | "medium" | "high",
  "timeEstimate": "5min" | "15min" | "30min" | "1hr" | "2hrs" | "3hrs+" ,
  "reasoning": "brief reason for your assessment"
}

Energy levels:
- low: Simple, easy tasks (checking email, quick replies)
- medium: Moderate focus needed (writing, research)
- high: Deep work required (complex problem solving, creative work)

Base time estimates on typical completion time for a college student.`
                        }]
                    })
                });
                
                if (!response.ok) {
                    throw new Error('API request failed');
                }
                
                const data = await response.json();
                const text = data.content[0].text.trim();
                
                // Extract JSON from response (in case Claude adds extra text)
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (!jsonMatch) {
                    console.error('No JSON found in response:', text);
                    return;
                }
                
                const analysis = JSON.parse(jsonMatch[0]);
                
                // Update task
                task.energy = analysis.energy;
                task.timeEstimate = analysis.timeEstimate;
                
                saveData();
                render();
                
            } catch (error) {
                console.error('Failed to analyze task:', error);
                // Don't show toast for failed analysis - not critical
            }
        }

        // Brain dump processor
        async function processBrainDump() {
            const text = document.getElementById('brainDumpText').value.trim();
            if (!text) return;
            
            if (!appData.apiKey) {
                // No API key - do simple processing
                const lines = text.split('\n').filter(line => line.trim());
                lines.forEach(line => {
                    appData.tasks.push({
                        id: Date.now() + Math.random(),
                        title: line.trim(),
                        completed: false,
                        energy: null,
                        timeEstimate: null,
                        priority: 'medium',
                        createdAt: new Date().toISOString()
                    });
                });
                
                saveData();
                render();
                closeModal('brainDumpModal');
                showToast(`✅ Added ${lines.length} tasks!`);
                document.getElementById('brainDumpText').value = '';
                return;
            }
            
            // Use Claude to organize
            showToast('🤔 Claude is organizing your chaos...');
            
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': appData.apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [{
                            role: 'user',
                            content: `Parse this brain dump into actionable tasks. Respond ONLY with a JSON array (no other text):

"${text}"

Extract tasks and respond with:
[
  {
    "title": "clear, actionable task title",
    "energy": "low" | "medium" | "high",
    "timeEstimate": "5min" | "15min" | "30min" | "1hr" | "2hrs" | "3hrs+",
    "priority": "low" | "medium" | "high"
  }
]

Rules:
- Break vague items into specific tasks
- If someone mentions multiple things, create separate tasks
- Make each task actionable (starts with a verb)
- Estimate realistically for a college student
- Return at least 1 task, even if the dump is messy`
                        }]
                    })
                });
                
                const data = await response.json();
                const text_response = data.content[0].text.trim();
                
                // Extract JSON
                const jsonMatch = text_response.match(/\[[\s\S]*\]/);
                if (!jsonMatch) {
                    throw new Error('No JSON array found');
                }
                
                const tasks = JSON.parse(jsonMatch[0]);
                
                // Add tasks
                tasks.forEach(taskData => {
                    appData.tasks.push({
                        id: Date.now() + Math.random(),
                        title: taskData.title,
                        completed: false,
                        energy: taskData.energy,
                        timeEstimate: taskData.timeEstimate,
                        priority: taskData.priority || 'medium',
                        createdAt: new Date().toISOString()
                    });
                });
                
                saveData();
                render();
                closeModal('brainDumpModal');
                showToast(`✨ Created ${tasks.length} organized tasks!`);
                document.getElementById('brainDumpText').value = '';
                
            } catch (error) {
                console.error('Brain dump failed:', error);
                showToast('❌ Failed to process. Try simpler text or check API key.');
            }
        }

        // Pick for me
        function showPickForMe() {
            const availableTasks = appData.tasks.filter(t => !t.completed);
            
            if (availableTasks.length === 0) {
                showToast('🎉 No tasks left! You did it!');
                return;
            }
            
            // Simple algorithm: prioritize high priority, then urgent due dates, then high energy (when you have energy)
            const sortedTasks = [...availableTasks].sort((a, b) => {
                // Priority first
                const priorityScore = { high: 3, medium: 2, low: 1 };
                const aDiff = priorityScore[a.priority] || 2;
                const bDiff = priorityScore[b.priority] || 2;
                
                if (aDiff !== bDiff) return bDiff - aDiff;
                
                // Then by due date if available
                if (a.dueDate && b.dueDate) {
                    return new Date(a.dueDate) - new Date(b.dueDate);
                }
                
                return 0;
            });
            
            const chosen = sortedTasks[0];
            
            document.getElementById('pickForMeContent').innerHTML = `
                <div style="font-size: 2em; margin: 20px 0;">🎯</div>
                <h3 style="color: var(--primary); margin-bottom: 15px;">${chosen.title}</h3>
                ${chosen.energy ? `<div class="energy-badge energy-${chosen.energy}">${chosen.energy.toUpperCase()} energy</div>` : ''}
                ${chosen.timeEstimate ? `<div class="time-estimate" style="margin-top: 10px;">⏱️ ${chosen.timeEstimate}</div>` : ''}
                <div style="margin-top: 30px;">
                    <button class="btn btn-primary" onclick="closeModal('pickForMeModal')">Let's do this! 💪</button>
                    <button class="btn btn-secondary" onclick="skipTask(${chosen.id}); closeModal('pickForMeModal')">Skip this one</button>
                </div>
            `;
            
            showModal('pickForMeModal');
        }

        // I'm stuck
        function showStuck() {
            const availableTasks = appData.tasks.filter(t => !t.completed);
            
            if (availableTasks.length === 0) {
                showToast('No tasks to be stuck on!');
                return;
            }
            
            // Show list of tasks to pick from
            let html = '<p style="margin-bottom: 15px;">Which task are you stuck on?</p><div class="task-list">';
            
            availableTasks.forEach(task => {
                html += `
                    <div class="task-item" style="cursor: pointer;" onclick="breakDownTask(${task.id})">
                        <div class="task-content">
                            <div class="task-title">${task.title}</div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            document.getElementById('stuckContent').innerHTML = html;
            showModal('stuckModal');
        }

        // Break down task
        async function breakDownTask(taskId) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            if (!appData.apiKey) {
                // Simple breakdown without AI
                const steps = [
                    'Open the relevant files/materials',
                    'Set a 5-minute timer and just start',
                    'Do the first small piece',
                    'Take a break',
                    'Continue with the next piece'
                ];
                
                let html = `
                    <h3 style="color: var(--primary); margin-bottom: 15px;">${task.title}</h3>
                    <p style="margin-bottom: 15px;">Here's how to get started:</p>
                    <ol style="padding-left: 20px;">
                `;
                
                steps.forEach(step => {
                    html += `<li style="margin-bottom: 10px;">${step}</li>`;
                });
                
                html += `</ol>
                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="closeModal('stuckModal')">Got it! 👍</button>
                    </div>
                `;
                
                document.getElementById('stuckContent').innerHTML = html;
                return;
            }
            
            // Use Claude
            document.getElementById('stuckContent').innerHTML = '<p>🤔 Let me break this down for you...</p>';
            
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': appData.apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 500,
                        messages: [{
                            role: 'user',
                            content: `I'm stuck on this task: "${task.title}"

Break it down into the SMALLEST possible first step (something I can do in 5 minutes or less to just get started). 

Give me:
1. The tiniest first action (be very specific and concrete)
2. A friendly encouragement
3. What to do after that first step

Be direct and brief. Help me overcome the "starting" hurdle.`
                        }]
                    })
                });
                
                const data = await response.json();
                const advice = data.content[0].text;
                
                document.getElementById('stuckContent').innerHTML = `
                    <h3 style="color: var(--primary); margin-bottom: 15px;">${task.title}</h3>
                    <div style="white-space: pre-wrap; line-height: 1.6;">${advice}</div>
                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="closeModal('stuckModal')">Let's start! 💪</button>
                    </div>
                `;
                
            } catch (error) {
                document.getElementById('stuckContent').innerHTML = `
                    <p style="color: var(--danger);">Couldn't get advice right now. But here's the thing:</p>
                    <p style="margin-top: 15px;">Just do ONE tiny piece of "${task.title}". Even 30 seconds of work counts. Starting is the hardest part.</p>
                    <button class="btn btn-primary" onclick="closeModal('stuckModal')" style="margin-top: 20px;">Okay, I'll try</button>
                `;
            }
        }

        // Task actions
        function completeTask(taskId) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            task.completed = true;
            task.completedAt = new Date().toISOString();
            
            // Add to weekly wins
            const thisWeek = getWeekStart();
            if (!task.weekCompleted || task.weekCompleted === thisWeek) {
                task.weekCompleted = thisWeek;
                appData.completedTasks.push(task);
            }
            
            saveData();
            render();
            
            // Confetti!
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
            
            showToast('🎉 Task completed!');
            
            // Update top 3 after a delay
            setTimeout(() => {
                render();
            }, 1000);
        }

        function skipTask(taskId) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            // Move to end of list
            appData.tasks = appData.tasks.filter(t => t.id !== taskId);
            appData.tasks.push(task);
            
            saveData();
            render();
            showToast('⏭️ Task skipped to later');
        }

        function notTodayTask(taskId) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            // Move to not today pile
            appData.tasks = appData.tasks.filter(t => t.id !== taskId);
            appData.notTodayTasks.push(task);
            
            saveData();
            render();
            showToast('🌙 Moved to Not Today pile');
        }

        function restoreTask(taskId) {
            const task = appData.notTodayTasks.find(t => t.id === taskId);
            if (!task) return;
            
            appData.notTodayTasks = appData.notTodayTasks.filter(t => t.id !== taskId);
            appData.tasks.push(task);
            
            saveData();
            render();
            showToast('✅ Task restored!');
        }

        function deleteTask(taskId) {
            if (!confirm('Delete this task?')) return;
            
            appData.tasks = appData.tasks.filter(t => t.id !== taskId);
            appData.notTodayTasks = appData.notTodayTasks.filter(t => t.id !== taskId);
            
            saveData();
            render();
            showToast('🗑️ Task deleted');
        }

        // Mood tracker
        function setMood(emoji) {
            const today = new Date().toDateString();
            appData.mood = emoji;
            appData.moodDate = today;
            
            saveData();
            
            // Update UI
            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-mood="${emoji}"]`).classList.add('active');
            
            document.getElementById('moodStatus').textContent = `Today's mood: ${emoji}`;
            
            showToast('Mood logged! 💭');
        }

        // Settings
        function showSettings() {
            document.getElementById('apiKeyInput').value = appData.apiKey;
            document.getElementById('autoAnalyze').checked = appData.autoAnalyze;
            showModal('settingsModal');
        }

        function saveSettings() {
            appData.apiKey = document.getElementById('apiKeyInput').value.trim();
            appData.autoAnalyze = document.getElementById('autoAnalyze').checked;
            
            saveData();
            closeModal('settingsModal');
            showToast('✅ Settings saved!');
        }

        // Font toggle
        function toggleFont() {
            document.body.classList.toggle('dyslexia-font');
            const isDyslexic = document.body.classList.contains('dyslexia-font');
            localStorage.setItem('dyslexiaFont', isDyslexic);
            showToast(isDyslexic ? '🔤 Dyslexia font enabled' : '🔤 Standard font enabled');
        }

        // Modals
        function showModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function showQuickAdd() {
            document.getElementById('quickTaskInput').focus();
        }

        function showBrainDump() {
            showModal('brainDumpModal');
            document.getElementById('brainDumpText').focus();
        }

        // Toast notifications
        function showToast(message) {
            // Simple toast implementation
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: var(--text);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 2000;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Utility functions
        function getWeekStart() {
            const now = new Date();
            const day = now.getDay();
            const diff = now.getDate() - day;
            return new Date(now.setDate(diff)).toDateString();
        }

        // Render everything
        function render() {
            renderTopPriorities();
            renderAllTasks();
            renderNotTodayPile();
            renderWeeklyWins();
            renderMood();
        }

        function renderTopPriorities() {
            const container = document.getElementById('priorityTasks');
            const availableTasks = appData.tasks.filter(t => !t.completed);
            
            // Sort by priority and due date
            const priorityScore = { high: 3, medium: 2, low: 1 };
            const sorted = [...availableTasks].sort((a, b) => {
                const aDiff = priorityScore[a.priority] || 2;
                const bDiff = priorityScore[b.priority] || 2;
                return bDiff - aDiff;
            });
            
            const top3 = sorted.slice(0, 3);
            
            if (top3.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">✨</div>
                        <p>No urgent tasks right now! Add some tasks to get started.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = top3.map((task, index) => `
                <div class="priority-task">
                    <div class="priority-number">${index + 1}</div>
                    <div class="priority-content">
                        <div class="priority-title">${task.title}</div>
                        <div class="priority-meta">
                            ${task.energy ? `<span class="energy-badge energy-${task.energy}">${task.energy}</span>` : ''}
                            ${task.timeEstimate ? `<span class="time-estimate">⏱️ ${task.timeEstimate}</span>` : ''}
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="completeTask(${task.id})">✓ Done</button>
                </div>
            `).join('');
        }

        function renderAllTasks() {
            const container = document.getElementById('allTasks');
            const tasks = appData.tasks.filter(t => !t.completed);
            
            if (tasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📝</div>
                        <p>No tasks yet! Use Quick Add or Brain Dump to get started.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = tasks.map(task => `
                <div class="task-item">
                    <input type="checkbox" class="task-checkbox" onchange="completeTask(${task.id})">
                    <div class="task-content">
                        <div class="task-title">${task.title}</div>
                        <div class="task-meta">
                            ${task.energy ? `<span class="energy-badge energy-${task.energy}">${task.energy}</span>` : ''}
                            ${task.timeEstimate ? `<span class="time-estimate">⏱️ ${task.timeEstimate}</span>` : ''}
                        </div>
                    </div>
                    <div class="task-actions">
                        <button class="task-btn" onclick="skipTask(${task.id})">⏭️ Skip</button>
                        <button class="task-btn" onclick="notTodayTask(${task.id})">🌙 Not Today</button>
                        <button class="task-btn" onclick="deleteTask(${task.id})">🗑️</button>
                    </div>
                </div>
            `).join('');
        }

        function renderNotTodayPile() {
            const container = document.getElementById('notTodayPile');
            
            if (appData.notTodayTasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">✨</div>
                        <p>Nothing here! This is a good thing.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = appData.notTodayTasks.map(task => `
                <div class="task-item">
                    <div class="task-content">
                        <div class="task-title">${task.title} <span class="not-today-badge">Tomorrow</span></div>
                    </div>
                    <div class="task-actions">
                        <button class="task-btn" onclick="restoreTask(${task.id})">↩️ Restore</button>
                        <button class="task-btn" onclick="deleteTask(${task.id})">🗑️</button>
                    </div>
                </div>
            `).join('');
        }

        function renderWeeklyWins() {
            const container = document.getElementById('weeklyWins');
            const thisWeek = getWeekStart();
            const wins = appData.completedTasks.filter(t => t.weekCompleted === thisWeek);
            
            if (wins.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🎉</div>
                        <p>Complete some tasks to see your wins here!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = wins.map(task => `
                <div class="win-item">
                    ✓ ${task.title}
                </div>
            `).join('');
        }

        function renderMood() {
            const today = new Date().toDateString();
            if (appData.moodDate === today && appData.mood) {
                document.querySelectorAll('.mood-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                const activeBtn = document.querySelector(`[data-mood="${appData.mood}"]`);
                if (activeBtn) activeBtn.classList.add('active');
                document.getElementById('moodStatus').textContent = `Today's mood: ${appData.mood}`;
            } else {
                document.getElementById('moodStatus').textContent = 'Tap an emoji to log your mood';
            }
        }

        // Initialize
        window.onload = () => {
            loadData();
            
            // Load font preference
            const dyslexiaFont = localStorage.getItem('dyslexiaFont') === 'true';
            if (dyslexiaFont) {
                document.body.classList.add('dyslexia-font');
            }
            
            // Check if API key is set
            if (!appData.apiKey) {
                setTimeout(() => {
                    showToast('💡 Tip: Add your Anthropic API key in Settings for smart features!');
                }, 2000);
            }
        };
    </script>
</body>
</html>