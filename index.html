<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controlled Chaos v4 🌀</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- Google API Scripts -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-main: #f8fafc;
            --bg-card: white;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            
            --energy-high: #ef4444;
            --energy-medium: #f59e0b;
            --energy-low: #10b981;
            
            --protected: #9333ea;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text);
        }

        body.dyslexia-font {
            font-family: 'OpenDyslexic', sans-serif;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--bg-main);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5em;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .tagline {
            color: var(--text-light);
            font-style: italic;
            font-size: 1.1em;
        }

        .current-date {
            color: var(--text);
            font-size: 1.1em;
            margin-top: 10px;
            font-weight: 600;
        }

        .sync-status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
        }

        .sync-status.signed-in {
            background: rgba(16, 185, 129, 0.1);
            border: 2px solid var(--success);
        }

        .sync-status.signed-out {
            background: rgba(102, 126, 234, 0.1);
            border: 2px solid var(--primary);
        }

        /* Toast notification for sign-in */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
            max-width: 400px;
        }

        .toast.fade-out {
            animation: fadeOut 0.5s ease-out forwards;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        /* Subtle user info in top-right corner */
        .user-info {
            position: fixed;
            top: 20px;
            right: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            font-size: 0.8em;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .user-info .email {
            color: var(--text);
            font-weight: 500;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .user-info .sign-out-btn {
            padding: 4px 10px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .user-info .sign-out-btn:hover {
            background: #dc2626;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        .btn .btn-text {
            display: inline;
        }

        .btn .btn-icon {
            display: inline;
        }

        /* Tooltip for mobile */
        .btn::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            margin-bottom: 5px;
        }

        .btn:hover::after {
            opacity: 1;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        /* Done for Today Button */
        .done-for-today-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 1.2rem;
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .done-for-today-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .done-hint {
            font-size: 0.9em;
            margin-top: 8px;
        }

        /* WHAT NOW - Hero Section */
        .what-now-hero {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .what-now-hero h2 {
            font-size: 2em;
            margin-bottom: 20px;
        }

        .location-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .location-btn {
            padding: 15px 25px;
            border: 3px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            border-radius: 12px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .location-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.05);
        }

        .location-btn.active {
            background: white;
            color: var(--primary);
            border-color: white;
        }

        .context-info {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .context-info h3 {
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .suggestion-card {
            background: white;
            color: var(--text);
            padding: 25px;
            border-radius: 12px;
            margin-top: 20px;
            text-align: left;
        }

        .suggestion-card h3 {
            color: var(--primary);
            font-size: 1.5em;
            margin-bottom: 15px;
        }

        .suggestion-reason {
            color: var(--text-light);
            margin-top: 10px;
            font-style: italic;
        }

        /* Schedule Section */
        .schedule-section {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
        }

        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .schedule-header h2 {
            color: var(--primary);
            font-size: 1.5em;
        }

        .current-block {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .current-block h3 {
            font-size: 1.3em;
            margin-bottom: 10px;
        }

        .time-remaining {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .schedule-day {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .schedule-day h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .schedule-item {
            padding: 10px 12px;
            margin: 5px 0;
            border-radius: 5px;
            font-size: 0.95em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .schedule-item.class {
            background: #e3f2fd;
            border-left: 3px solid #2196f3;
        }

        .schedule-item.work {
            background: #fce4ec;
            border-left: 3px solid #e91e63;
        }

        .schedule-item.personal {
            background: #f3e5f5;
            border-left: 3px solid #9c27b0;
        }

        .schedule-item.free {
            background: #e8f5e9;
            border-left: 3px solid #4caf50;
        }

        .schedule-item.protected {
            background: linear-gradient(135deg, #a855f7, #7c3aed);
            color: white;
            border-left: 3px solid #6b21a8;
        }

        .schedule-item.current {
            border: 3px solid var(--warning);
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.3);
        }

        .schedule-item .lock-icon {
            font-size: 1.2em;
        }

        /* Task Cards */
        .card {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .card h2 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid;
            padding-bottom: 10px;
        }

        .task-list {
            display: grid;
            gap: 12px;
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: var(--bg-main);
            border-radius: 10px;
            border: 2px solid var(--border);
            transition: all 0.3s;
        }

        .task-item:hover {
            border-color: var(--primary);
        }

        .task-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .task-content {
            flex: 1;
        }

        .task-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .task-meta {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            font-size: 0.85em;
        }

        .task-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .task-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
            background: var(--border);
            color: var(--text);
            transition: all 0.3s;
        }

        .task-btn:hover {
            background: var(--primary);
            color: white;
        }

        .energy-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .energy-high {
            background: var(--energy-high);
            color: white;
        }

        .energy-medium {
            background: var(--energy-medium);
            color: white;
        }

        .energy-low {
            background: var(--energy-low);
            color: white;
        }

        .location-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            background: var(--border);
        }

        .time-estimate {
            background: rgba(102, 126, 234, 0.1);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            color: var(--primary);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: var(--primary);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: var(--text-light);
            line-height: 1;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .quick-add {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .quick-add input {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1em;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 15px;
        }

        .hidden {
            display: none !important;
        }

        .config-warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            color: #856404;
        }

        /* Visual Time Block Planner Styles */
        .planner-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin: 20px 0;
            overflow-x: auto;
        }

        .planner-day-column {
            min-width: 150px;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }

        .planner-day-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .time-block {
            position: relative;
            margin: 4px;
            padding: 8px;
            border-radius: 6px;
            border: 2px dashed transparent;
            transition: all 0.2s;
            min-height: 60px;
        }

        .time-block.type-free {
            background: #f0fdf4;
            border-color: #86efac;
        }

        .time-block.type-class {
            background: #fef3c7;
            border-color: #fcd34d;
        }

        .time-block.type-work {
            background: #fee2e2;
            border-color: #fca5a5;
        }

        .time-block.type-personal {
            background: #f3e5f5;
            border-color: #ce93d8;
        }

        .time-block.type-protected {
            background: linear-gradient(135deg, #e9d5ff, #ddd6fe);
            border-color: #a78bfa;
        }

        .time-block.type-commute {
            background: #e0f2fe;
            border-color: #7dd3fc;
        }

        .block-time {
            font-size: 0.75em;
            color: var(--text-light);
            font-weight: 600;
        }

        .block-title {
            font-size: 0.85em;
            margin-top: 4px;
            font-weight: 500;
        }

        .block-lock {
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 1.2em;
        }

        .block-tasks {
            min-height: 30px;
            margin-top: 8px;
            padding: 4px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.5);
        }

        .block-tasks.drop-target {
            background: rgba(102, 126, 234, 0.2);
            border: 2px dashed var(--primary);
        }

        .mini-task-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            padding: 6px 8px;
            margin: 4px 0;
            border-radius: 4px;
            border-left: 3px solid var(--primary);
            font-size: 0.85rem;
            cursor: move;
        }

        .mini-task-card:hover {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .mini-task-title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .mini-task-time {
            font-size: 0.75em;
            color: var(--text-light);
            margin: 0 4px;
        }

        .mini-task-remove {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.8em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .mini-task-remove:hover {
            background: #dc2626;
        }

        .task-card.dragging {
            opacity: 0.5;
        }

        .unscheduled-task-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            border: 2px solid var(--border);
            margin: 8px 0;
            cursor: move;
            transition: all 0.2s;
        }

        .unscheduled-task-card:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .unscheduled-task-card.dragging {
            opacity: 0.5;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .planner-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }

            .planner-day-column {
                min-width: 140px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                padding-top: 60px; /* Space for fixed user badge */
            }

            h1 {
                font-size: 2em;
            }

            .user-info {
                top: 10px;
                right: 10px;
                font-size: 0.75em;
                padding: 5px 10px;
            }

            .user-info .email {
                max-width: 100px;
            }

            /* Transform buttons to compact icon toolbar on mobile */
            .header-buttons {
                display: grid;
                grid-template-columns: repeat(6, 1fr);
                gap: 8px;
                max-width: 100%;
                margin: 15px auto;
            }

            .btn {
                width: 100%;
                height: 50px;
                min-height: 50px;
                padding: 8px;
                justify-content: center;
                font-size: 1.5em;
                border-radius: 8px;
            }

            /* Hide text labels on mobile */
            .btn .btn-text {
                display: none;
            }

            /* Show only icons */
            .btn .btn-icon {
                display: inline;
                margin: 0;
            }

            /* Show tooltip on long press (touch) */
            .btn:active::after {
                opacity: 1;
            }

            .location-selector {
                flex-direction: column;
            }

            .location-btn {
                width: 100%;
            }
        }

        /* Tablet size - keep 6 column grid */
        @media (min-width: 481px) and (max-width: 768px) {
            .header-buttons {
                grid-template-columns: repeat(6, 1fr);
                max-width: 450px;
            }
        }

        /* Small mobile - 3 column grid for very narrow screens */
        @media (max-width: 400px) {
            .header-buttons {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .btn {
                height: 48px;
                min-height: 48px;
                font-size: 1.3em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>🌀 Controlled Chaos v4</h1>
            <p class="tagline">Your ADHD-friendly productivity companion with cross-device sync</p>
            <div class="current-date" id="currentDate"></div>
            
            <!-- Google Sign In / Status -->
            <div id="googleSignIn" class="sync-status signed-out">
                <button class="btn btn-primary" onclick="handleGoogleSignIn()">
                    🔐 Sign in with Google
                </button>
                <p style="font-size: 0.9em; margin-top: 10px;">
                    Sign in to sync your data across all devices
                </p>
            </div>

            <div id="userInfo" class="user-info" style="display: none;">
                <span class="email" id="userEmail"></span>
                <button class="sign-out-btn" onclick="handleGoogleSignOut()">Sign Out</button>
            </div>
            
            <div id="syncIndicator" style="display: none; margin-top: 8px; font-size: 0.85em; color: var(--text-light);">
                ☁️ Synced with Google Drive
            </div>
            
            <div class="header-buttons">
                <button class="btn btn-secondary" onclick="showQuickAdd()" data-tooltip="Quick Add">
                    <span class="btn-icon">⚡</span>
                    <span class="btn-text">Quick Add</span>
                </button>
                <button class="btn btn-secondary" onclick="showBrainDump()" data-tooltip="Brain Dump">
                    <span class="btn-icon">🧠</span>
                    <span class="btn-text">Brain Dump</span>
                </button>
                <button class="btn btn-secondary" onclick="showStuck()" data-tooltip="I'm Stuck">
                    <span class="btn-icon">🤔</span>
                    <span class="btn-text">I'm Stuck</span>
                </button>
                <button class="btn btn-secondary" onclick="showEditSchedule()" data-tooltip="Edit Schedule">
                    <span class="btn-icon">📅</span>
                    <span class="btn-text">Edit Schedule</span>
                </button>
                <button class="btn btn-secondary" onclick="showSettings()" data-tooltip="Settings">
                    <span class="btn-icon">⚙️</span>
                    <span class="btn-text">Settings</span>
                </button>
                <button class="btn btn-secondary" onclick="toggleFont()" data-tooltip="Font">
                    <span class="btn-icon">🔤</span>
                    <span class="btn-text">Font</span>
                </button>
            </div>
        </header>

        <!-- Configuration Warning -->
        <div id="configWarning" class="config-warning">
            <strong>⚠️ Configuration Required</strong><br>
            Please update the configuration in Settings with your Cloudflare Worker URL and Google Client ID.
            See SETUP-INSTRUCTIONS.md for details.
        </div>

        <!-- WHAT NOW Hero Section -->
        <div class="what-now-hero">
            <h2>🎯 What Should I Do Right Now?</h2>
            
            <div class="location-selector">
                <button class="location-btn" data-location="home" onclick="setLocation('home')">🏠 Home</button>
                <button class="location-btn" data-location="school" onclick="setLocation('school')">🏫 School</button>
                <button class="location-btn" data-location="work" onclick="setLocation('work')">💼 Work</button>
                <button class="location-btn" data-location="commute" onclick="setLocation('commute')">🚗 Commute</button>
            </div>

            <div id="contextInfo" class="context-info" style="display: none;">
                <h3 id="contextTitle">Loading...</h3>
                <p id="contextDetails"></p>
            </div>

            <div id="suggestionCard" style="display: none;">
                <!-- Suggestion will be inserted here -->
            </div>
            
            <!-- Done for Today Section -->
            <div class="done-for-today-section" style="margin-top: 20px;">
                <button id="doneForTodayBtn" class="done-for-today-btn" onclick="handleDoneForToday()">
                    😴 Done for Today
                </button>
                <p class="done-hint" style="color: rgba(255,255,255,0.8); font-size: 0.9em; margin-top: 8px;">
                    Exhausted? Move remaining tasks to tomorrow - no guilt!
                </p>
            </div>
        </div>

        <!-- Current Schedule Block -->
        <div class="schedule-section">
            <div class="schedule-header">
                <h2>📅 Your Schedule</h2>
                <button class="btn btn-warning" onclick="showEditSchedule()">✏️ Edit Schedule</button>
            </div>
            
            <div id="currentBlock" class="current-block" style="display: none;">
                <h3>📍 YOU ARE HERE</h3>
                <p id="currentBlockText"></p>
                <p class="time-remaining" id="timeRemaining"></p>
            </div>

            <div id="scheduleView"></div>
        </div>

        <!-- Deadlines Section -->
        <div class="card">
            <h2>📋 Deadlines</h2>
            <div class="quick-add">
                <input type="text" id="quickDeadlineInput" placeholder="Quick add a deadline... (press Enter)" 
                       onkeypress="if(event.key==='Enter') showAddDeadlineModal()">
                <button class="btn btn-primary" onclick="showAddDeadlineModal()">Add Deadline</button>
            </div>
            <div id="allDeadlines" class="task-list">
                <div class="empty-state">
                    <div class="empty-state-icon">📅</div>
                    <p>No deadlines yet!</p>
                </div>
            </div>
        </div>

        <!-- Errands & Stops Section -->
        <div class="card errands-section">
            <h2>🏪 Errands & Stops</h2>
            <p class="errands-hint" style="color: var(--text-light); margin-bottom: 15px;">
                Things to do when you're out and about (post office, grocery store, etc.)
            </p>
            
            <div class="common-errands" style="margin-bottom: 20px;">
                <h4 style="margin-bottom: 10px;">Quick add common errands:</h4>
                <div class="errand-buttons" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    <button class="btn btn-secondary" onclick="quickAddErrand('Post office')" style="width: 100%;">📮 Post office</button>
                    <button class="btn btn-secondary" onclick="quickAddErrand('Grocery store')" style="width: 100%;">🛒 Grocery</button>
                    <button class="btn btn-secondary" onclick="quickAddErrand('Gas station')" style="width: 100%;">⛽ Gas</button>
                    <button class="btn btn-secondary" onclick="quickAddErrand('Pharmacy')" style="width: 100%;">💊 Pharmacy</button>
                </div>
            </div>
            
            <div id="errandTasks" class="task-list">
                <div class="empty-state">
                    <div class="empty-state-icon">🏪</div>
                    <p>No errands yet!</p>
                </div>
            </div>
            
            <div class="commute-home-indicator" style="display: none; background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 15px; border-radius: 10px; margin-top: 15px;" id="commuteHomeIndicator">
                🚗 You're driving home - good time to make stops!
            </div>
        </div>

        <!-- Visual Time Block Planner -->
        <div class="card">
            <h2>📅 Visual Week Planner</h2>
            <p style="color: var(--text-light); margin-bottom: 15px;">
                Drag tasks onto time blocks to plan your week
            </p>
            <div class="planner-controls" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="showCurrentWeek()">This Week</button>
                <button class="btn btn-secondary" onclick="showNextWeek()">Next Week</button>
            </div>
            
            <div class="planner-grid" id="plannerGrid">
                <!-- Generated dynamically -->
            </div>
            
            <div class="unscheduled-tasks" style="margin-top: 30px; padding: 20px; background: var(--bg-main); border-radius: 12px;">
                <h3 style="margin-bottom: 15px;">📋 Unscheduled Tasks</h3>
                <div id="unscheduledTasksList">
                    <!-- Tasks that haven't been assigned to time blocks -->
                </div>
            </div>
        </div>

        <!-- Templates Section -->
        <div class="card">
            <h2>📋 Weekly Task Templates</h2>
            <p style="color: var(--text-light); margin-bottom: 15px;">
                Create all your weekly coursework with one click
            </p>
            <div class="template-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <!-- Bio template -->
                <div class="template-card" style="background: var(--bg-main); padding: 20px; border-radius: 10px; border: 2px solid var(--border);">
                    <h4 style="color: var(--primary); margin-bottom: 10px;">Bio Weekly Work</h4>
                    <p class="template-info" style="color: var(--text-light); font-size: 0.9em; margin-bottom: 15px;">
                        4 tasks • Due Wednesdays 11:58pm
                    </p>
                    <button class="btn btn-primary" onclick="createTasksFromTemplate('bio-weekly')" style="width: 100%;">
                        ✨ Create Tasks
                    </button>
                </div>
                
                <!-- Beatles template -->
                <div class="template-card" style="background: var(--bg-main); padding: 20px; border-radius: 10px; border: 2px solid var(--border);">
                    <h4 style="color: var(--primary); margin-bottom: 10px;">Beatles Weekly Work</h4>
                    <p class="template-info" style="color: var(--text-light); font-size: 0.9em; margin-bottom: 15px;">
                        4 tasks • Due Sundays 11:58pm
                    </p>
                    <button class="btn btn-primary" onclick="createTasksFromTemplate('beatles-weekly')" style="width: 100%;">
                        ✨ Create Tasks
                    </button>
                </div>
            </div>
            
            <button class="btn btn-secondary" onclick="showCreateTemplateModal()" style="width: 100%;">
                ➕ Create Custom Template
            </button>
        </div>

        <!-- Tasks Section -->
        <div class="card">
            <h2>📋 All Tasks</h2>
            <div class="quick-add">
                <input type="text" id="quickTaskInput" placeholder="Quick add a task... (press Enter)" 
                       onkeypress="if(event.key==='Enter') quickAddTask()">
                <button class="btn btn-primary" onclick="quickAddTask()">Add</button>
            </div>
            <div id="allTasks" class="task-list">
                <div class="empty-state">
                    <div class="empty-state-icon">📝</div>
                    <p>No tasks yet! Use Quick Add or Brain Dump to get started.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>⚙️ Settings</h2>
                <button class="close-modal" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            
            <div class="form-group">
                <label for="workerUrlInput">Cloudflare Worker URL</label>
                <input type="text" id="workerUrlInput" placeholder="https://your-worker.workers.dev/api/claude">
                <p style="color: var(--text-light); font-size: 0.9em; margin-top: 5px;">
                    Your Cloudflare Worker URL for API proxy. See SETUP-INSTRUCTIONS.md Part 1.
                </p>
            </div>
            
            <div class="form-group">
                <label for="clientIdInput">Google OAuth Client ID</label>
                <input type="text" id="clientIdInput" placeholder="123456789-abc.apps.googleusercontent.com">
                <p style="color: var(--text-light); font-size: 0.9em; margin-top: 5px;">
                    Your Google OAuth Client ID for Drive sync. See SETUP-INSTRUCTIONS.md Part 2.
                </p>
            </div>
            
            <div class="form-group">
                <label for="apiKeyInput">Anthropic API Key (Optional)</label>
                <input type="password" id="apiKeyInput" placeholder="sk-ant-...">
                <p style="color: var(--text-light); font-size: 0.9em; margin-top: 5px;">
                    Your API key enables AI features. Stored securely in Google Drive.
                </p>
            </div>
            
            <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
        </div>
    </div>

    <!-- Brain Dump Modal -->
    <div id="brainDumpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🧠 Brain Dump</h2>
                <button class="close-modal" onclick="closeModal('brainDumpModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Dump everything on your mind:</label>
                <textarea id="brainDumpText" placeholder="Write essay for english&#10;Buy groceries&#10;Email professor about extension&#10;...or just type whatever is stressing you out!"></textarea>
            </div>
            <button class="btn btn-primary" onclick="processBrainDump()">✨ Organize My Chaos</button>
        </div>
    </div>

    <!-- Stuck Modal -->
    <div id="stuckModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🤔 Let's Break This Down</h2>
                <button class="close-modal" onclick="closeModal('stuckModal')">&times;</button>
            </div>
            <div id="stuckContent">
                <p>What task are you stuck on?</p>
            </div>
        </div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        // Replace these after deploying your Cloudflare Worker and setting up Google OAuth
        let CLOUDFLARE_WORKER_URL = 'https://controlled-chaos-api.lmdrew.workers.dev/api/claude';
        let GOOGLE_CLIENT_ID = '593850134085-21comnf9tcgcjqp7jnkvum180ksebid7.apps.googleusercontent.com';
        const DRIVE_FILE_NAME = 'controlled-chaos-data.json';

        // ===== GOOGLE DRIVE INTEGRATION =====
        let googleAccessToken = null;
        let driveFileId = null;
        let isOnline = navigator.onLine;
        let pendingChanges = false;
        let gapiInitialized = false;
        let userEmail = null;

        // ===== DATE/TIME UTILITIES =====
        const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        
        function getCurrentDateTime() {
            return new Date();
        }

        function updateCurrentDate() {
            const today = getCurrentDateTime();
            const dayName = days[today.getDay()];
            const dayNum = today.getDate();
            const monthName = months[today.getMonth()];
            const year = today.getFullYear();
            document.getElementById('currentDate').textContent = `${dayName}, ${monthName} ${dayNum}, ${year}`;
        }

        // ===== DEFAULT SCHEDULE =====
        const defaultSchedule = {
            'Monday': [
                { startTime: '07:15', endTime: '07:25', text: 'Wake up & take meds', type: 'personal', location: 'home', editable: false },
                { startTime: '07:25', endTime: '08:00', text: 'Get ready for school', type: 'personal', location: 'home', editable: false },
                { startTime: '08:00', endTime: '08:40', text: 'Commute to school', type: 'free', location: 'commute', editable: false },
                { startTime: '08:40', endTime: '10:30', text: 'FREE TIME at school', type: 'free', location: 'school', editable: true },
                { startTime: '10:35', endTime: '11:55', text: 'US Politics class', type: 'class', location: 'school', editable: false },
                { startTime: '12:00', endTime: '13:00', text: 'Peer Mentor (optional)', type: 'personal', location: 'school', editable: true },
                { startTime: '13:00', endTime: '13:40', text: 'Commute home', type: 'free', location: 'commute', editable: false },
                { startTime: '13:40', endTime: '21:00', text: 'Evening free time', type: 'free', location: 'home', editable: true }
            ],
            'Tuesday': [
                { startTime: '07:15', endTime: '07:25', text: 'Wake up & take meds', type: 'personal', location: 'home', editable: false },
                { startTime: '07:25', endTime: '08:00', text: 'Get ready for school', type: 'personal', location: 'home', editable: false },
                { startTime: '08:00', endTime: '08:40', text: 'Commute to school', type: 'free', location: 'commute', editable: false },
                { startTime: '08:40', endTime: '08:55', text: 'Last-Minute Study for World History', type: 'free', location: 'school', editable: false },
                { startTime: '09:00', endTime: '10:20', text: 'World History class', type: 'class', location: 'school', editable: false },
                { startTime: '10:20', endTime: '11:00', text: 'FREE TIME at school', type: 'free', location: 'school', editable: true },
                { startTime: '11:00', endTime: '11:55', text: 'Peer Mentor (mandatory)', type: 'personal', location: 'school', editable: false },
                { startTime: '12:00', endTime: '13:00', text: 'Hen & Ink Society', type: 'personal', location: 'school', editable: true },
                { startTime: '13:00', endTime: '14:55', text: 'FREE at school', type: 'free', location: 'school', editable: true },
                { startTime: '15:00', endTime: '16:00', text: 'Therapy (at school)', type: 'personal', location: 'school', editable: false },
                { startTime: '16:00', endTime: '16:40', text: 'Commute home', type: 'free', location: 'commute', editable: false },
                { startTime: '16:55', endTime: '21:00', text: 'BIO WORK (all due Wed!)', type: 'free', location: 'home', editable: true }
            ],
            'Wednesday': [
                { startTime: '07:15', endTime: '07:25', text: 'Wake up & take meds', type: 'personal', location: 'home', editable: false },
                { startTime: '07:25', endTime: '08:00', text: 'Get ready for school', type: 'personal', location: 'home', editable: false },
                { startTime: '08:00', endTime: '08:40', text: 'Commute to school', type: 'free', location: 'commute', editable: false },
                { startTime: '08:40', endTime: '10:30', text: 'FREE at school (Beatles discussion)', type: 'free', location: 'school', editable: true },
                { startTime: '10:35', endTime: '11:55', text: 'US Politics class', type: 'class', location: 'school', editable: false },
                { startTime: '12:00', endTime: '13:00', text: 'Peer Mentor (optional)', type: 'personal', location: 'school', editable: true },
                { startTime: '13:00', endTime: '13:55', text: 'Peer Mentor (mandatory)', type: 'personal', location: 'school', editable: false },
                { startTime: '14:00', endTime: '14:35', text: 'Commute home', type: 'free', location: 'commute', editable: false },
                { startTime: '14:35', endTime: '21:00', text: 'Evening free time', type: 'free', location: 'home', editable: true }
            ],
            'Thursday': [
                { startTime: '07:15', endTime: '07:25', text: 'Wake up & take meds', type: 'personal', location: 'home', editable: false },
                { startTime: '07:25', endTime: '08:00', text: 'Get ready for school', type: 'personal', location: 'home', editable: false },
                { startTime: '08:00', endTime: '08:40', text: 'Commute to school', type: 'free', location: 'commute', editable: false },
                { startTime: '08:40', endTime: '08:55', text: 'Last-Minute Study for World History', type: 'free', location: 'school', editable: false },
                { startTime: '09:00', endTime: '10:20', text: 'World History class', type: 'class', location: 'school', editable: false },
                { startTime: '10:20', endTime: '12:00', text: 'FREE at school', type: 'free', location: 'school', editable: true },
                { startTime: '12:00', endTime: '13:00', text: 'Hen & Ink Society', type: 'personal', location: 'school', editable: true },
                { startTime: '13:00', endTime: '16:40', text: 'FREE at school', type: 'free', location: 'school', editable: true },
                { startTime: '16:45', endTime: '19:00', text: 'Bio class', type: 'class', location: 'school', editable: false },
                { startTime: '19:00', endTime: '19:40', text: 'Commute home', type: 'free', location: 'commute', editable: false },
                { startTime: '20:00', endTime: '21:00', text: 'D&D PREP SESSION 1', type: 'protected', location: 'home', editable: false },
                { startTime: '21:00', endTime: '22:00', text: 'Free time / wind down', type: 'free', location: 'home', editable: true }
            ],
            'Friday': [
                { startTime: '07:15', endTime: '07:25', text: 'Wake up & take meds', type: 'personal', location: 'home', editable: false },
                { startTime: '07:25', endTime: '08:00', text: 'Get ready for the day', type: 'personal', location: 'home', editable: false },
                { startTime: '08:00', endTime: '09:00', text: 'Read a Book!', type: 'protected', location: 'home', editable: false },
                { startTime: '09:00', endTime: '12:00', text: 'Flex time - finish weekend work', type: 'free', location: 'school', editable: true },
                { startTime: '12:00', endTime: '14:00', text: 'D&D PREP SESSION 2', type: 'protected', location: 'home', editable: false },
                { startTime: '14:00', endTime: '14:35', text: 'Get ready for work', type: 'personal', location: 'home', editable: false },
                { startTime: '14:35', endTime: '15:00', text: 'Commute to work', type: 'free', location: 'commute', editable: false },
                { startTime: '15:00', endTime: '22:00', text: 'WORK', type: 'work', location: 'work', editable: false },
                { startTime: '22:25', endTime: '22:50', text: 'Commute home', type: 'free', location: 'commute', editable: false }
            ],
            'Saturday': [
                { startTime: '08:00', endTime: '09:00', text: 'Get ready for work', type: 'personal', location: 'home', editable: false },
                { startTime: '09:00', endTime: '10:30', text: 'D&D PREP SESSION 3', type: 'protected', location: 'home', editable: false },
                { startTime: '10:35', endTime: '11:00', text: 'Commute to work', type: 'free', location: 'commute', editable: false },
                { startTime: '11:00', endTime: '22:00', text: 'WORK (long shift!)', type: 'work', location: 'work', editable: false },
                { startTime: '22:25', endTime: '22:50', text: 'Commute home', type: 'free', location: 'commute', editable: false }
            ],
            'Sunday': [
                { startTime: '09:00', endTime: '12:00', text: 'Submit deadlines & review', type: 'free', location: 'home', editable: true },
                { startTime: '12:00', endTime: '16:00', text: 'MAYBE WORK (50/50 chance)', type: 'work', location: 'work', editable: true },
                { startTime: '16:30', endTime: '20:30', text: 'D&D GAME TIME! 🎲', type: 'protected', location: 'home', editable: false }
            ]
        };

        // ===== APP DATA STRUCTURE =====
        let appData = {
            tasks: [],
            deadlines: [],
            schedule: JSON.parse(JSON.stringify(defaultSchedule)),
            templates: [],
            settings: {
                workerUrl: '',
                clientId: '',
                apiKey: ''
            },
            currentLocation: 'home',
            lastSync: null
        };

        // ===== TEMPLATE FUNCTIONS =====
        function getNextDayOfWeek(dayName) {
            const targetDay = days.indexOf(dayName);
            const today = new Date();
            const currentDay = today.getDay();
            
            let daysUntilTarget = targetDay - currentDay;
            if (daysUntilTarget <= 0) {
                daysUntilTarget += 7; // Next week
            }
            
            const targetDate = new Date(today);
            targetDate.setDate(today.getDate() + daysUntilTarget);
            return targetDate;
        }

        function createTasksFromTemplate(templateId) {
            // Initialize templates if not exists
            if (!appData.templates || appData.templates.length === 0) {
                appData.templates = [
                    {
                        id: 'bio-weekly',
                        name: 'Bio Weekly Work',
                        tasks: [
                            { title: 'SmartBook chapter', timeEstimate: 45, energy: 'medium', location: 'anywhere', priority: 'high' },
                            { title: 'Bio assignment', timeEstimate: 30, energy: 'medium', location: 'school', priority: 'high' },
                            { title: 'Bio quiz', timeEstimate: 15, energy: 'low', location: 'phone', priority: 'high' },
                            { title: 'Digital lab', timeEstimate: 60, energy: 'high', location: 'home', priority: 'high' }
                        ],
                        dueDay: 'Wednesday',
                        dueTime: '23:58'
                    },
                    {
                        id: 'beatles-weekly',
                        name: 'Beatles Weekly Work',
                        tasks: [
                            { title: 'Discussion post', timeEstimate: 20, energy: 'medium', location: 'phone', priority: 'medium' },
                            { title: 'Discussion response', timeEstimate: 15, energy: 'low', location: 'phone', priority: 'medium' },
                            { title: 'PowerPoint slides', timeEstimate: 45, energy: 'medium', location: 'home', priority: 'medium' },
                            { title: 'Beatles quiz', timeEstimate: 15, energy: 'low', location: 'phone', priority: 'medium' }
                        ],
                        dueDay: 'Sunday',
                        dueTime: '23:58'
                    }
                ];
            }
            
            const template = appData.templates.find(t => t.id === templateId);
            if (!template) {
                alert('Template not found!');
                return;
            }
            
            const dueDate = getNextDayOfWeek(template.dueDay);
            const [hours, minutes] = template.dueTime.split(':');
            dueDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
            
            template.tasks.forEach(taskTemplate => {
                const newTask = {
                    title: taskTemplate.title,
                    timeEstimate: taskTemplate.timeEstimate,
                    energy: taskTemplate.energy,
                    location: taskTemplate.location,
                    priority: taskTemplate.priority || 'medium',
                    dueDate: dueDate.toISOString().split('T')[0],
                    fromTemplate: template.id
                };
                
                addTask(newTask);
            });
            
            showToast(`✅ Created ${template.tasks.length} tasks from ${template.name}`);
            confetti({
                particleCount: 50,
                spread: 60,
                origin: { y: 0.7 }
            });
        }

        function showCreateTemplateModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Create Custom Template</h2>
                        <button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="form-group">
                        <label>Template Name</label>
                        <input type="text" id="templateName" placeholder="e.g., World History Weekly">
                    </div>
                    <div class="form-group">
                        <label>Due Day</label>
                        <select id="templateDueDay">
                            <option>Monday</option>
                            <option>Tuesday</option>
                            <option>Wednesday</option>
                            <option>Thursday</option>
                            <option>Friday</option>
                            <option>Saturday</option>
                            <option>Sunday</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Due Time</label>
                        <input type="time" id="templateDueTime" value="23:58">
                    </div>
                    <div class="form-group">
                        <label>Number of Tasks</label>
                        <input type="number" id="templateTaskCount" min="1" max="10" value="3">
                    </div>
                    <button class="btn btn-primary" onclick="showTaskCreatorForTemplate(); this.closest('.modal').remove();">
                        Next: Define Tasks
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showTaskCreatorForTemplate() {
            const name = document.getElementById('templateName').value.trim();
            const dueDay = document.getElementById('templateDueDay').value;
            const dueTime = document.getElementById('templateDueTime').value;
            const taskCount = parseInt(document.getElementById('templateTaskCount').value);
            
            if (!name) {
                alert('Please enter a template name!');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            
            let taskFieldsHTML = '';
            for (let i = 0; i < taskCount; i++) {
                taskFieldsHTML += `
                    <div style="background: var(--bg-main); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin-bottom: 10px;">Task ${i + 1}</h4>
                        <div class="form-group">
                            <label>Task Name</label>
                            <input type="text" id="taskName${i}" placeholder="e.g., Read chapter">
                        </div>
                        <div class="form-group">
                            <label>Time Estimate (minutes)</label>
                            <input type="number" id="taskTime${i}" value="30" min="5" max="180">
                        </div>
                        <div class="form-group">
                            <label>Energy Level</label>
                            <select id="taskEnergy${i}">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Location</label>
                            <select id="taskLocation${i}">
                                <option value="anywhere" selected>Anywhere</option>
                                <option value="home">Home</option>
                                <option value="school">School</option>
                                <option value="phone">Phone</option>
                            </select>
                        </div>
                    </div>
                `;
            }
            
            modal.innerHTML = `
                <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h2>Define tasks for ${name}</h2>
                        <button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    ${taskFieldsHTML}
                    <button class="btn btn-primary" onclick="saveCustomTemplate('${name}', '${dueDay}', '${dueTime}', ${taskCount}); this.closest('.modal').remove();">
                        ✅ Create Template
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveCustomTemplate(name, dueDay, dueTime, taskCount) {
            const tasks = [];
            for (let i = 0; i < taskCount; i++) {
                const taskName = document.getElementById(`taskName${i}`).value.trim();
                if (taskName) {
                    tasks.push({
                        title: taskName,
                        timeEstimate: parseInt(document.getElementById(`taskTime${i}`).value),
                        energy: document.getElementById(`taskEnergy${i}`).value,
                        location: document.getElementById(`taskLocation${i}`).value,
                        priority: 'medium'
                    });
                }
            }
            
            if (tasks.length === 0) {
                alert('Please add at least one task!');
                return;
            }
            
            const template = {
                id: 'custom-' + Date.now(),
                name: name,
                tasks: tasks,
                dueDay: dueDay,
                dueTime: dueTime,
                custom: true
            };
            
            if (!appData.templates) {
                appData.templates = [];
            }
            appData.templates.push(template);
            saveData();
            
            showToast(`✅ Template "${name}" created!`);
            
            // Refresh the page to show new template
            location.reload();
        }

        // ===== GOOGLE DRIVE API FUNCTIONS =====
        function initGoogleAPI() {
            gapi.load('client', async () => {
                try {
                    await gapi.client.init({
                        apiKey: '', // Not needed for OAuth flow
                        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
                    });
                    gapiInitialized = true;
                    console.log('Google API initialized');
                } catch (error) {
                    console.error('Error initializing Google API:', error);
                }
            });
        }

        async function handleGoogleSignIn() {
            if (!GOOGLE_CLIENT_ID || GOOGLE_CLIENT_ID === 'YOUR-CLIENT-ID-HERE.apps.googleusercontent.com') {
                alert('Please configure your Google Client ID in Settings first!');
                showSettings();
                return;
            }

            try {
                const client = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CLIENT_ID,
                    scope: 'https://www.googleapis.com/auth/drive.file',
                    callback: async (response) => {
                        if (response.access_token) {
                            googleAccessToken = response.access_token;
                            gapi.client.setToken({ access_token: googleAccessToken });
                            
                            // Get user info
                            const userInfo = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                                headers: { Authorization: `Bearer ${googleAccessToken}` }
                            }).then(r => r.json());
                            
                            userEmail = userInfo.email;
                            
                            // Save token and email to localStorage for persistence
                            localStorage.setItem('googleAccessToken', googleAccessToken);
                            localStorage.setItem('userEmail', userEmail);
                            
                            // Update UI
                            updateSignInUI();
                            
                            // Show toast notification
                            showToast(`✅ Signed in as ${userEmail}`);
                            
                            // Load data from Drive
                            await loadDataFromDrive();
                            updateUI();
                        }
                    }
                });
                client.requestAccessToken();
            } catch (error) {
                console.error('Sign in error:', error);
                alert('Failed to sign in. Please try again.');
            }
        }

        function handleGoogleSignOut() {
            if (googleAccessToken) {
                google.accounts.oauth2.revoke(googleAccessToken);
            }
            
            // Clear stored credentials
            googleAccessToken = null;
            driveFileId = null;
            userEmail = null;
            localStorage.removeItem('googleAccessToken');
            localStorage.removeItem('userEmail');
            
            // Update UI
            document.getElementById('googleSignIn').style.display = 'block';
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('syncIndicator').style.display = 'none';
            
            showToast('👋 Signed out successfully');
        }

        function updateSignInUI() {
            if (googleAccessToken && userEmail) {
                document.getElementById('googleSignIn').style.display = 'none';
                document.getElementById('userInfo').style.display = 'inline-flex';
                document.getElementById('userEmail').textContent = userEmail;
                document.getElementById('syncIndicator').style.display = 'block';
            } else {
                document.getElementById('googleSignIn').style.display = 'block';
                document.getElementById('userInfo').style.display = 'none';
                document.getElementById('syncIndicator').style.display = 'none';
            }
        }

        function showToast(message) {
            // Remove any existing toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            // Create new toast
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // Auto-dismiss after 3 seconds
            setTimeout(() => {
                toast.classList.add('fade-out');
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        async function restoreSession() {
            const savedToken = localStorage.getItem('googleAccessToken');
            const savedEmail = localStorage.getItem('userEmail');
            
            if (savedToken && savedEmail) {
                googleAccessToken = savedToken;
                userEmail = savedEmail;
                
                // Set token for gapi
                if (gapiInitialized) {
                    gapi.client.setToken({ access_token: googleAccessToken });
                }
                
                // Update UI
                updateSignInUI();
                
                // Try to load data from Drive
                try {
                    await loadDataFromDrive();
                    updateUI();
                } catch (error) {
                    console.error('Failed to restore session:', error);
                    // Token might be expired, clear it
                    handleGoogleSignOut();
                }
            }
        }

        async function loadDataFromDrive() {
            if (!googleAccessToken || !gapiInitialized) return;

            try {
                const syncIndicator = document.getElementById('syncIndicator');
                if (syncIndicator) {
                    syncIndicator.textContent = '⏳ Loading from Drive...';
                }
                
                // Search for existing file
                const response = await gapi.client.drive.files.list({
                    q: `name='${DRIVE_FILE_NAME}' and trashed=false`,
                    spaces: 'drive',
                    fields: 'files(id, name)'
                });

                if (response.result.files && response.result.files.length > 0) {
                    driveFileId = response.result.files[0].id;
                    
                    // Download file content
                    const fileResponse = await gapi.client.drive.files.get({
                        fileId: driveFileId,
                        alt: 'media'
                    });
                    
                    appData = JSON.parse(fileResponse.body);
                    appData.lastSync = new Date().toISOString();
                    
                    // Apply settings
                    if (appData.settings.workerUrl) CLOUDFLARE_WORKER_URL = appData.settings.workerUrl;
                    if (appData.settings.clientId) GOOGLE_CLIENT_ID = appData.settings.clientId;
                    
                    const syncIndicator = document.getElementById('syncIndicator');
                    if (syncIndicator) {
                        syncIndicator.textContent = '☁️ Synced with Google Drive';
                    }
                    console.log('Data loaded from Drive');
                } else {
                    // No file exists, create one
                    await saveDataToDrive();
                }
            } catch (error) {
                console.error('Error loading from Drive:', error);
                const syncIndicator = document.getElementById('syncIndicator');
                if (syncIndicator) {
                    syncIndicator.textContent = '⚠️ Sync error';
                }
                // If error is auth-related, sign out
                if (error.status === 401 || error.status === 403) {
                    handleGoogleSignOut();
                }
            }
        }

        async function saveDataToDrive() {
            if (!googleAccessToken || !gapiInitialized) {
                pendingChanges = true;
                return;
            }

            try {
                const syncIndicator = document.getElementById('syncIndicator');
                if (syncIndicator) {
                    syncIndicator.textContent = '⏳ Saving to Drive...';
                }
                
                appData.lastSync = new Date().toISOString();
                const content = JSON.stringify(appData, null, 2);
                const blob = new Blob([content], { type: 'application/json' });

                const metadata = {
                    name: DRIVE_FILE_NAME,
                    mimeType: 'application/json'
                };

                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', blob);

                const method = driveFileId ? 'PATCH' : 'POST';
                const url = driveFileId 
                    ? `https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=multipart`
                    : 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        Authorization: `Bearer ${googleAccessToken}`
                    },
                    body: form
                });

                const result = await response.json();
                if (result.id) {
                    driveFileId = result.id;
                    pendingChanges = false;
                    const syncIndicator = document.getElementById('syncIndicator');
                    if (syncIndicator) {
                        syncIndicator.textContent = '☁️ Synced with Google Drive';
                    }
                    console.log('Data saved to Drive');
                }
            } catch (error) {
                console.error('Error saving to Drive:', error);
                const syncIndicator = document.getElementById('syncIndicator');
                if (syncIndicator) {
                    syncIndicator.textContent = '⚠️ Sync error';
                }
                pendingChanges = true;
            }
        }

        // Auto-save on changes
        function saveData() {
            saveDataToDrive();
        }

        // Force sync current defaultSchedule to Drive (overwrites stored schedule)
        async function syncDefaultScheduleToDrive() {
            if (!googleAccessToken || !gapiInitialized) {
                alert('Please sign in with Google first to sync the schedule!');
                return;
            }

            // Check if we've already synced this version
            const SCHEDULE_VERSION = '2025-01-09-v1'; // Update this when schedule changes
            const lastSyncedVersion = localStorage.getItem('lastScheduleSyncVersion');
            
            if (lastSyncedVersion === SCHEDULE_VERSION) {
                console.log('Schedule already synced to Drive (version: ' + SCHEDULE_VERSION + ')');
                return;
            }

            try {
                console.log('Syncing default schedule to Drive...');
                
                // Update appData.schedule with current defaultSchedule
                appData.schedule = JSON.parse(JSON.stringify(defaultSchedule));
                
                // Force save to Drive
                await saveDataToDrive();
                
                // Mark this version as synced
                localStorage.setItem('lastScheduleSyncVersion', SCHEDULE_VERSION);
                
                console.log('Default schedule synced to Drive successfully!');
                showToast('✅ Schedule synced to Google Drive');
                
                // Update UI to reflect changes
                updateUI();
            } catch (error) {
                console.error('Error syncing schedule to Drive:', error);
                alert('Failed to sync schedule to Drive. Please try again.');
            }
        }

        // ===== DEADLINE MANAGEMENT =====
        function showAddDeadlineModal() {
            const quickInput = document.getElementById('quickDeadlineInput');
            const quickText = quickInput.value.trim();
            
            // Create a simple prompt modal
            const title = quickText || prompt('What\'s the deadline for?');
            if (!title) return;
            
            const dateStr = prompt('When is it due? (YYYY-MM-DD or MM/DD)');
            if (!dateStr) return;
            
            // Parse date
            let dueDate;
            if (dateStr.includes('-')) {
                dueDate = dateStr; // Already in YYYY-MM-DD format
            } else {
                // Convert MM/DD to YYYY-MM-DD
                const [month, day] = dateStr.split('/');
                const year = new Date().getFullYear();
                dueDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            }
            
            addDeadline(title, dueDate);
            quickInput.value = '';
        }

        function addDeadline(title, dueDate) {
            const deadline = {
                id: Date.now().toString(),
                title: title,
                dueDate: dueDate,
                createdAt: new Date().toISOString(),
                completed: false
            };
            
            appData.deadlines.push(deadline);
            saveData();
            renderDeadlines();
            
            // Show the "Create tasks?" modal
            afterDeadlineCreated(deadline);
        }

        function afterDeadlineCreated(deadline) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>✨ Create tasks for this deadline?</h2>
                        <button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <p style="margin-bottom: 20px;">Would you like to create tasks for <strong>${deadline.title}</strong>?</p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="autoCreateTasksWithAI('${deadline.id}'); this.closest('.modal').remove();">
                            ✨ Auto-create (AI)
                        </button>
                        <button class="btn btn-secondary" onclick="showQuickTaskCreator('${deadline.id}'); this.closest('.modal').remove();">
                            📝 Quick setup
                        </button>
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove();">
                            Skip for now
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function autoCreateTasksWithAI(deadlineId) {
            const deadline = appData.deadlines.find(d => d.id === deadlineId);
            if (!deadline) return;
            
            // Show loading state
            const loadingModal = document.createElement('div');
            loadingModal.className = 'modal active';
            loadingModal.innerHTML = `
                <div class="modal-content">
                    <h2>✨ Creating tasks...</h2>
                    <p>AI is breaking down "${deadline.title}" into manageable tasks...</p>
                </div>
            `;
            document.body.appendChild(loadingModal);
            
            try {
                const daysUntil = Math.ceil((new Date(deadline.dueDate) - new Date()) / (1000 * 60 * 60 * 24));
                
                const systemPrompt = `You are an ADHD-friendly task planner. Break down the deadline into 2-4 concrete, actionable tasks. Consider the time available (${daysUntil} days). For each task, determine:
- title (clear, specific action)
- energy level (high/medium/low)
- location (home/school/work/phone/anywhere)
- timeEstimate in minutes (realistic)

Return ONLY valid JSON array, no other text:
[{"title": "...", "energy": "...", "location": "...", "timeEstimate": 30}]`;

                const response = await callClaudeAPI([{
                    role: 'user',
                    content: `Deadline: ${deadline.title}\nDue: ${deadline.dueDate}\nDays until due: ${daysUntil}`
                }], systemPrompt);

                const tasks = JSON.parse(response);
                tasks.forEach(task => {
                    task.parentDeadline = deadlineId;
                    task.dueDate = deadline.dueDate;
                    addTask(task);
                });

                loadingModal.remove();
                
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
                
                alert(`✅ Created ${tasks.length} tasks for "${deadline.title}"!`);
            } catch (error) {
                console.error('Auto-create tasks error:', error);
                loadingModal.remove();
                alert('Failed to create tasks. Check your API configuration or try Quick setup instead.');
            }
        }

        function showQuickTaskCreator(deadlineId) {
            const deadline = appData.deadlines.find(d => d.id === deadlineId);
            if (!deadline) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>📝 Quick Task Setup</h2>
                        <button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <p style="margin-bottom: 15px;">Create up to 3 tasks for <strong>${deadline.title}</strong>:</p>
                    
                    <div class="form-group">
                        <label>Task 1</label>
                        <input type="text" id="quickTask1" placeholder="e.g., Research topic">
                    </div>
                    
                    <div class="form-group">
                        <label>Task 2 (optional)</label>
                        <input type="text" id="quickTask2" placeholder="e.g., Write outline">
                    </div>
                    
                    <div class="form-group">
                        <label>Task 3 (optional)</label>
                        <input type="text" id="quickTask3" placeholder="e.g., Final review">
                    </div>
                    
                    <button class="btn btn-primary" onclick="saveQuickTasks('${deadlineId}'); this.closest('.modal').remove();">
                        ✅ Create Tasks
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Focus first input
            setTimeout(() => document.getElementById('quickTask1').focus(), 100);
        }

        function saveQuickTasks(deadlineId) {
            const deadline = appData.deadlines.find(d => d.id === deadlineId);
            if (!deadline) return;
            
            const task1 = document.getElementById('quickTask1').value.trim();
            const task2 = document.getElementById('quickTask2').value.trim();
            const task3 = document.getElementById('quickTask3').value.trim();
            
            let count = 0;
            [task1, task2, task3].forEach(title => {
                if (title) {
                    addTask({
                        title: title,
                        energy: 'medium',
                        location: 'anywhere',
                        timeEstimate: 30,
                        parentDeadline: deadlineId,
                        dueDate: deadline.dueDate
                    });
                    count++;
                }
            });
            
            if (count > 0) {
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
                alert(`✅ Created ${count} task${count > 1 ? 's' : ''} for "${deadline.title}"!`);
            }
        }

        function toggleDeadline(deadlineId) {
            const deadline = appData.deadlines.find(d => d.id === deadlineId);
            if (deadline) {
                deadline.completed = !deadline.completed;
                
                // Also complete all related tasks
                if (deadline.completed) {
                    appData.tasks.forEach(task => {
                        if (task.parentDeadline === deadlineId) {
                            task.completed = true;
                        }
                    });
                    
                    confetti({
                        particleCount: 150,
                        spread: 100,
                        origin: { y: 0.6 }
                    });
                }
                
                saveData();
                renderDeadlines();
                renderTasks();
            }
        }

        function deleteDeadline(deadlineId) {
            if (confirm('Delete this deadline and all related tasks?')) {
                appData.deadlines = appData.deadlines.filter(d => d.id !== deadlineId);
                appData.tasks = appData.tasks.filter(t => t.parentDeadline !== deadlineId);
                saveData();
                renderDeadlines();
                renderTasks();
            }
        }

        function calculateAvailableTime(deadline) {
            const now = new Date();
            const dueDate = new Date(deadline.dueDate);
            
            // Find all free blocks between now and deadline
            const freeBlocks = [];
            let currentDate = new Date(now);
            
            while (currentDate <= dueDate) {
                const dayName = days[currentDate.getDay()];
                const daySchedule = appData.schedule[dayName] || [];
                const currentMinutes = currentDate.getTime() === now.getTime() ? now.getHours() * 60 + now.getMinutes() : 0;
                
                daySchedule.forEach(block => {
                    if (block.type === 'free' && !block.protected && block.editable) {
                        const startMinutes = parseTime(block.startTime);
                        const endMinutes = parseTime(block.endTime);
                        
                        // Skip blocks that have already passed today
                        if (currentDate.toDateString() === now.toDateString() && endMinutes <= currentMinutes) {
                            return;
                        }
                        
                        const duration = endMinutes - startMinutes;
                        
                        freeBlocks.push({
                            date: currentDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }),
                            time: `${formatTime(block.startTime)}-${formatTime(block.endTime)}`,
                            duration: duration,
                            location: block.location
                        });
                    }
                });
                
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // Calculate total available hours
            const totalMinutes = freeBlocks.reduce((sum, block) => sum + block.duration, 0);
            const totalHours = Math.floor(totalMinutes / 60);
            const remainingMinutes = totalMinutes % 60;
            
            return {
                freeBlocks,
                totalHours,
                remainingMinutes,
                blockCount: freeBlocks.length,
                totalMinutes
            };
        }

        function renderDeadlines() {
            const container = document.getElementById('allDeadlines');
            const activeDeadlines = appData.deadlines.filter(d => !d.completed);
            
            if (activeDeadlines.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📅</div>
                        <p>No deadlines yet!</p>
                    </div>
                `;
                return;
            }
            
            // Sort by due date
            activeDeadlines.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
            
            container.innerHTML = activeDeadlines.map(deadline => {
                const dueDate = new Date(deadline.dueDate);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const daysUntil = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                
                let urgencyColor = 'var(--success)';
                let urgencyText = `${daysUntil} days`;
                
                if (daysUntil < 0) {
                    urgencyColor = 'var(--danger)';
                    urgencyText = 'OVERDUE';
                } else if (daysUntil === 0) {
                    urgencyColor = 'var(--danger)';
                    urgencyText = 'TODAY';
                } else if (daysUntil === 1) {
                    urgencyColor = 'var(--warning)';
                    urgencyText = 'Tomorrow';
                } else if (daysUntil <= 3) {
                    urgencyColor = 'var(--warning)';
                }
                
                const relatedTasks = appData.tasks.filter(t => t.parentDeadline === deadline.id);
                const completedTasks = relatedTasks.filter(t => t.completed).length;
                const incompleteTasks = relatedTasks.filter(t => !t.completed);
                
                // Calculate available time and work needed
                const timeAvailable = calculateAvailableTime(deadline);
                const totalWorkMinutes = incompleteTasks.reduce((sum, t) => sum + (t.timeEstimate || 30), 0);
                const totalWorkHours = Math.floor(totalWorkMinutes / 60);
                const workMinutesRemainder = totalWorkMinutes % 60;
                
                // Determine if achievable
                const isAchievable = timeAvailable.totalMinutes >= totalWorkMinutes;
                const statusIcon = isAchievable ? '✅' : '⚠️';
                const cardClass = isAchievable ? '' : 'tight-deadline';
                
                return `
                    <div class="task-item ${cardClass}" style="border-left: 4px solid ${urgencyColor}; ${!isAchievable && incompleteTasks.length > 0 ? 'background: linear-gradient(to right, #fff5f0, white);' : ''}">
                        <input type="checkbox" class="task-checkbox" 
                               onchange="toggleDeadline('${deadline.id}')" ${deadline.completed ? 'checked' : ''}>
                        <div class="task-content" style="flex: 1;">
                            <div class="task-title">${deadline.title}</div>
                            <div class="task-meta" style="flex-direction: column; gap: 8px; align-items: flex-start;">
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <span style="background: ${urgencyColor}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 600;">
                                        📅 ${urgencyText}
                                    </span>
                                    ${relatedTasks.length > 0 ? `
                                        <span style="background: var(--border); padding: 4px 12px; border-radius: 20px; font-size: 0.85em;">
                                            ${completedTasks}/${relatedTasks.length} tasks done
                                        </span>
                                    ` : ''}
                                </div>
                                ${incompleteTasks.length > 0 && daysUntil > 0 ? `
                                    <div style="font-size: 0.85em; color: var(--text-light); margin-top: 5px;">
                                        ${statusIcon} <strong>${timeAvailable.blockCount} free blocks</strong> = ${timeAvailable.totalHours}h ${timeAvailable.remainingMinutes}m available
                                        <br>
                                        📝 ${totalWorkHours}h ${workMinutesRemainder}m of work needed
                                        ${!isAchievable ? `
                                            <br>
                                            <span style="color: var(--warning); font-weight: 600;">⚠️ Tight schedule! Consider moving tasks or extending deadline.</span>
                                        ` : ''}
                                    </div>
                                    ${timeAvailable.freeBlocks.length > 0 ? `
                                        <details style="margin-top: 8px; font-size: 0.85em;">
                                            <summary style="cursor: pointer; color: var(--primary); font-weight: 500;">
                                                View ${timeAvailable.freeBlocks.length} available time blocks
                                            </summary>
                                            <div style="margin-top: 8px; padding: 10px; background: var(--bg-main); border-radius: 6px;">
                                                ${timeAvailable.freeBlocks.slice(0, 5).map(block => `
                                                    <div style="padding: 4px 0; color: var(--text-light);">
                                                        • ${block.date}: ${block.time} (${Math.floor(block.duration / 60)}h ${block.duration % 60}m) at ${block.location}
                                                    </div>
                                                `).join('')}
                                                ${timeAvailable.freeBlocks.length > 5 ? `
                                                    <div style="padding: 4px 0; color: var(--text-light); font-style: italic;">
                                                        + ${timeAvailable.freeBlocks.length - 5} more blocks
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </details>
                                    ` : ''}
                                ` : ''}
                            </div>
                        </div>
                        <div class="task-actions">
                            ${daysUntil > 3 ? `
                                <button class="task-btn" onclick="breakDownDeadline('${deadline.id}')" title="Break down into smaller tasks">
                                    🔨 Break Down
                                </button>
                            ` : ''}
                            <button class="task-btn" onclick="deleteDeadline('${deadline.id}')">🗑️</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Feature 4: Auto-Break-Down Deadlines
        function getAvailableFreeBlocks(startDate, endDate) {
            const blocks = [];
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            // Iterate through each day until deadline
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const dayName = days[d.getDay()];
                const daySchedule = appData.schedule[dayName] || [];
                
                daySchedule.forEach(block => {
                    if (block.type === 'free' && !block.protected) {
                        const startMinutes = parseTime(block.startTime);
                        const endMinutes = parseTime(block.endTime);
                        const duration = endMinutes - startMinutes;
                        
                        blocks.push({
                            day: dayName,
                            date: new Date(d).toLocaleDateString(),
                            time: `${formatTime(block.startTime)}-${formatTime(block.endTime)}`,
                            duration: duration,
                            location: block.location
                        });
                    }
                });
            }
            
            return blocks;
        }

        async function breakDownDeadline(deadlineId) {
            const deadline = appData.deadlines.find(d => d.id === deadlineId);
            if (!deadline) return;
            
            // Check if already broken down
            if (deadline.brokenDown) {
                if (confirm('This deadline has already been broken down. Break it down again?')) {
                    // Remove old subtasks
                    appData.tasks = appData.tasks.filter(t => t.parentDeadline !== deadlineId);
                } else {
                    return;
                }
            }
            
            // Show loading modal
            const loadingModal = document.createElement('div');
            loadingModal.className = 'modal active';
            loadingModal.innerHTML = `
                <div class="modal-content">
                    <h2>🔨 Breaking down deadline...</h2>
                    <p>AI is analyzing your schedule and creating a plan for "${deadline.title}"...</p>
                </div>
            `;
            document.body.appendChild(loadingModal);
            
            try {
                const now = new Date();
                const dueDate = new Date(deadline.dueDate);
                const availableBlocks = getAvailableFreeBlocks(now, dueDate);
                
                if (availableBlocks.length === 0) {
                    loadingModal.remove();
                    alert('No free time blocks found before the deadline. Consider adjusting your schedule or deadline date.');
                    return;
                }
                
                const blocksText = availableBlocks.slice(0, 10).map(b => 
                    `- ${b.day} ${b.time}: ${b.duration} minutes at ${b.location}`
                ).join('\n');
                
                const systemPrompt = `You are an ADHD-friendly task planner. Break down the deadline into 3-6 specific, actionable subtasks.

Deadline: ${deadline.title}
Due: ${deadline.dueDate}

Available time blocks before deadline:
${blocksText}

Create subtasks that:
1. Are concrete and completable (not vague like "work on essay")
2. Have realistic time estimates (15-90 minutes each)
3. Can fit in the available time blocks
4. Build toward completing the deadline
5. Include buffer/review time at the end

Respond ONLY with valid JSON in this exact format (no markdown, no backticks):
{
  "subtasks": [
    {
      "title": "specific task name",
      "timeEstimate": 45,
      "energy": "medium",
      "location": "school",
      "suggestedBlock": "Monday 8:40 AM-10:30 AM at school",
      "reasoning": "why this fits here"
    }
  ]
}`;

                const response = await callClaudeAPI([{
                    role: 'user',
                    content: `Break down this deadline into subtasks that fit my schedule.`
                }], systemPrompt);

                const data = JSON.parse(response);
                
                // Create tasks from subtasks
                data.subtasks.forEach(subtask => {
                    addTask({
                        title: subtask.title,
                        energy: subtask.energy,
                        location: subtask.location,
                        timeEstimate: subtask.timeEstimate,
                        parentDeadline: deadlineId,
                        dueDate: deadline.dueDate,
                        suggestedBlock: subtask.suggestedBlock,
                        reasoning: subtask.reasoning
                    });
                });
                
                // Mark deadline as broken down
                deadline.brokenDown = true;
                saveData();
                renderDeadlines();
                
                loadingModal.remove();
                
                // Show success modal with timeline
                const successModal = document.createElement('div');
                successModal.className = 'modal active';
                successModal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>✅ Deadline Broken Down!</h2>
                            <button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button>
                        </div>
                        <p style="margin-bottom: 20px;">Created ${data.subtasks.length} tasks for <strong>${deadline.title}</strong>:</p>
                        <div style="background: var(--bg-main); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            ${data.subtasks.map((subtask, i) => `
                                <div style="margin: 15px 0; padding: 15px; background: white; border-radius: 8px; border-left: 4px solid var(--primary);">
                                    <div style="font-weight: 600; margin-bottom: 5px;">
                                        ${i + 1}. ${subtask.title}
                                    </div>
                                    <div style="font-size: 0.9em; color: var(--text-light); margin-bottom: 5px;">
                                        ⏱️ ${subtask.timeEstimate} min | 📍 ${subtask.location} | ⚡ ${subtask.energy}
                                    </div>
                                    <div style="font-size: 0.85em; color: var(--primary); margin-bottom: 5px;">
                                        📅 Suggested: ${subtask.suggestedBlock}
                                    </div>
                                    <div style="font-size: 0.85em; color: var(--text-light); font-style: italic;">
                                        ${subtask.reasoning}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <button class="btn btn-primary" onclick="this.closest('.modal').remove()">
                            Got it! Let's do this 🚀
                        </button>
                    </div>
                `;
                document.body.appendChild(successModal);
                
                confetti({
                    particleCount: 150,
                    spread: 100,
                    origin: { y: 0.6 }
                });
                
            } catch (error) {
                console.error('Break down deadline error:', error);
                loadingModal.remove();
                alert('Failed to break down deadline. Check your API configuration and try again.');
            }
        }

        // ===== TASK MANAGEMENT =====
        function addTask(task) {
            task.id = Date.now().toString();
            task.completed = false;
            task.createdAt = new Date().toISOString();
            appData.tasks.push(task);
            saveData();
            renderTasks();
        }

        function toggleTask(taskId) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (task) {
                task.completed = !task.completed;
                if (task.completed) {
                    confetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { y: 0.6 }
                    });
                }
                saveData();
                renderTasks();
                updateWhatNow();
            }
        }

        function deleteTask(taskId) {
            if (confirm('Delete this task?')) {
                appData.tasks = appData.tasks.filter(t => t.id !== taskId);
                saveData();
                renderTasks();
                updateWhatNow();
            }
        }

        function quickAddTask() {
            const input = document.getElementById('quickTaskInput');
            const text = input.value.trim();
            if (text) {
                addTask({
                    title: text,
                    energy: 'medium',
                    location: 'anywhere',
                    timeEstimate: 30
                });
                input.value = '';
            }
        }

        // Quick add errand function
        function quickAddErrand(errandType) {
            const errandDefaults = {
                'Post office': {
                    title: 'Stop at post office',
                    timeEstimate: 10,
                    energy: 'low'
                },
                'Grocery store': {
                    title: 'Quick grocery run',
                    timeEstimate: 20,
                    energy: 'medium'
                },
                'Gas station': {
                    title: 'Fill up gas tank',
                    timeEstimate: 10,
                    energy: 'low'
                },
                'Pharmacy': {
                    title: 'Pick up prescription',
                    timeEstimate: 10,
                    energy: 'low'
                }
            };
            
            const defaults = errandDefaults[errandType];
            
            const newTask = {
                title: defaults.title,
                timeEstimate: defaults.timeEstimate,
                energy: defaults.energy,
                location: 'errands',
                priority: 'medium'
            };
            
            addTask(newTask);
            showToast(`✅ Added: ${defaults.title}`);
        }

        function getErrandTasks() {
            return appData.tasks.filter(task => 
                !task.completed && 
                task.location === 'errands'
            ).sort((a, b) => {
                // Prioritize by due date, then priority
                if (a.dueDate && b.dueDate) {
                    return new Date(a.dueDate) - new Date(b.dueDate);
                }
                const priorityOrder = { high: 3, medium: 2, low: 1 };
                const aPriority = priorityOrder[a.priority] || 2;
                const bPriority = priorityOrder[b.priority] || 2;
                return bPriority - aPriority;
            });
        }

        function isCommuteHomeBlock() {
            const now = getCurrentDateTime();
            const dayName = days[now.getDay()];
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            
            const commuteHomeBlocks = [
                { day: 'Monday', startTime: '13:00', endTime: '13:40' },
                { day: 'Tuesday', startTime: '16:00', endTime: '16:40' },
                { day: 'Wednesday', startTime: '14:00', endTime: '14:35' },
                { day: 'Friday', startTime: '22:25', endTime: '22:50' },
                { day: 'Saturday', startTime: '22:25', endTime: '22:50' }
            ];
            
            return commuteHomeBlocks.some(block => {
                if (block.day !== dayName) return false;
                const startMinutes = parseTime(block.startTime);
                const endMinutes = parseTime(block.endTime);
                return currentMinutes >= startMinutes && currentMinutes < endMinutes;
            });
        }

        function renderErrandTasks() {
            const container = document.getElementById('errandTasks');
            const errandTasks = getErrandTasks();
            const indicator = document.getElementById('commuteHomeIndicator');
            
            // Update commute home indicator
            if (isCommuteHomeBlock()) {
                indicator.style.display = 'block';
            } else {
                indicator.style.display = 'none';
            }
            
            if (errandTasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🏪</div>
                        <p>No errands yet!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = errandTasks.map(task => `
                <div class="task-item">
                    <input type="checkbox" class="task-checkbox" 
                           onchange="toggleTask('${task.id}')" ${task.completed ? 'checked' : ''}>
                    <div class="task-content">
                        <div class="task-title">${task.title}</div>
                        <div class="task-meta">
                            <span class="energy-badge energy-${task.energy}">${task.energy}</span>
                            <span class="location-badge">🏪 ${task.location}</span>
                            ${task.timeEstimate ? `<span class="time-estimate">⏱️ ${task.timeEstimate}min</span>` : ''}
                        </div>
                    </div>
                    <div class="task-actions">
                        <button class="task-btn" onclick="deleteTask('${task.id}')">🗑️</button>
                    </div>
                </div>
            `).join('');
        }

        // Migration function for existing 'phone' tasks
        function migratePhoneToErrands() {
            const migrationKey = 'phone_to_errands_migration_done';
            
            if (localStorage.getItem(migrationKey)) {
                return; // Already migrated
            }
            
            let migratedCount = 0;
            
            appData.tasks.forEach(task => {
                if (task.location === 'phone') {
                    // Analyze the task to determine if it's actually an errand
                    const isActualErrand = 
                        task.title.toLowerCase().includes('post office') ||
                        task.title.toLowerCase().includes('grocery') ||
                        task.title.toLowerCase().includes('gas') ||
                        task.title.toLowerCase().includes('store') ||
                        task.title.toLowerCase().includes('pharmacy') ||
                        task.title.toLowerCase().includes('pick up') ||
                        task.title.toLowerCase().includes('drop off') ||
                        task.title.toLowerCase().includes('errand');
                    
                    if (isActualErrand) {
                        task.location = 'errands';
                    } else {
                        // These were probably meant to be phone tasks but are unsafe
                        // Change to 'anywhere' since they can do them when NOT driving
                        task.location = 'anywhere';
                    }
                    
                    migratedCount++;
                }
            });
            
            if (migratedCount > 0) {
                saveData();
                showToast(`📝 Updated ${migratedCount} tasks for safety`);
            }
            
            localStorage.setItem(migrationKey, 'true');
        }

        function renderTasks() {
            const container = document.getElementById('allTasks');
            const incompleteTasks = appData.tasks.filter(t => !t.completed);
            
            if (incompleteTasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📝</div>
                        <p>No tasks yet! Use Quick Add or Brain Dump to get started.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = incompleteTasks.map(task => `
                <div class="task-item">
                    <input type="checkbox" class="task-checkbox" 
                           onchange="toggleTask('${task.id}')" ${task.completed ? 'checked' : ''}>
                    <div class="task-content">
                        <div class="task-title">${task.title}</div>
                        <div class="task-meta">
                            <span class="energy-badge energy-${task.energy}">${task.energy}</span>
                            <span class="location-badge">📍 ${task.location}</span>
                            ${task.timeEstimate ? `<span class="time-estimate">⏱️ ${task.timeEstimate}min</span>` : ''}
                        </div>
                    </div>
                    <div class="task-actions">
                        <button class="task-btn" onclick="deleteTask('${task.id}')">🗑️</button>
                    </div>
                </div>
            `).join('');
            
            // Also render errand tasks
            renderErrandTasks();
        }

        // ===== SCHEDULE FUNCTIONS =====
        function parseTime(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function formatTime(timeStr) {
            const [hours, minutes] = timeStr.split(':');
            const h = parseInt(hours);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const displayHour = h === 0 ? 12 : h > 12 ? h - 12 : h;
            return `${displayHour}:${minutes} ${ampm}`;
        }

        function getCurrentBlock() {
            const now = getCurrentDateTime();
            const dayName = days[now.getDay()];
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            
            const todaySchedule = appData.schedule[dayName] || [];
            
            for (let block of todaySchedule) {
                const startMinutes = parseTime(block.startTime);
                const endMinutes = parseTime(block.endTime);
                
                if (currentMinutes >= startMinutes && currentMinutes < endMinutes) {
                    return {
                        ...block,
                        minutesRemaining: endMinutes - currentMinutes
                    };
                }
            }
            
            return null;
        }

        function renderSchedule() {
            const now = getCurrentDateTime();
            const dayName = days[now.getDay()];
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            
            const currentBlock = getCurrentBlock();
            const currentBlockDiv = document.getElementById('currentBlock');
            
            if (currentBlock) {
                currentBlockDiv.style.display = 'block';
                document.getElementById('currentBlockText').textContent = currentBlock.text;
                const hours = Math.floor(currentBlock.minutesRemaining / 60);
                const mins = currentBlock.minutesRemaining % 60;
                document.getElementById('timeRemaining').textContent = 
                    `⏱️ ${hours}h ${mins}m remaining`;
            } else {
                currentBlockDiv.style.display = 'none';
            }
            
            const scheduleView = document.getElementById('scheduleView');
            const todaySchedule = appData.schedule[dayName] || [];
            
            scheduleView.innerHTML = `
                <div class="schedule-day">
                    <h3>${dayName}</h3>
                    ${todaySchedule.map(block => {
                        const startMinutes = parseTime(block.startTime);
                        const endMinutes = parseTime(block.endTime);
                        const isCurrent = currentMinutes >= startMinutes && currentMinutes < endMinutes;
                        
                        return `
                            <div class="schedule-item ${block.type} ${isCurrent ? 'current' : ''}">
                                <span>
                                    ${block.type === 'protected' ? '<span class="lock-icon">🔒</span> ' : ''}
                                    ${formatTime(block.startTime)} - ${formatTime(block.endTime)}
                                </span>
                                <span>${block.text}</span>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // ===== WHAT NOW LOGIC =====
        function setLocation(location) {
            appData.currentLocation = location;
            document.querySelectorAll('.location-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.location === location);
            });
            updateWhatNow();
            saveData();
        }

        function getCurrentEnergy() {
            const hour = getCurrentDateTime().getHours();
            if (hour >= 6 && hour < 12) return 'high';
            if (hour >= 12 && hour < 17) return 'medium';
            return 'low';
        }

        function updateWhatNow() {
            const currentBlock = getCurrentBlock();
            const currentEnergy = getCurrentEnergy();
            const location = appData.currentLocation;
            
            const contextInfo = document.getElementById('contextInfo');
            const contextTitle = document.getElementById('contextTitle');
            const contextDetails = document.getElementById('contextDetails');
            
            contextInfo.style.display = 'block';
            contextTitle.textContent = `📍 ${location.charAt(0).toUpperCase() + location.slice(1)} | ⚡ ${currentEnergy} energy`;
            
            if (currentBlock) {
                if (currentBlock.type === 'protected') {
                    contextDetails.textContent = `🔒 Protected time: ${currentBlock.text}`;
                } else if (currentBlock.type === 'class') {
                    contextDetails.textContent = `📚 In class: ${currentBlock.text}`;
                } else {
                    contextDetails.textContent = `Current block: ${currentBlock.text}`;
                }
            } else {
                contextDetails.textContent = 'No scheduled block right now';
            }
            
            const suggestionCard = document.getElementById('suggestionCard');
            
            // SAFETY: Special handling for commute location - ONLY show errands during commute home
            if (location === 'commute') {
                const errandTasks = getErrandTasks();
                const isCommuteHome = isCommuteHomeBlock();
                
                if (isCommuteHome && errandTasks.length > 0) {
                    const task = errandTasks[0];
                    
                    suggestionCard.innerHTML = `
                        <div class="suggestion-card">
                            <h3>🏪 Errand Suggestion</h3>
                            <p style="font-size: 1.2em; font-weight: 600; margin: 10px 0;">${task.title}</p>
                            <div style="display: flex; gap: 10px; margin: 15px 0;">
                                <span class="energy-badge energy-${task.energy}">${task.energy}</span>
                                <span class="location-badge">🏪 ${task.location}</span>
                                ${task.timeEstimate ? `<span class="time-estimate">⏱️ ${task.timeEstimate}min</span>` : ''}
                            </div>
                            <p class="suggestion-reason">
                                🚗 You're driving home - good time to make stops!
                            </p>
                            <button class="btn btn-success" onclick="toggleTask('${task.id}')" style="margin-top: 15px;">
                                ✅ Mark Complete
                            </button>
                        </div>
                    `;
                    suggestionCard.style.display = 'block';
                    return;
                } else {
                    suggestionCard.innerHTML = `
                        <div class="suggestion-card">
                            <h3>🚗 Safe Driving</h3>
                            <p>Focus on the road! ${isCommuteHome ? 'Add errands with 🏪 if you need to make stops.' : 'Enjoy your commute safely.'}</p>
                            ${isCommuteHome ? `
                                <button class="btn btn-primary" onclick="showQuickAdd()" style="margin-top: 15px;">
                                    ➕ Add Errand
                                </button>
                            ` : ''}
                        </div>
                    `;
                    suggestionCard.style.display = 'block';
                    return;
                }
            }
            
            // Find best task for other locations
            const availableTasks = appData.tasks.filter(t => 
                !t.completed && 
                (t.location === 'anywhere' || t.location === location) &&
                (t.energy === currentEnergy || t.energy === 'medium')
            );
            
            if (currentBlock && currentBlock.type === 'protected') {
                suggestionCard.innerHTML = `
                    <div class="suggestion-card">
                        <h3>🔒 Protected Time</h3>
                        <p>This is your ${currentBlock.text}. Enjoy it guilt-free!</p>
                        <p class="suggestion-reason">Protected blocks are sacred - no tasks allowed.</p>
                    </div>
                `;
                suggestionCard.style.display = 'block';
            } else if (availableTasks.length > 0) {
                const task = availableTasks[0];
                suggestionCard.innerHTML = `
                    <div class="suggestion-card">
                        <h3>✨ Suggested Task</h3>
                        <p style="font-size: 1.2em; font-weight: 600; margin: 10px 0;">${task.title}</p>
                        <div style="display: flex; gap: 10px; margin: 15px 0;">
                            <span class="energy-badge energy-${task.energy}">${task.energy}</span>
                            <span class="location-badge">📍 ${task.location}</span>
                            ${task.timeEstimate ? `<span class="time-estimate">⏱️ ${task.timeEstimate}min</span>` : ''}
                        </div>
                        <p class="suggestion-reason">
                            Perfect for your ${currentEnergy} energy at ${location}
                        </p>
                        <button class="btn btn-success" onclick="toggleTask('${task.id}')" style="margin-top: 15px;">
                            ✅ Mark Complete
                        </button>
                    </div>
                `;
                suggestionCard.style.display = 'block';
            } else {
                suggestionCard.innerHTML = `
                    <div class="suggestion-card">
                        <h3>🎉 All Clear!</h3>
                        <p>No tasks match your current context. Time to relax or add new tasks!</p>
                        <button class="btn btn-primary" onclick="showQuickAdd()" style="margin-top: 15px;">
                            ➕ Add Task
                        </button>
                    </div>
                `;
                suggestionCard.style.display = 'block';
            }
        }

        // ===== AI FEATURES =====
        async function callClaudeAPI(messages, systemPrompt = '') {
            if (!CLOUDFLARE_WORKER_URL || CLOUDFLARE_WORKER_URL === 'YOUR-WORKER-URL-HERE/api/claude') {
                alert('Please configure your Cloudflare Worker URL in Settings!');
                showSettings();
                throw new Error('Worker URL not configured');
            }

            const apiKey = appData.settings.apiKey || '';
            if (!apiKey) {
                alert('Please add your Anthropic API key in Settings to use AI features!');
                showSettings();
                throw new Error('API key not configured');
            }

            const response = await fetch(CLOUDFLARE_WORKER_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': apiKey
                },
                body: JSON.stringify({
                    model: 'claude-3-5-sonnet-20241022',
                    max_tokens: 2000,
                    system: systemPrompt,
                    messages: messages
                })
            });

            if (!response.ok) {
                throw new Error(`API call failed: ${response.statusText}`);
            }

            const data = await response.json();
            return data.content[0].text;
        }

        async function processBrainDump() {
            const text = document.getElementById('brainDumpText').value.trim();
            if (!text) return;

            const btn = event.target;
            btn.disabled = true;
            btn.textContent = '🧠 Processing...';

            try {
                const systemPrompt = `You are an ADHD-friendly task organizer. Parse the user's brain dump into clear, actionable tasks. For each task, determine:
- energy level (high/medium/low)
- location (home/school/work/commute/anywhere)
- time estimate in minutes

Return ONLY valid JSON array of tasks, no other text:
[{"title": "...", "energy": "...", "location": "...", "timeEstimate": 30}]`;

                const response = await callClaudeAPI([{
                    role: 'user',
                    content: text
                }], systemPrompt);

                const tasks = JSON.parse(response);
                tasks.forEach(task => addTask(task));

                closeModal('brainDumpModal');
                document.getElementById('brainDumpText').value = '';
                
                confetti({
                    particleCount: 150,
                    spread: 100,
                    origin: { y: 0.6 }
                });
            } catch (error) {
                console.error('Brain dump error:', error);
                alert('Failed to process brain dump. Check your API configuration.');
            } finally {
                btn.disabled = false;
                btn.textContent = '✨ Organize My Chaos';
            }
        }

        async function showStuck() {
            const incompleteTasks = appData.tasks.filter(t => !t.completed);
            
            if (incompleteTasks.length === 0) {
                alert('No tasks to help with! Add some tasks first.');
                return;
            }

            const modal = document.getElementById('stuckModal');
            const content = document.getElementById('stuckContent');
            
            content.innerHTML = `
                <p>Select a task you're stuck on:</p>
                <div style="margin: 20px 0;">
                    ${incompleteTasks.map(task => `
                        <button class="btn btn-secondary" onclick="getStuckHelp('${task.id}')" 
                                style="width: 100%; margin: 5px 0; text-align: left;">
                            ${task.title}
                        </button>
                    `).join('')}
                </div>
            `;
            
            modal.classList.add('active');
        }

        function findNextAvailableBlock(task) {
            const now = getCurrentDateTime();
            const currentDay = days[now.getDay()];
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            
            // Check today's remaining schedule first
            const todaySchedule = appData.schedule[currentDay] || [];
            for (let block of todaySchedule) {
                const startMinutes = parseTime(block.startTime);
                const endMinutes = parseTime(block.endTime);
                const duration = endMinutes - startMinutes;
                
                // Skip if block already passed or is protected/class
                if (startMinutes <= currentMinutes || block.type === 'protected' || block.type === 'class') {
                    continue;
                }
                
                // Check if block is suitable for task
                if (block.type === 'free' && 
                    (task.location === 'anywhere' || task.location === block.location || block.location === 'anywhere') &&
                    (!task.timeEstimate || duration >= task.timeEstimate)) {
                    return {
                        day: currentDay,
                        time: `${formatTime(block.startTime)}-${formatTime(block.endTime)}`,
                        location: block.location,
                        duration: duration,
                        available: true
                    };
                }
            }
            
            // Check next 7 days
            for (let i = 1; i <= 7; i++) {
                const checkDate = new Date(now);
                checkDate.setDate(checkDate.getDate() + i);
                const dayName = days[checkDate.getDay()];
                const daySchedule = appData.schedule[dayName] || [];
                
                for (let block of daySchedule) {
                    const startMinutes = parseTime(block.startTime);
                    const endMinutes = parseTime(block.endTime);
                    const duration = endMinutes - startMinutes;
                    
                    if (block.type === 'free' && 
                        (task.location === 'anywhere' || task.location === block.location || block.location === 'anywhere') &&
                        (!task.timeEstimate || duration >= task.timeEstimate)) {
                        return {
                            day: dayName,
                            time: `${formatTime(block.startTime)}-${formatTime(block.endTime)}`,
                            location: block.location,
                            duration: duration,
                            available: true
                        };
                    }
                }
            }
            
            return { available: false };
        }

        async function getStuckHelp(taskId) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (!task) return;

            const content = document.getElementById('stuckContent');
            content.innerHTML = `
                <h3>${task.title}</h3>
                <p>🤔 Breaking this down into tiny steps...</p>
            `;

            try {
                // Find next available time block
                const nextBlock = findNextAvailableBlock(task);
                
                const scheduleContext = nextBlock.available 
                    ? `Next available time: ${nextBlock.day} ${nextBlock.time} at ${nextBlock.location} (${nextBlock.duration} minutes available)`
                    : 'No clear free time found soon - user may need to make time';
                
                const systemPrompt = `You are an ADHD coach helping break down tasks. The user is stuck on a task.

Task: ${task.title}
Time estimate: ${task.timeEstimate ? task.timeEstimate + ' minutes' : 'not specified'}
Location needed: ${task.location}

${scheduleContext}

Break this down into the TINIEST possible first step to overcome starting paralysis. Then suggest 2-3 follow-up micro-steps.

Each step should be:
- Completable in under 10 minutes
- Require zero decision-making
- Be physically actionable
- Build momentum

${nextBlock.available ? `Reminder: User can work on this ${nextBlock.day} ${nextBlock.time}. Acknowledge this in your response.` : ''}

Format as natural, encouraging text. Be brief and direct.`;

                const response = await callClaudeAPI([{
                    role: 'user',
                    content: `I'm stuck on: ${task.title}`
                }], systemPrompt);

                let scheduleInfo = '';
                if (nextBlock.available) {
                    scheduleInfo = `
                        <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            <strong>📅 Your next good time for this:</strong><br>
                            ${nextBlock.day} ${nextBlock.time} at ${nextBlock.location}<br>
                            <small>(${nextBlock.duration} minutes available)</small>
                        </div>
                    `;
                }

                content.innerHTML = `
                    <h3>${task.title}</h3>
                    ${scheduleInfo}
                    <div style="background: var(--bg-main); padding: 20px; border-radius: 10px; margin: 20px 0;">
                        ${response.replace(/\n/g, '<br>')}
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="toggleTask('${task.id}')">
                            ✅ Got it! Mark as done
                        </button>
                        ${nextBlock.available ? `
                            <button class="btn btn-warning" onclick="scheduleReminder('${task.id}', '${nextBlock.day}', '${nextBlock.time}')">
                                ⏰ Remind me ${nextBlock.day}
                            </button>
                        ` : ''}
                        <button class="btn btn-secondary" onclick="closeModal('stuckModal')">
                            Close
                        </button>
                    </div>
                `;
            } catch (error) {
                console.error('Stuck help error:', error);
                content.innerHTML = `
                    <h3>${task.title}</h3>
                    <p style="color: var(--danger);">Failed to get help. Check your API configuration.</p>
                    <button class="btn btn-secondary" onclick="closeModal('stuckModal')">Close</button>
                `;
            }
        }

        function scheduleReminder(taskId, day, time) {
            // For now, just show a confirmation
            // In a full implementation, this could integrate with browser notifications or calendar
            alert(`✅ Reminder set!\n\nI'll remind you about this task on ${day} ${time}.\n\n(Note: Browser notifications would be implemented in a production version)`);
            closeModal('stuckModal');
        }

        // ===== TIER 3 FEATURE 1: DONE FOR TODAY =====
        function handleDoneForToday() {
            const incompleteTasks = appData.tasks.filter(t => !t.completed);
            
            if (incompleteTasks.length === 0) {
                showToast('🎉 You already finished everything!');
                return;
            }
            
            // Show confirmation modal
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>😴 Call it a day?</h2>
                        <button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <p style="margin-bottom: 20px;">You have ${incompleteTasks.length} incomplete task${incompleteTasks.length > 1 ? 's' : ''}. Move them all to tomorrow?</p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="moveTasksToTomorrow(${JSON.stringify(incompleteTasks.map(t => t.id))}); this.closest('.modal').remove();">
                            Yes, move ${incompleteTasks.length} task${incompleteTasks.length > 1 ? 's' : ''}
                        </button>
                        <button class="btn btn-secondary" onclick="showDoneForTodayWithNote(${JSON.stringify(incompleteTasks.map(t => t.id))}); this.closest('.modal').remove();">
                            Add a note first
                        </button>
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove();">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function moveTasksToTomorrow(taskIds) {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            taskIds.forEach(taskId => {
                const task = appData.tasks.find(t => t.id === taskId);
                if (task && !task.completed) {
                    task.movedToTomorrow = true;
                    task.originalDueDate = task.dueDate;
                    task.dueDate = tomorrowStr;
                }
            });
            
            saveData();
            renderTasks();
            showCelebration();
        }

        function showCelebration() {
            const completedToday = appData.tasks.filter(t => 
                t.completed && 
                t.completedAt && 
                isToday(new Date(t.completedAt))
            );
            
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>✨ Great Work Today!</h2>
                        <button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="celebration-stats">
                        <h3 style="color: var(--primary); margin-bottom: 15px;">You completed ${completedToday.length} task${completedToday.length !== 1 ? 's' : ''} today!</h3>
                        ${completedToday.length > 0 ? `
                            <ul style="list-style: none; padding: 0; margin: 20px 0;">
                                ${completedToday.map(t => `<li style="padding: 8px; background: var(--bg-main); margin: 5px 0; border-radius: 6px;">✓ ${t.title}</li>`).join('')}
                            </ul>
                        ` : ''}
                        <p style="color: var(--text-light); font-style: italic; margin-top: 20px;">Rest up - tomorrow is a fresh start! 🌟</p>
                    </div>
                    <button class="btn btn-primary" onclick="this.closest('.modal').remove();" style="margin-top: 20px;">
                        Thanks! 😊
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showDoneForTodayWithNote(taskIds) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Why are you done for today?</h2>
                        <button class="close-modal" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <p style="color: var(--text-light); margin-bottom: 15px;">Optional - helps track patterns</p>
                    <div class="form-group">
                        <label>Reason</label>
                        <select id="doneReason" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px;">
                            <option>Exhausted/burned out</option>
                            <option>Unexpected stuff came up</option>
                            <option>Took longer than expected</option>
                            <option>Not feeling well</option>
                            <option>Just need a break</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notes (optional)</label>
                        <textarea id="doneNotes" placeholder="Anything else to remember?" style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; min-height: 80px;"></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="saveDoneForTodayNote(${JSON.stringify(taskIds)}); this.closest('.modal').remove();">
                        Save & Move Tasks
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveDoneForTodayNote(taskIds) {
            const reason = document.getElementById('doneReason').value;
            const notes = document.getElementById('doneNotes').value;
            
            const note = {
                date: new Date().toISOString(),
                reason: reason,
                notes: notes,
                tasksRemaining: taskIds.length
            };
            
            // Initialize doneForTodayNotes if it doesn't exist
            if (!appData.doneForTodayNotes) {
                appData.doneForTodayNotes = [];
            }
            
            appData.doneForTodayNotes.push(note);
            saveData();
            
            moveTasksToTomorrow(taskIds);
        }

        function isToday(date) {
            const today = new Date();
            return date.getDate() === today.getDate() &&
                   date.getMonth() === today.getMonth() &&
                   date.getFullYear() === today.getFullYear();
        }

        // ===== MODAL FUNCTIONS =====
        function showQuickAdd() {
            document.getElementById('quickTaskInput').focus();
        }

        function showBrainDump() {
            document.getElementById('brainDumpModal').classList.add('active');
            document.getElementById('brainDumpText').focus();
        }

        function showEditSchedule() {
            alert('Schedule editing coming soon! For now, edit the defaultSchedule in the code.');
        }

        function showSettings() {
            document.getElementById('workerUrlInput').value = appData.settings.workerUrl || CLOUDFLARE_WORKER_URL;
            document.getElementById('clientIdInput').value = appData.settings.clientId || GOOGLE_CLIENT_ID;
            document.getElementById('apiKeyInput').value = appData.settings.apiKey || '';
            document.getElementById('settingsModal').classList.add('active');
        }

        function saveSettings() {
            const workerUrl = document.getElementById('workerUrlInput').value.trim();
            const clientId = document.getElementById('clientIdInput').value.trim();
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            
            appData.settings.workerUrl = workerUrl;
            appData.settings.clientId = clientId;
            appData.settings.apiKey = apiKey;
            
            if (workerUrl) CLOUDFLARE_WORKER_URL = workerUrl;
            if (clientId) GOOGLE_CLIENT_ID = clientId;
            
            // Hide warning if configured
            if (workerUrl && clientId) {
                document.getElementById('configWarning').style.display = 'none';
            }
            
            saveData();
            closeModal('settingsModal');
            alert('Settings saved! Refresh the page if you just added your Google Client ID.');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function toggleFont() {
            document.body.classList.toggle('dyslexia-font');
        }

        // ===== VISUAL TIME BLOCK PLANNER =====
        let currentPlannerWeek = new Date();

        function showCurrentWeek() {
            currentPlannerWeek = new Date();
            generatePlannerGrid(currentPlannerWeek);
        }

        function showNextWeek() {
            currentPlannerWeek = new Date();
            currentPlannerWeek.setDate(currentPlannerWeek.getDate() + 7);
            generatePlannerGrid(currentPlannerWeek);
        }

        function generatePlannerGrid(startDate) {
            const grid = document.getElementById('plannerGrid');
            grid.innerHTML = '';
            
            // Get start of week (Sunday)
            const weekStart = new Date(startDate);
            weekStart.setDate(weekStart.getDate() - weekStart.getDay());
            
            // Generate 7 days
            for (let i = 0; i < 7; i++) {
                const date = new Date(weekStart);
                date.setDate(date.getDate() + i);
                
                const dayColumn = document.createElement('div');
                dayColumn.className = 'planner-day-column';
                
                // Day header
                const header = document.createElement('div');
                header.className = 'planner-day-header';
                header.textContent = date.toLocaleDateString('en-US', { 
                    weekday: 'short', 
                    month: 'short', 
                    day: 'numeric' 
                });
                dayColumn.appendChild(header);
                
                // Get schedule for this day
                const dayName = days[date.getDay()];
                const daySchedule = appData.schedule[dayName] || [];
                
                // Create blocks
                daySchedule.forEach(block => {
                    const blockEl = createTimeBlockElement(block, date);
                    dayColumn.appendChild(blockEl);
                });
                
                grid.appendChild(dayColumn);
            }
            
            // Render unscheduled tasks
            renderUnscheduledTasks();
            
            // Enable drag and drop
            enableDragAndDrop();
        }

        function createTimeBlockElement(block, date) {
            const blockEl = document.createElement('div');
            blockEl.className = `time-block type-${block.type}`;
            
            const dateStr = date.toISOString().split('T')[0];
            const blockId = `${dateStr}-${block.startTime}`;
            blockEl.dataset.blockId = blockId;
            
            // Calculate height based on duration
            const duration = parseTime(block.endTime) - parseTime(block.startTime);
            const heightPx = Math.max((duration / 30) * 40, 60); // Min 60px
            blockEl.style.height = `${heightPx}px`;
            
            // Block content
            const timeDiv = document.createElement('div');
            timeDiv.className = 'block-time';
            timeDiv.textContent = `${formatTime(block.startTime)} - ${formatTime(block.endTime)}`;
            blockEl.appendChild(timeDiv);
            
            const titleDiv = document.createElement('div');
            titleDiv.className = 'block-title';
            titleDiv.textContent = block.text;
            blockEl.appendChild(titleDiv);
            
            // Lock icon for protected blocks
            if (block.type === 'protected') {
                const lockDiv = document.createElement('div');
                lockDiv.className = 'block-lock';
                lockDiv.textContent = '🔒';
                blockEl.appendChild(lockDiv);
            }
            
            // Tasks container (only for free blocks)
            if (block.type === 'free' && block.editable) {
                const tasksContainer = document.createElement('div');
                tasksContainer.className = 'block-tasks';
                tasksContainer.dataset.blockId = blockId;
                
                // Load any tasks already scheduled for this block
                const scheduledTasks = appData.tasks.filter(t => 
                    !t.completed && t.scheduledBlock === blockId
                );
                
                scheduledTasks.forEach(task => {
                    tasksContainer.appendChild(createMiniTaskCard(task));
                });
                
                blockEl.appendChild(tasksContainer);
            }
            
            return blockEl;
        }

        function createMiniTaskCard(task) {
            const card = document.createElement('div');
            card.className = 'mini-task-card';
            card.dataset.taskId = task.id;
            card.draggable = true;
            
            const titleSpan = document.createElement('span');
            titleSpan.className = 'mini-task-title';
            titleSpan.textContent = task.title;
            card.appendChild(titleSpan);
            
            const timeSpan = document.createElement('span');
            timeSpan.className = 'mini-task-time';
            timeSpan.textContent = `${task.timeEstimate}m`;
            card.appendChild(timeSpan);
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'mini-task-remove';
            removeBtn.textContent = '×';
            removeBtn.onclick = (e) => {
                e.stopPropagation();
                unscheduleTask(task.id);
            };
            card.appendChild(removeBtn);
            
            // Add drag event listeners
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);
            
            return card;
        }

        function renderUnscheduledTasks() {
            const container = document.getElementById('unscheduledTasksList');
            const unscheduledTasks = appData.tasks.filter(t => 
                !t.completed && !t.scheduledBlock
            );
            
            if (unscheduledTasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p style="color: var(--text-light);">All tasks are scheduled! 🎉</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            unscheduledTasks.forEach(task => {
                const card = document.createElement('div');
                card.className = 'unscheduled-task-card';
                card.dataset.taskId = task.id;
                card.draggable = true;
                
                card.innerHTML = `
                    <div style="flex: 1;">
                        <div style="font-weight: 600; margin-bottom: 4px;">${task.title}</div>
                        <div style="display: flex; gap: 8px; font-size: 0.85em;">
                            <span class="energy-badge energy-${task.energy}">${task.energy}</span>
                            <span class="location-badge">📍 ${task.location}</span>
                            <span class="time-estimate">⏱️ ${task.timeEstimate}min</span>
                        </div>
                    </div>
                `;
                
                // Add drag event listeners
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
                
                container.appendChild(card);
            });
        }

        function enableDragAndDrop() {
            // Make block-tasks drop zones
            document.querySelectorAll('.block-tasks').forEach(zone => {
                zone.addEventListener('dragover', handleDragOver);
                zone.addEventListener('dragleave', handleDragLeave);
                zone.addEventListener('drop', handleDrop);
            });
        }

        let draggedTaskId = null;

        function handleDragStart(e) {
            draggedTaskId = e.currentTarget.dataset.taskId;
            e.currentTarget.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            e.currentTarget.classList.remove('dragging');
            draggedTaskId = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            e.currentTarget.classList.add('drop-target');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drop-target');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drop-target');
            
            if (!draggedTaskId) return;
            
            const blockId = e.currentTarget.dataset.blockId;
            const task = appData.tasks.find(t => t.id === draggedTaskId);
            
            if (!task) return;
            
            // Check if this is a protected block (shouldn't happen, but safety check)
            const blockEl = e.currentTarget.closest('.time-block');
            if (blockEl && blockEl.classList.contains('type-protected')) {
                showToast('⚠️ Cannot schedule tasks during protected time');
                return;
            }
            
            // Update task with scheduled block
            task.scheduledBlock = blockId;
            saveData();
            
            // Refresh the planner
            generatePlannerGrid(currentPlannerWeek);
            
            showToast(`✅ Scheduled: ${task.title}`);
        }

        function unscheduleTask(taskId) {
            const task = appData.tasks.find(t => t.id === taskId);
            if (task) {
                task.scheduledBlock = null;
                saveData();
                generatePlannerGrid(currentPlannerWeek);
                showToast(`📋 Unscheduled: ${task.title}`);
            }
        }

        // ===== UI UPDATE =====
        function updateUI() {
            updateCurrentDate();
            renderSchedule();
            renderTasks();
            updateWhatNow();
            renderDeadlines();
            
            // Initialize planner if visible
            if (document.getElementById('plannerGrid').children.length === 0) {
                showCurrentWeek();
            }
        }

        // ===== INITIALIZATION =====
        window.addEventListener('load', async () => {
            initGoogleAPI();
            
            // Wait a moment for gapi to initialize, then restore session
            setTimeout(async () => {
                await restoreSession();
                
                // Sync the updated defaultSchedule to Drive after session restore
                if (googleAccessToken && gapiInitialized) {
                    setTimeout(async () => {
                        await syncDefaultScheduleToDrive();
                    }, 2000);
                }
            }, 1000);
            
            // Run safety migration for phone -> errands
            migratePhoneToErrands();
            
            updateUI();
            
            // Update every minute
            setInterval(() => {
                updateUI();
            }, 60000);
            
            // Set default location
            setLocation('home');
            
            // Check if configured
            if (!CLOUDFLARE_WORKER_URL || CLOUDFLARE_WORKER_URL === 'YOUR-WORKER-URL-HERE/api/claude' ||
                !GOOGLE_CLIENT_ID || GOOGLE_CLIENT_ID === 'YOUR-CLIENT-ID-HERE.apps.googleusercontent.com') {
                document.getElementById('configWarning').style.display = 'block';
            } else {
                document.getElementById('configWarning').style.display = 'none';
            }
        });

        // Close modals on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // Online/offline detection
        window.addEventListener('online', () => {
            isOnline = true;
            if (pendingChanges && googleAccessToken) {
                saveDataToDrive();
            }
        });

        window.addEventListener('offline', () => {
            isOnline = false;
        });
    </script>
</body>
</html>
