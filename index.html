<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controlled Chaos v4 🌀</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ical.js@1.5.0/build/ical.min.js"></script>
    
    <!-- OpenDyslexic Font -->
    <style>
    @font-face {
        font-family: 'OpenDyslexic';
        src: url('https://cdn.jsdelivr.net/gh/antijingoist/opendyslexic@master/compiled/OpenDyslexic-Regular.otf') format('opentype');
        font-weight: normal;
        font-style: normal;
    }

    @font-face {
        font-family: 'OpenDyslexic';
        src: url('https://cdn.jsdelivr.net/gh/antijingoist/opendyslexic@master/compiled/OpenDyslexic-Bold.otf') format('opentype');
        font-weight: bold;
        font-style: normal;
    }
    </style>
    
    <!-- App Styles -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>🌀 Controlled Chaos v4</h1>
            <p class="tagline">Your ADHD-friendly productivity companion with cross-device sync</p>
            <div class="current-date" id="currentDate"></div>
            
            <!-- Sync Indicator -->
            <div id="syncIndicator" style="
                padding: 0.5rem 1rem;
                border-radius: 6px;
                font-weight: 500;
                font-size: 0.9rem;
                cursor: pointer;
                transition: all 0.2s;
            " title="Click to view sync status">
                💾 Checking...
            </div>
            
            <div class="header-buttons">
                <button class="btn btn-secondary" onclick="showQuickAdd()" data-tooltip="Quick Add">
                    <span class="btn-icon">⚡</span>
                    <span class="btn-text">Quick Add</span>
                </button>
                <button class="btn btn-secondary" onclick="showBrainDump()" data-tooltip="Brain Dump">
                    <span class="btn-icon">🧠</span>
                    <span class="btn-text">Brain Dump</span>
                </button>
                <button class="btn btn-secondary" onclick="showStuck()" data-tooltip="I'm Stuck">
                    <span class="btn-icon">🤔</span>
                    <span class="btn-text">I'm Stuck</span>
                </button>
                <button class="btn btn-secondary" onclick="MoodTracker.showVisualization()" data-tooltip="Mood Patterns">
                    <span class="btn-icon">📊</span>
                    <span class="btn-text">Mood Patterns</span>
                </button>
            </div>
        </header>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-button active" data-tab="dashboard">🏠 Dashboard</button>
            <button class="tab-button" data-tab="tasks">✅ Tasks & Deadlines</button>
            <button class="tab-button" data-tab="projects">💻 Projects</button>
            <button class="tab-button" data-tab="schedule">📅 Schedule</button>
            <button class="menu-button" id="moreMenuButton">⚙️ More ▾</button>
        </div>

        <!-- More Menu Dropdown -->
        <div class="more-menu hidden" id="moreMenu">
            <button class="more-menu-item" data-tab="templates" onclick="handleMoreMenuClick('templates')">
                📋 Templates
            </button>
            <button class="more-menu-item" data-tab="settings" onclick="handleMoreMenuClick('settings')">
                ⚙️ Settings
            </button>
            <button class="more-menu-item" id="appearanceButton" onclick="handleAppearanceClick()">
                🔤 Toggle Dyslexia Font
            </button>
        </div>

        <!-- DASHBOARD TAB -->
        <div class="tab-content" id="dashboard-tab" style="display: block;">
            <!-- Configuration Warning -->
            <div id="configWarning" class="config-warning">
                <strong>⚠️ Configuration Required</strong><br>
                Please update the configuration in Settings with your Cloudflare Worker URL and Google Client ID.
                See SETUP-INSTRUCTIONS.md for details.
            </div>

            <!-- WHAT NOW Hero Section -->
            <div class="what-now-hero">
                <h2>🎯 What Should I Do Right Now?</h2>
                
                <div class="location-selector">
                    <button class="location-btn" data-location="home" onclick="setLocation('home')">🏠 Home</button>
                    <button class="location-btn" data-location="school" onclick="setLocation('school')">🏫 School</button>
                    <button class="location-btn" data-location="work" onclick="setLocation('work')">💼 Work</button>
                    <button class="location-btn" data-location="commute" onclick="setLocation('commute')">🚗 Commute</button>
                </div>

                <div class="energy-picker" style="display: flex; gap: 10px; margin: 15px 0; justify-content: center; flex-wrap: wrap;">
                    <button class="energy-btn" data-energy="low" onclick="setUserEnergy('low')">
                        🔋 Low Energy
                    </button>
                    <button class="energy-btn" data-energy="medium" onclick="setUserEnergy('medium')">
                        ⚡ Medium Energy
                    </button>
                    <button class="energy-btn" data-energy="high" onclick="setUserEnergy('high')">
                        🚀 High Energy
                    </button>
                </div>

                <div id="contextInfo" class="context-info" style="display: none;">
                    <h3 id="contextTitle">Loading...</h3>
                    <p id="contextDetails"></p>
                </div>

                <div id="suggestionCard" style="display: none;">
                    <!-- Suggestion will be inserted here -->
                </div>
                
                <!-- Done for Today Section -->
                <div class="done-for-today-section" style="margin-top: 20px;">
                    <button id="doneForTodayBtn" class="done-for-today-btn" onclick="handleDoneForToday()">
                        😴 Done for Today
                    </button>
                    <p class="done-hint" style="color: rgba(255,255,255,0.8); font-size: 0.9em; margin-top: 8px;">
                        Exhausted? Move remaining tasks to tomorrow - no guilt!
                    </p>
                </div>
            </div>

            <!-- Current Schedule Block -->
            <div class="schedule-section">
                <div class="schedule-header">
                    <h2>📅 Your Schedule Right Now</h2>
                </div>
                
                <div id="currentBlock" class="current-block" style="display: none;">
                    <h3>📍 YOU ARE HERE</h3>
                    <p id="currentBlockText"></p>
                    <p class="time-remaining" id="timeRemaining"></p>
                </div>
            </div>
        </div>

        <!-- TASKS TAB -->
        <div class="tab-content" id="tasks-tab" style="display: none;">
            <h2 style="color: var(--primary); margin-bottom: 20px;">✅ Tasks & Deadlines</h2>
            <p style="color: var(--text-light); margin-bottom: 20px;">Manage all your tasks, deadlines, and errands in one place.</p>
            
            <!-- All Tasks Section -->
            <div class="card">
                <h2>📋 All Tasks</h2>
                <div class="quick-add">
                    <input type="text" id="quickTaskInput" placeholder="Quick add a task... (press Enter)" 
                           onkeypress="if(event.key==='Enter') quickAddTask()">
                    <button class="btn btn-primary" onclick="quickAddTask()">Add</button>
                </div>
                <div id="allTasks" class="task-list">
                    <div class="empty-state">
                        <div class="empty-state-icon">📝</div>
                        <p>No tasks yet! Use Quick Add or Brain Dump to get started.</p>
                    </div>
                </div>
            </div>

            <!-- Deadlines Section -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                    <h2 style="margin: 0;">📋 Deadlines</h2>
                    <button class="btn btn-primary" onclick="showCalendarImportModal()">
                        📅 Import Calendar
                    </button>
                </div>
                <div class="quick-add">
                    <input type="text" id="quickDeadlineInput" placeholder="Quick add a deadline... (press Enter)" 
                           onkeypress="if(event.key==='Enter') showAddDeadlineModal()">
                    <button class="btn btn-primary" onclick="showAddDeadlineModal()">Add Deadline</button>
                </div>
                <div id="allDeadlines" class="task-list">
                    <div class="empty-state">
                        <div class="empty-state-icon">📅</div>
                        <p>No deadlines yet!</p>
                    </div>
                </div>
            </div>

            <!-- Errands & Stops Section -->
            <div class="card errands-section">
                <h2>🏪 Errands & Stops</h2>
                <p class="errands-hint" style="color: var(--text-light); margin-bottom: 15px;">
                    Things to do when you're out and about (post office, grocery store, etc.)
                </p>
                
                <div class="common-errands" style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px;">Quick add common errands:</h4>
                    <div class="errand-buttons" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <button class="btn btn-secondary" onclick="quickAddErrand('Post office')" style="width: 100%;">📮 Post office</button>
                        <button class="btn btn-secondary" onclick="quickAddErrand('Grocery store')" style="width: 100%;">🛒 Grocery</button>
                        <button class="btn btn-secondary" onclick="quickAddErrand('Gas station')" style="width: 100%;">⛽ Gas</button>
                        <button class="btn btn-secondary" onclick="quickAddErrand('Pharmacy')" style="width: 100%;">💊 Pharmacy</button>
                    </div>
                </div>
                
                <div id="errandTasks" class="task-list">
                    <div class="empty-state">
                        <div class="empty-state-icon">🏪</div>
                        <p>No errands yet!</p>
                    </div>
                </div>
                
                <div class="commute-home-indicator" style="display: none; background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 15px; border-radius: 10px; margin-top: 15px;" id="commuteHomeIndicator">
                    🚗 You're driving home - good time to make stops!
                </div>
            </div>
        </div>

        <!-- PROJECTS TAB -->
        <div class="tab-content" id="projects-tab" style="display: none;">
            <h2 style="color: var(--primary); margin-bottom: 20px;">💻 Projects</h2>
            <p style="color: var(--text-light); margin-bottom: 20px;">Track your coding and personal projects with interactive task checklists.</p>
            
            <div id="projectsList" class="projects-grid">
                <!-- Projects will be rendered here by JavaScript -->
            </div>
        </div>

        <!-- SCHEDULE TAB -->
        <div class="tab-content" id="schedule-tab" style="display: none;">
            <h2 style="color: var(--primary); margin-bottom: 20px;">📅 Schedule & Planning</h2>
            <p style="color: var(--text-light); margin-bottom: 20px;">View your schedule and plan your week visually.</p>
            
            <!-- Full Schedule View -->
            <div class="schedule-section">
                <div class="schedule-header">
                    <h2>📅 Daily Schedule</h2>
                </div>
                
                <div id="currentBlock" class="current-block" style="display: none;">
                    <h3>📍 YOU ARE HERE</h3>
                    <p id="currentBlockText"></p>
                    <p class="time-remaining" id="timeRemaining"></p>
                </div>

                <!-- Week Navigation -->
                <div class="week-navigation">
                    <button id="prevWeek">← Previous Week</button>
                    <span id="weekLabel">Week of Oct 6, 2025</span>
                    <button id="nextWeek">Next Week →</button>
                </div>

                <!-- Day Tabs with Dates -->
                <div class="day-tabs">
                    <!-- Tabs will be generated dynamically by JavaScript -->
                </div>

                <div id="scheduleView"></div>
            </div>
        </div>

        <!-- TEMPLATES TAB -->
        <div class="tab-content" id="templates-tab" style="display: none;">
            <h2 style="color: var(--primary); margin-bottom: 20px;">📋 Task Templates</h2>
            <p style="color: var(--text-light); margin-bottom: 20px;">Create and manage recurring task templates.</p>
            
            <!-- Templates Section -->
            <div class="card">
                <h2>📋 Weekly Task Templates</h2>
                <p style="color: var(--text-light); margin-bottom: 15px;">
                    Create all your weekly coursework with one click
                </p>
                <div id="templateCards" class="template-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <!-- Templates will be rendered here by JavaScript -->
                </div>
                
                <button class="btn btn-secondary" onclick="showCreateTemplateModal()" style="width: 100%;">
                    ➕ Create Custom Template
                </button>
            </div>
        </div>

        <!-- SETTINGS TAB -->
        <div class="tab-content" id="settings-tab" style="display: none;">
            <h2 style="color: var(--primary); margin-bottom: 20px;">⚙️ Settings & Configuration</h2>
            <p style="color: var(--text-light); margin-bottom: 20px;">Configure your API keys and preferences.</p>
            
            <!-- Google Drive Authentication Section -->
            <div class="card" style="margin-bottom: 2rem;">
                <h2>☁️ Google Drive Sync</h2>
                <p style="color: #666; margin-bottom: 1rem;">
                    Sign in to sync your data across devices and back up to Google Drive.
                </p>
                
                <div id="googleSignInSettings">
                    <button id="googleSignInBtn" class="primary-button" onclick="handleGoogleSignIn()">
                        Sign in with Google
                    </button>
                </div>
                
                <div id="googleAccountInfo" style="display: none; margin-top: 1rem;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span id="userEmailDisplay" style="color: #666;">user@example.com</span>
                        <button id="googleSignOutBtn" class="secondary-button" onclick="handleGoogleSignOut()">Sign Out</button>
                    </div>
                </div>
            </div>
            
            <!-- Settings Content -->
            <div class="card">
                <h2>🔧 API Configuration</h2>
                
                <div class="form-group">
                    <label for="workerUrlInput">Cloudflare Worker URL</label>
                    <input type="text" id="workerUrlInput" placeholder="https://your-worker.workers.dev/api/claude">
                    <p style="color: var(--text-light); font-size: 0.9em; margin-top: 5px;">
                        Your Cloudflare Worker URL for API proxy. See SETUP-INSTRUCTIONS.md Part 1.
                    </p>
                </div>
                
                <div class="form-group">
                    <label for="clientIdInput">Google OAuth Client ID</label>
                    <input type="text" id="clientIdInput" placeholder="123456789-abc.apps.googleusercontent.com">
                    <p style="color: var(--text-light); font-size: 0.9em; margin-top: 5px;">
                        Your Google OAuth Client ID for Drive sync. See SETUP-INSTRUCTIONS.md Part 2.
                    </p>
                </div>
                
                <div class="form-group">
                    <label for="apiKeyInput">Anthropic API Key (Optional)</label>
                    <input type="password" id="apiKeyInput" placeholder="sk-ant-...">
                    <p style="color: var(--text-light); font-size: 0.9em; margin-top: 5px;">
                        Your API key enables AI features. Stored securely in Google Drive.
                    </p>
                </div>
                
                <button class="btn btn-primary" onclick="saveSettings()">💾 Save Settings</button>
            </div>
            
            <!-- Preferences -->
            <div class="card">
                <h2>🎨 Preferences</h2>
                
                <div class="form-group">
                    <label>Font Style</label>
                    <button class="btn btn-secondary" onclick="toggleFont()" style="width: 100%;">
                        🔤 Toggle Dyslexia-Friendly Font
                    </button>
                    <p style="color: var(--text-light); font-size: 0.9em; margin-top: 5px;">
                        Switches between standard and OpenDyslexic font for easier reading.
                    </p>
                </div>
            </div>
            
            <!-- Calendar Import -->
            <div class="card">
                <h2>📅 Calendar Import</h2>
                <p style="color: var(--text-light); margin-bottom: 15px;">
                    Import your schedule and deadlines from Canvas, Google Calendar, or any calendar app.
                </p>
                <button class="btn btn-primary" onclick="showCalendarImportModal()">
                    📥 Import from Calendar Feed
                </button>
                <p style="margin-top: 10px; font-size: 0.9em; color: var(--text-light);">
                    <strong>Where to find your feed URL:</strong><br>
                    Canvas: Calendar → Calendar Feed → Copy link<br>
                    Google Calendar: Settings → Secret address in iCal format
                </p>
            </div>
        </div>
    </div>

    <!-- Brain Dump Modal -->
    <div id="brainDumpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🧠 Brain Dump</h2>
                <button class="close-modal" onclick="closeModal('brainDumpModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Dump everything on your mind:</label>
                <textarea id="brainDumpText" placeholder="Write essay for english&#10;Buy groceries&#10;Email professor about extension&#10;...or just type whatever is stressing you out!"></textarea>
            </div>
            <button class="btn btn-primary" onclick="processBrainDump()">✨ Organize My Chaos</button>
        </div>
    </div>

    <!-- Stuck Modal -->
    <div id="stuckModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🤔 Let's Break This Down</h2>
                <button class="close-modal" onclick="closeModal('stuckModal')">&times;</button>
            </div>
            <div id="stuckContent">
                <p>What task are you stuck on?</p>
            </div>
        </div>
    </div>

    <!-- Saving Indicator -->
    <div class="saving-indicator"></div>

    <!-- App Scripts (ORDER MATTERS!) -->
    <script src="mood-tracker.js"></script>
    <script src="data.js"></script>
    <script src="storage.js"></script>
    <script src="calendar.js"></script>
    <script src="ui.js"></script>
    <script src="app.js"></script>
    <script src="calendar-import.js"></script>
</body>
</html>
