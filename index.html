<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controlled Chaos v4 🌀</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>🌀</text></svg>">
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ical.js@1.5.0/build/ical.min.js"></script>
    
    <!-- OpenDyslexic Font -->
    <style>
    @font-face {
        font-family: 'OpenDyslexic';
        src: url('https://cdn.jsdelivr.net/gh/antijingoist/opendyslexic@master/compiled/OpenDyslexic-Regular.otf') format('opentype');
        font-weight: normal;
        font-style: normal;
    }

    @font-face {
        font-family: 'OpenDyslexic';
        src: url('https://cdn.jsdelivr.net/gh/antijingoist/opendyslexic@master/compiled/OpenDyslexic-Bold.otf') format('opentype');
        font-weight: bold;
        font-style: normal;
    }
    </style>
    
    <!-- App Styles -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="mood-tracker/styles.css">
</head>
<body>
    <!-- Session Expired Banner (hidden by default) -->
    <div id="sessionExpiredBanner" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
        color: white;
        padding: 15px 20px;
        z-index: 10000;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        animation: slideDown 0.3s ease-out;
    ">
        <div style="max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <span style="font-size: 1.5em;">⚠️</span>
                <div>
                    <strong style="font-size: 1.1em;">Your Google Drive session has expired</strong>
                    <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.95em;">
                        Please sign in again to continue syncing your data
                    </p>
                </div>
            </div>
            <button onclick="signInFromBanner()" style="
                background: white;
                color: #ef4444;
                border: none;
                padding: 12px 24px;
                border-radius: 6px;
                font-weight: 600;
                cursor: pointer;
                font-size: 1em;
                white-space: nowrap;
            ">
                🔐 Sign In Now
            </button>
        </div>
    </div>

    <style>
    @keyframes slideDown {
        from {
            transform: translateY(-100%);
        }
        to {
            transform: translateY(0);
        }
    }
    </style>

    <!-- Due Soon Warning Banner -->
    <div id="dueSoonBanner" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2);">
        <div id="dueSoonContent" style="font-size: 1.1em; font-weight: bold;"></div>
        <div id="countdownTimer" style="font-size: 2em; margin-top: 5px; font-family: monospace;"></div>
    </div>
    
    <div class="container">
        <header>
            <h1>🌀 Controlled Chaos</h1>
            <p class="tagline">Your ADHD-friendly productivity companion with cross-device sync</p>
            <div class="current-date" id="currentDate"></div>
            
            <!-- Sync Indicator -->
            <div id="syncIndicator" style="
                padding: 0.5rem 1rem;
                border-radius: 6px;
                font-weight: 500;
                font-size: 0.9rem;
                cursor: pointer;
                transition: all 0.2s;
            " title="Click to view sync status">
                💾 Checking...
            </div>
            
            <!-- Location Button -->
            <button id="checkLocationBtn" class="btn btn-secondary" style="
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
                white-space: nowrap;
            " title="Click to update your current location">
                📍 Update Location
            </button>
            
            <div class="header-buttons">
                <button class="btn btn-secondary" onclick="showQuickAdd()" data-tooltip="Quick Add" aria-label="Quick add a task">
                    <span class="btn-icon">⚡</span>
                    <span class="btn-text">Quick Add</span>
                </button>
                <button class="btn btn-secondary" onclick="showEnhancedPickForMe()" data-tooltip="Pick For Me" aria-label="Get AI-powered task suggestion">
                    <span class="btn-icon">✨</span>
                    <span class="btn-text">Pick For Me</span>
                </button>
                <button class="btn btn-secondary" onclick="QuickCheck.showWidget()" data-tooltip="Quick Mood" aria-label="Quick mood check-in">
                    <span class="btn-icon">💜</span>
                    <span class="btn-text">Quick Mood</span>
                </button>
            </div>
        </header>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-button active" data-tab="dashboard">🏠 Dashboard</button>
            <button class="tab-button" data-tab="tasks">✅ Tasks & Deadlines</button>
            <button class="tab-button" data-tab="projects">💻 Projects</button>
            <button class="tab-button" data-tab="schedule">📅 Schedule</button>
            <div style="position: relative; display: inline-block;">
                <button class="menu-button" id="moreMenuButton">⚙️ More ▾</button>
                <!-- More Menu Dropdown -->
                <div class="more-menu hidden" id="moreMenu">
                    <button class="more-menu-item" data-action="braindump">🧠 Brain Dump</button>
                    <button class="more-menu-item" data-action="stuck">🤔 I'm Stuck</button>
                    <button class="more-menu-item" data-action="moodpatterns">📊 Mood Patterns</button>
                    <button class="more-menu-item" data-action="settings">⚙️ Settings</button>
                    <button class="more-menu-item" data-action="templates">📋 Task Templates</button>
                    <button class="more-menu-item" data-action="appearance">🎨 Appearance</button>
                </div>
            </div>
        </div>

        <!-- Bottom Sheet (Mobile Only) -->
        <div class="bottom-sheet-overlay" id="bottomSheetOverlay"></div>
        <div class="bottom-sheet" id="bottomSheet">
            <div class="bottom-sheet-handle"></div>
            <div class="bottom-sheet-header">
                <h3 class="bottom-sheet-title">Menu</h3>
            </div>
            <div class="bottom-sheet-menu">
                <button class="bottom-sheet-item" data-action="braindump">
                    <span class="bottom-sheet-item-icon">🧠</span>
                    <span class="bottom-sheet-item-text">Brain Dump</span>
                </button>
                <button class="bottom-sheet-item" data-action="stuck">
                    <span class="bottom-sheet-item-icon">🤔</span>
                    <span class="bottom-sheet-item-text">I'm Stuck</span>
                </button>
                <button class="bottom-sheet-item" data-action="moodpatterns">
                    <span class="bottom-sheet-item-icon">📊</span>
                    <span class="bottom-sheet-item-text">Mood Patterns</span>
                </button>
                <button class="bottom-sheet-item" data-action="settings">
                    <span class="bottom-sheet-item-icon">⚙️</span>
                    <span class="bottom-sheet-item-text">Settings</span>
                </button>
                <button class="bottom-sheet-item" data-action="templates">
                    <span class="bottom-sheet-item-icon">📋</span>
                    <span class="bottom-sheet-item-text">Task Templates</span>
                </button>
                <button class="bottom-sheet-item" data-action="appearance">
                    <span class="bottom-sheet-item-icon">🎨</span>
                    <span class="bottom-sheet-item-text">Appearance</span>
                </button>
            </div>
        </div>

        <!-- DASHBOARD TAB -->
        <div class="tab-content" id="dashboard-tab" style="display: block;">
            <!-- Configuration Warning -->
            <div id="configWarning" class="config-warning">
                <strong>⚠️ Configuration Required</strong><br>
                Please update the configuration in Settings with your Cloudflare Worker URL and Google Client ID.
                See SETUP-INSTRUCTIONS.md for details.
            </div>

            <!-- WHAT NOW Hero Section -->
            <div class="what-now-hero">
                <h2>🎯 What Should I Do Right Now?</h2>
                
                <div class="location-selector">
                    <button class="location-btn" data-location="home" onclick="setLocation('home')">🏠 Home</button>
                    <button class="location-btn" data-location="school" onclick="setLocation('school')">🏫 School</button>
                    <button class="location-btn" data-location="work" onclick="setLocation('work')">💼 Work</button>
                    <button class="location-btn" data-location="commute" onclick="setLocation('commute')">🚗 Commute</button>
                </div>

                <div class="energy-picker" style="display: flex; gap: 10px; margin: 15px 0; justify-content: center; flex-wrap: wrap;">
                    <button class="energy-btn" data-energy="low" onclick="setUserEnergy('low')">
                        🔋 Low Energy
                    </button>
                    <button class="energy-btn" data-energy="medium" onclick="setUserEnergy('medium')">
                        ⚡ Medium Energy
                    </button>
                    <button class="energy-btn" data-energy="high" onclick="setUserEnergy('high')">
                        🚀 High Energy
                    </button>
                </div>

                <div id="contextInfo" class="context-info" style="display: none;">
                    <h3 id="contextTitle">Loading...</h3>
                    <p id="contextDetails"></p>
                </div>

                <div id="suggestionCard" style="display: none;">
                    <!-- Suggestion will be inserted here -->
                </div>
                
                <!-- Done for Today Section -->
                <div class="done-for-today-section" style="margin-top: 20px;">
                    <button id="doneForTodayBtn" class="done-for-today-btn" onclick="handleDoneForToday()">
                        😴 Done for Today
                    </button>
                    <p class="done-hint" style="color: rgba(255,255,255,0.8); font-size: 0.9em; margin-top: 8px;">
                        Exhausted? Move remaining tasks to tomorrow - no guilt!
                    </p>
                </div>
            </div>

            <!-- Current Schedule Block -->
            <div class="schedule-section">
                <div class="schedule-header">
                    <h2>📅 Your Schedule Right Now</h2>
                </div>
                
                <div id="currentBlock" class="current-block" style="display: none;">
                    <h3>📍 YOU ARE HERE</h3>
                    <p id="currentBlockText"></p>
                    <p class="time-remaining" id="timeRemaining"></p>
                </div>
            </div>
        </div>

        <!-- TASKS TAB -->
        <div class="tab-content" id="tasks-tab" style="display: none;">
            <h2 style="color: var(--primary); margin-bottom: 20px;">✅ Tasks & Deadlines</h2>
            <p style="color: var(--text-light); margin-bottom: 20px;">Manage all your tasks, deadlines, and errands in one place.</p>
            
            <!-- All Tasks Section -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="margin: 0;">📋 All Tasks</h2>
                    <button class="btn btn-danger btn-sm" onclick="clearAllTasks()" title="Clear all tasks">
                        🗑️ Clear All
                    </button>
                </div>
                <div class="quick-add">
                    <input type="text" id="quickTaskInput" placeholder="Quick add a task... (press Enter)" 
                           onkeypress="if(event.key==='Enter') quickAddTask()">
                    <button class="btn btn-primary" onclick="quickAddTask()">Add</button>
                </div>
                <div id="allTasks" class="task-list">
                    <div class="empty-state">
                        <div class="empty-state-icon">📝</div>
                        <p>No tasks yet! Use Quick Add or Brain Dump to get started.</p>
                    </div>
                </div>
            </div>

            <!-- Course-Organized Deadline View -->
            <div class="card">
                <h2 style="margin-bottom: 10px;">🎓 Deadlines by Course</h2>
                <p style="color: var(--text-light); margin-bottom: 20px;">
                    Next deadline for each course - focus on what's most urgent
                </p>
                <div id="courseDeadlineView">
                    <!-- Course deadline cards will be rendered here -->
                </div>
            </div>

            <!-- All Deadlines Section -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                    <h2 style="margin: 0;">📋 All Deadlines</h2>
                </div>
                <div class="quick-add">
                    <input type="text" id="quickDeadlineInput" placeholder="Quick add a deadline... (press Enter)" 
                           onkeypress="if(event.key==='Enter') showAddDeadlineModal()">
                    <button class="btn btn-primary" onclick="showAddDeadlineModal()">Add Deadline</button>
                </div>
                <div id="allDeadlines" class="task-list">
                    <div class="empty-state">
                        <div class="empty-state-icon">📅</div>
                        <p>No deadlines yet!</p>
                    </div>
                </div>
            </div>

            <!-- Errands & Stops Section -->
            <div class="card errands-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="margin: 0;">🏪 Errands & Stops</h2>
                    <button class="btn btn-danger btn-sm" onclick="clearAllErrands()" title="Clear all errands" style="padding: 6px 12px; font-size: 0.85em;">
                        🗑️ Clear All
                    </button>
                </div>
                <p class="errands-hint" style="color: var(--text-light); margin-bottom: 15px;">
                    Things to do when you're out and about (post office, grocery store, etc.)
                </p>
                
                <div class="common-errands" style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px;">Quick add common errands:</h4>
                    <div class="errand-buttons" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <button class="btn btn-secondary" onclick="quickAddErrand('Post office')" style="width: 100%;">📮 Post office</button>
                        <button class="btn btn-secondary" onclick="quickAddErrand('Grocery store')" style="width: 100%;">🛒 Grocery</button>
                        <button class="btn btn-secondary" onclick="quickAddErrand('Gas station')" style="width: 100%;">⛽ Gas</button>
                        <button class="btn btn-secondary" onclick="quickAddErrand('Pharmacy')" style="width: 100%;">💊 Pharmacy</button>
                    </div>
                </div>
                
                <div id="errandTasks" class="task-list">
                    <div class="empty-state">
                        <div class="empty-state-icon">🏪</div>
                        <p>No errands yet!</p>
                    </div>
                </div>
                
                <div class="commute-home-indicator" style="display: none; background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 15px; border-radius: 10px; margin-top: 15px;" id="commuteHomeIndicator">
                    🚗 You're driving home - good time to make stops!
                </div>
            </div>
        </div>

        <!-- PROJECTS TAB -->
        <div class="tab-content" id="projects-tab" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <div>
                    <h2 style="color: var(--primary); margin: 0;">💻 Projects</h2>
                    <p style="color: var(--text-light); margin: 5px 0 0 0;">Track your coding and personal projects with interactive task checklists.</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="showCreateProjectModal()">
                        ➕ Create Project
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="clearAllProjects()" title="Clear all projects">
                        🗑️ Clear All
                    </button>
                </div>
            </div>
            
            <div id="projectsList" class="projects-grid">
                <!-- Projects will be rendered here by JavaScript -->
            </div>
        </div>

        <!-- SCHEDULE TAB -->
        <div class="tab-content" id="schedule-tab" style="display: none;">
            <h2 style="color: var(--primary); margin-bottom: 20px;">📅 Schedule & Planning</h2>
            <p style="color: var(--text-light); margin-bottom: 20px;">View your schedule and plan your week visually.</p>
            
            <!-- Full Schedule View -->
            <div class="schedule-section">
                <div class="schedule-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="margin: 0;">📅 Daily Schedule</h2>
                    <button class="btn btn-danger btn-sm" onclick="clearDailySchedule()" title="Clear entire schedule">
                        🗑️ Clear All
                    </button>
                </div>
                
                <div id="currentBlock" class="current-block" style="display: none;">
                    <h3>📍 YOU ARE HERE</h3>
                    <p id="currentBlockText"></p>
                    <p class="time-remaining" id="timeRemaining"></p>
                </div>

                <!-- Week Navigation -->
                <div class="week-navigation">
                    <button id="prevWeek">← Previous Week</button>
                    <span id="weekLabel">Week of Oct 6, 2025</span>
                    <button id="nextWeek">Next Week →</button>
                </div>

                <!-- Day Tabs with Dates -->
                <div class="day-tabs">
                    <!-- Tabs will be generated dynamically by JavaScript -->
                </div>

                <div id="scheduleView"></div>
            </div>
        </div>

        <!-- TEMPLATES TAB -->
        <div class="tab-content" id="templates-tab" style="display: none;">
            <h2 style="color: var(--primary); margin-bottom: 20px;">📋 Task Templates</h2>
            <p style="color: var(--text-light); margin-bottom: 20px;">Create and manage recurring task templates.</p>
            
            <!-- Templates Section -->
            <div class="card">
                <h2>📋 Weekly Task Templates</h2>
                <p style="color: var(--text-light); margin-bottom: 15px;">
                    Create all your weekly coursework with one click
                </p>
                <div id="templateCards" class="template-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <!-- Templates will be rendered here by JavaScript -->
                </div>
                
                <button class="btn btn-secondary" onclick="showCreateTemplateModal()" style="width: 100%;">
                    ➕ Create Custom Template
                </button>
            </div>
        </div>

        <!-- SETTINGS TAB -->
        <div class="tab-content" id="settings-tab" style="display: none;">
            <h2 style="color: var(--primary); margin-bottom: 20px;">⚙️ Settings & Configuration</h2>
            <p style="color: var(--text-light); margin-bottom: 20px;">Configure your API keys and preferences.</p>
            
            <!-- Initial Setup Card (add at TOP of settings-tab, before Google Drive Sync) -->
            <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                    <div style="font-size: 3em;">🚀</div>
                    <div>
                        <h2 style="margin: 0; color: white;">Initial Setup</h2>
                        <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.95em;">
                            First time here? Set up your entire workspace in 5 minutes.
                        </p>
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="startInitialSetup()" 
                        style="width: 100%; background: white; color: #667eea; font-weight: 600; padding: 12px;">
                    ✨ Start Initial Setup
                </button>
                
                <p style="margin-top: 10px; opacity: 0.9; font-size: 0.85em; text-align: center;">
                    Safe to run multiple times - won't duplicate your data
                </p>
            </div>
            
            <!-- Google Drive Authentication Section -->
            <div class="card" style="margin-bottom: 2rem;">
                <h2>☁️ Google Drive Sync</h2>
                <p style="color: #666; margin-bottom: 1rem;">
                    Sign in to sync your data across devices and back up to Google Drive.
                </p>
                
                <div id="googleSignInSettings">
                    <button id="googleSignInBtn" class="primary-button" onclick="handleGoogleSignIn()">
                        Sign in with Google
                    </button>
                </div>
                
                <div id="googleAccountInfo" style="display: none; margin-top: 1rem;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span id="userEmailDisplay" style="color: #666;">user@example.com</span>
                        <button id="googleSignOutBtn" class="secondary-button" onclick="handleGoogleSignOut()">Sign Out</button>
                    </div>
                </div>
            </div>
            
            <!-- Settings Content -->
            <div class="card">
                <h2>🔧 API Configuration</h2>
                <p style="color: #666; margin-bottom: 1.5rem;">
                    <strong>Note:</strong> The app now uses Vercel Edge Functions instead of Cloudflare Workers. API calls go through <code>/api/claude.js</code>.
                </p>
                
                <div class="form-group">
                    <label for="clientIdInput">Google OAuth Client ID</label>
                    <input type="text" id="clientIdInput" placeholder="123456789-abc.apps.googleusercontent.com">
                    <p style="color: var(--text-light); font-size: 0.9em; margin-top: 5px;">
                        Your Google OAuth Client ID for Drive sync. Required for cross-device settings sync.
                    </p>
                </div>
                
                <div class="form-group">
                    <label for="apiKeyInput">Anthropic API Key</label>
                    <input type="password" id="apiKeyInput" placeholder="sk-ant-...">
                    <p style="color: var(--text-light); font-size: 0.9em; margin-top: 5px;">
                        <strong>🔒 Encrypted:</strong> Your API key is encrypted before syncing to Google Drive using your account as the encryption key.
                    </p>
                </div>
                
                </div>
            
            <!-- Admin Panel (Owner Only) -->
            <div class="card" id="admin-panel" style="display: none;">
                <h2>🔐 Manage Access (Admin Only)</h2>
                <p style="color: var(--text-light); margin-bottom: 15px;">
                    Control who can use this app. Only authorized users can access AI features.
                </p>
                
                <div class="admin-status" style="background: rgba(102, 126, 234, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                    <span style="font-weight: 600;">👥 Authorized Users: <span id="user-count">1</span>/4</span>
                </div>
                
                <div class="allowed-users-list" id="allowed-users-list" style="background: var(--bg-main); border-radius: 8px; padding: 15px; margin-bottom: 15px; max-height: 300px; overflow-y: auto;">
                    <!-- User list populated dynamically -->
                </div>
                
                <div class="add-user-section" style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input 
                        type="email" 
                        id="new-user-email" 
                        placeholder="friend@gmail.com"
                        class="user-email-input"
                        style="flex: 1; padding: 10px; border: 1px solid var(--border); border-radius: 6px;"
                    />
                    <button onclick="addUser()" class="btn btn-primary">
                        ➕ Add User
                    </button>
                </div>
                
                <div class="admin-notes" style="background: rgba(102, 126, 234, 0.05); padding: 15px; border-radius: 8px;">
                    <p style="font-weight: 600; margin-bottom: 10px;">💡 Tips:</p>
                    <ul style="margin: 0; padding-left: 20px; color: var(--text-light);">
                        <li>Users must sign in with Google to access the app</li>
                        <li>Changes take effect immediately</li>
                        <li>You can't remove yourself (owner)</li>
                        <li>Maximum 4 users total (including you)</li>
                    </ul>
                </div>
            </div>
            
            <!-- API Info Section (Replaces API Key Input) -->
            <div class="card">
                <h2>✨ AI Features</h2>
                <p style="color: var(--text-light); margin-bottom: 15px;">
                    AI features are powered by a shared API key managed by the app owner. No setup needed!
                </p>
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 2em; margin-bottom: 10px;">🤖</div>
                    <div style="font-weight: 600; margin-bottom: 5px;">Powered by Anthropic Claude</div>
                    <div style="opacity: 0.9; font-size: 0.9em;">Ready to help organize your chaos!</div>
                </div>
                
                <div class="form-group">
                    <label for="maxWorkInput">
                        <strong>Max Daily Work Time</strong>
                        <span style="color: var(--text-light); font-size: 0.9em; display: block; margin-top: 5px;">
                            Maximum minutes of focused work per day
                        </span>
                    </label>
                    <input 
                        type="number" 
                        id="maxWorkInput" 
                        min="30" 
                        max="300" 
                        step="15"
                        placeholder="90"
                        style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px;">
                    <small style="color: var(--text-light); margin-top: 5px; display: block;">
                        Recommended: 60-120 minutes. Be realistic about what you can sustain.
                    </small>
                </div>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="forceResyncSettings()" style="width: 100%;">
                        🔄 Force Re-Sync
                    </button>
                </div>
                
                <div style="margin-top: 1rem; padding: 1rem; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #4285f4;">
                    <strong style="color: #1967d2;">🔒 Security & Privacy</strong>
                    <ul style="margin: 0.5rem 0 0 1.5rem; color: #666; font-size: 0.9em;">
                        <li>API keys are encrypted before syncing to Drive</li>
                        <li>Encryption uses your Google account as the key</li>
                        <li>Settings sync automatically when you save</li>
                        <li>Works across all your devices</li>
                    </ul>
                </div>
            </div>
            
            <!-- Preferences -->
            <div class="card">
                <h2>🎨 Preferences</h2>
                
                <div class="form-group">
                    <label>Font Style</label>
                    <button class="btn btn-secondary" onclick="toggleFont()" style="width: 100%;">
                        🔤 Toggle Dyslexia-Friendly Font
                    </button>
                    <p style="color: var(--text-light); font-size: 0.9em; margin-top: 5px;">
                        Switches between standard and OpenDyslexic font for easier reading.
                    </p>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                        <span>
                            <strong>Mood Tracker</strong>
                            <span style="color: var(--text-light); font-size: 0.9em; display: block; margin-top: 5px;">
                                Enable mood tracking features (Quick Mood button and Mood Patterns)
                            </span>
                        </span>
                        <input type="checkbox" id="moodTrackerEnabled" onchange="toggleMoodTracker()" style="width: 24px; height: 24px; cursor: pointer;">
                    </label>
                </div>
            </div>
            
            <!-- Course Mappings -->
            <div class="card">
                <h2>🎓 Course Mappings</h2>
                <p style="color: var(--text-light); margin-bottom: 15px;">
                    Map course codes to friendly names. These are used when importing from calendars and syllabi.
                </p>
                
                <div id="courseMappingsList" style="margin-bottom: 15px;">
                    <!-- Course mappings will be rendered here -->
                </div>
                
                <button class="btn btn-secondary" onclick="showAddCourseMappingModal()" style="width: 100%;">
                    ➕ Add Course Mapping
                </button>
            </div>
            
            <!-- Location Settings -->
            <div class="card" id="locationSettingsSection">
                <h2>📍 Location Settings</h2>
                <p style="color: var(--text-light); margin-bottom: 15px;">
                    Set your key locations so the app can suggest location-appropriate tasks. 
                    Location is only checked when you click the button - no constant tracking.
                </p>
                
                <div class="form-group">
                    <label for="homeLocationAddress">
                        <strong>Home Address</strong>
                    </label>
                    <input 
                        type="text" 
                        id="homeLocationAddress" 
                        placeholder="123 Main St, City, State"
                        style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px;">
                    <small style="color: var(--text-light); display: block; margin-top: 5px;">
                        Used to detect when you're home
                    </small>
                </div>
                
                <div class="form-group">
                    <label for="schoolLocationAddress">
                        <strong>School Address</strong>
                    </label>
                    <input 
                        type="text" 
                        id="schoolLocationAddress" 
                        placeholder="University of Delaware, Newark, DE"
                        style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px;">
                    <small style="color: var(--text-light); display: block; margin-top: 5px;">
                        Used to detect when you're at school
                    </small>
                </div>
                
                <div class="form-group">
                    <label for="workLocationAddress">
                        <strong>Work Address</strong>
                    </label>
                    <input 
                        type="text" 
                        id="workLocationAddress" 
                        placeholder="Your workplace address"
                        style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px;">
                    <small style="color: var(--text-light); display: block; margin-top: 5px;">
                        Used to detect when you're at work
                    </small>
                </div>
                
                <div style="background: rgba(102, 126, 234, 0.1); padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <strong>🔒 Privacy:</strong>
                    <ul style="margin: 10px 0 0 20px; color: var(--text-light); font-size: 0.9em; line-height: 1.6;">
                        <li>Location is only checked when you click the "Update Location" button</li>
                        <li>Never checked automatically</li>
                        <li>Stored locally on your device only</li>
                        <li>Never sent to any server</li>
                    </ul>
                </div>
            </div>
            
            <!-- Work Schedule Import (7shifts) -->
            <div class="card">
                <h2>💼 Work Schedule Import</h2>
                <p style="color: var(--text-light); margin-bottom: 15px;">
                    Import your work schedule automatically from 7shifts. Updates weekly.
                </p>
                
                <div class="form-group">
                    <label for="shifts7CalendarUrl">
                        <strong>7shifts Calendar URL</strong>
                        <span style="color: var(--text-light); font-size: 0.9em; display: block; margin-top: 5px;">
                            Get this from 7shifts → Settings → Calendar Feed
                        </span>
                    </label>
                    <input 
                        type="url" 
                        id="shifts7CalendarUrl" 
                        placeholder="Paste your 7shifts calendar URL here"
                        style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 10px;">
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="autoSync7Shifts" checked style="margin-right: 10px; width: 20px; height: 20px;">
                        <span>
                            <strong>Automatically sync weekly</strong>
                            <span style="color: var(--text-light); font-size: 0.9em; display: block; margin-top: 5px;">
                                Your schedule will update automatically every week
                            </span>
                        </span>
                    </label>
                </div>
                
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                    <button class="btn btn-primary" id="sync7ShiftsNow" onclick="sync7ShiftsNow()">
                        🔄 Sync Now
                    </button>
                    <small id="lastSync7Shifts" style="color: var(--text-light);">
                        Never synced
                    </small>
                </div>
                
                <div style="background: rgba(102, 126, 234, 0.1); padding: 12px; border-radius: 8px;">
                    <p style="margin: 0; font-size: 0.9em; color: var(--text-light);">
                        💡 <strong>Tip:</strong> Work shifts will appear in your schedule as "work" blocks and won't interfere with your classes or personal time.
                    </p>
                </div>
            </div>
            
            <!-- Calendar Import -->
            <div class="card">
                <h2>📅 Calendar & Syllabus Import</h2>
                <p style="color: var(--text-light); margin-bottom: 15px;">
                    Import your schedule and deadlines from Canvas, Google Calendar, or upload a syllabus PDF/DOCX.
                </p>
                
                <div class="form-group" style="margin-bottom: 20px; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 8px;">
                    <h3 style="margin-bottom: 10px;">🤖 Automated Calendar Import</h3>
                    <p style="color: var(--text-light); font-size: 0.9em; margin-bottom: 15px;">
                        Automatically check your calendar for new assignments every day at 6 AM.
                    </p>
                    
                    <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;">
                        <input type="checkbox" id="autoImportEnabled" style="margin-right: 10px;">
                        <span style="font-weight: 600;">Enable daily auto-import</span>
                    </label>
                    
                    <div id="autoImportUrlSection" style="display: none; margin-top: 15px;">
                        <label for="autoImportCalendarUrl" style="display: block; margin-bottom: 5px; font-weight: 600;">
                            Calendar Feed URL
                        </label>
                        <input type="url" 
                               id="autoImportCalendarUrl" 
                               placeholder="https://school.instructure.com/feeds/calendars/user_XXXXX.ics"
                               style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 10px;">
                        <small style="color: var(--text-light); display: block;">
                            This URL will be encrypted and stored securely in your Google Drive.
                        </small>
                        
                        <button class="btn btn-secondary" onclick="manualTriggerAutoImport()" style="margin-top: 10px;">
                            🧪 Test Auto-Import Now
                </button>
            </div>
            
            <!-- Advanced Settings -->
            <div class="card">
                <h2>⚙️ Advanced</h2>
                
                <!-- Reset All App Data (add this as FIRST item in Advanced card) -->
                <div class="form-group" style="border: 2px solid #ef4444; border-radius: 8px; padding: 15px; background: rgba(239, 68, 68, 0.05); margin-bottom: 25px;">
                    <h3 style="color: #ef4444; margin-bottom: 10px;">💣 Nuclear Reset</h3>
                    <p style="color: var(--text-light); font-size: 0.9em; margin-bottom: 15px;">
                        Delete ALL app data and start completely fresh. 
                        <strong>Your API keys and settings will be preserved.</strong>
                    </p>
                    
                    <details style="margin-bottom: 15px;">
                        <summary style="cursor: pointer; font-weight: 600; color: var(--text-light); padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: 4px;">
                            ⚠️ What will be deleted? (click to expand)
                        </summary>
                        <ul style="margin: 10px 0 0 20px; color: var(--text-light); font-size: 0.9em; line-height: 1.6;">
                            <li>All tasks and errands</li>
                            <li>All deadlines</li>
                            <li>All projects</li>
                            <li>Entire schedule</li>
                            <li>All mood tracker data</li>
                            <li>Course mappings</li>
                            <li>Task templates</li>
                        </ul>
                        <div style="margin-top: 10px; padding: 10px; background: rgba(16, 185, 129, 0.1); border-radius: 4px; border-left: 3px solid #10b981;">
                            <strong style="color: #10b981;">✅ What stays safe:</strong> API keys, Google OAuth tokens, preferences
                        </div>
                    </details>
                    
                    <button class="btn btn-danger" onclick="confirmResetAllAppData()" style="width: 100%;">
                        💣 Reset All App Data
                    </button>
                </div>
                
                <!-- Mood Tracker Data Reset -->
                <div class="form-group" style="border: 2px solid #ef4444; border-radius: 8px; padding: 15px; background: rgba(239, 68, 68, 0.05); margin-bottom: 20px;">
                    <h3 style="color: #ef4444; margin-bottom: 10px;">⚠️ Mood Tracker Data</h3>
                    <p style="color: var(--text-light); font-size: 0.9em; margin-bottom: 15px;">
                        This will permanently delete ALL mood check-ins, patterns, and tracking history. 
                        <strong>This cannot be undone.</strong>
                    </p>
                    
                    <details style="margin-bottom: 15px;">
                        <summary style="cursor: pointer; font-weight: 600; color: var(--text-light); padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: 4px;">
                            ⚠️ What will be deleted? (click to expand)
                        </summary>
                        <ul style="margin: 10px 0 0 20px; color: var(--text-light); font-size: 0.9em; line-height: 1.6;">
                            <li>All mood check-ins (morning, evening, quick checks)</li>
                            <li>Energy level logs</li>
                            <li>Sleep tracking data</li>
                            <li>Medication logs</li>
                            <li>Pattern alerts and responses</li>
                            <li>Your entire mood tracking history</li>
                        </ul>
                        <div style="margin-top: 10px; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 4px; border-left: 3px solid #ef4444;">
                            <strong style="color: #ef4444;">💡 Tip:</strong> Use "Export for Therapy" or "Backup Data" first if you want to keep a copy!
                        </div>
                    </details>
                    
                    <button class="btn btn-danger" onclick="confirmResetMoodTracker()" style="width: 100%;">
                        🗑️ Reset Mood Tracker Data
                    </button>
                </div>
                
                <div class="form-group">
                    <button class="btn btn-danger" onclick="resetAllSettings()" style="width: 100%;">
                        🗑️ Reset All Settings
                    </button>
                    <p style="color: var(--text-light); font-size: 0.9em; margin-top: 5px;">
                        Clear all API keys, credentials, and preferences. This cannot be undone.
                    </p>
                </div>
            </div>
            
            <!-- Save Settings Button (moved to bottom) -->
            <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid var(--border);">
                <button class="btn btn-primary" onclick="saveSettings()" style="width: 100%; padding: 15px; font-size: 1.1em;">
                    💾 Save Settings
                </button>
                <p style="text-align: center; color: var(--text-light); font-size: 0.9em; margin-top: 10px;">
                    Settings are automatically synced to Google Drive
                </p>
            </div>
        </div>
    </div>

    <!-- Brain Dump Modal -->
    <div id="brainDumpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🧠 Brain Dump</h2>
                <button class="close-modal" onclick="closeModal('brainDumpModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Dump everything on your mind:</label>
                <textarea id="brainDumpText" placeholder="Write essay for english&#10;Buy groceries&#10;Email professor about extension&#10;...or just type whatever is stressing you out!"></textarea>
            </div>
            <button class="btn btn-primary" onclick="processBrainDump()">✨ Organize My Chaos</button>
        </div>
    </div>

    <!-- Stuck Modal -->
    <div id="stuckModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🤔 Let's Break This Down</h2>
                <button class="close-modal" onclick="closeModal('stuckModal')">&times;</button>
            </div>
            <div id="stuckContent">
                <p>What task are you stuck on?</p>
            </div>
        </div>
    </div>

    <!-- Saving Indicator -->
    <div class="saving-indicator"></div>

    <!-- App Scripts (ORDER MATTERS!) -->
    <!-- Mood Tracker Files (modular) -->
    <script src="mood-tracker/core.js"></script>
    <script src="mood-tracker/storage.js"></script>
    <script src="mood-tracker/ui-helpers.js"></script>
    <script src="mood-tracker/quick-check.js"></script>
    <script src="mood-tracker/check-ins.js"></script>
    <script src="mood-tracker/patterns.js"></script>
    <script src="mood-tracker/visualizations.js"></script>
    
    <!-- Data and storage -->
    <script src="data.js"></script>
    <script src="setup-wizard.js"></script>
    <script src="storage.js"></script>
    
    <!-- Feature modules (NEW MODULAR FILES) -->
    <script src="tasks.js"></script>
    <script src="deadlines.js"></script>
    <script src="projects.js"></script>
    <script src="ai-features.js"></script>
    <script src="templates.js"></script>
    <script src="misc.js"></script>
    
    <!-- UI and calendar -->
    <script src="ui.js"></script>
    <script src="calendar.js"></script>
    <script src="courses.js"></script>
    <script type="module" src="temporal.js"></script>
    
    <!-- Specialized features -->
    <script src="calendar-import.js"></script>
    <script src="shifts-import.js"></script>
    <script src="location.js"></script>
    <script src="settings-sync.js"></script>
    <script src="api-queue.js"></script>
    <script src="admin.js"></script>
    
    <!-- Main app initialization (loads LAST) -->
    <script src="app.js"></script>
</body>
</html>
